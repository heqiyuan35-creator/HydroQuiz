/**
 * å¡ç‰‡è¯¦æƒ…å¼¹çª—ç»„ä»¶
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 * æ”¾å¤§æŸ¥çœ‹å¡ç‰‡è¯¦æƒ…å’Œè§£æ
 */
import { KnowledgeCard, UserCard, CardRarity } from '../common/types/CardTypes';

@Component
export struct CardDetailPopup {
  @Prop cardDef: KnowledgeCard;
  @Prop userCard: UserCard | null = null;
  // åŠ¨ç”»çŠ¶æ€
  @State cardScale: number = 0.3;
  @State cardOpacity: number = 0;
  @State bgOpacity: number = 0;
  @State showBack: boolean = false;
  @State flipAngle: number = 0;
  // è§¦æ‘¸æ‘†åŠ¨
  @State rotateX: number = 0;
  @State rotateY: number = 0;
  @State isPressed: boolean = false;
  onClose: () => void = () => {};

  aboutToAppear() {
    // å…¥åœºåŠ¨ç”»
    setTimeout(() => {
      animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
        this.bgOpacity = 1;
        this.cardScale = 1;
        this.cardOpacity = 1;
      });
    }, 50);
  }

  // å…³é—­åŠ¨ç”»
  private closeWithAnimation(): void {
    animateTo({ duration: 200, curve: Curve.EaseIn }, () => {
      this.cardScale = 0.3;
      this.cardOpacity = 0;
      this.bgOpacity = 0;
    });
    setTimeout(() => {
      this.onClose();
    }, 200);
  }

  // ç¿»è½¬å¡ç‰‡
  private flipCard(): void {
    animateTo({ duration: 300, curve: Curve.EaseInOut }, () => {
      this.flipAngle = this.showBack ? 0 : 180;
    });
    setTimeout(() => {
      this.showBack = !this.showBack;
    }, 150);
  }

  // è·å–ç¨€æœ‰åº¦é¢œè‰²
  getRarityColor(): string {
    switch (this.cardDef.rarity) {
      case CardRarity.N: return '#9E9E9E';
      case CardRarity.R: return '#2196F3';
      case CardRarity.SR: return '#9C27B0';
      case CardRarity.SSR: return '#FF9800';
      default: return '#9E9E9E';
    }
  }

  // è·å–ç¨€æœ‰åº¦åç§°
  getRarityName(): string {
    switch (this.cardDef.rarity) {
      case CardRarity.N: return 'æ™®é€š';
      case CardRarity.R: return 'ç¨€æœ‰';
      case CardRarity.SR: return 'å²è¯—';
      case CardRarity.SSR: return 'ä¼ è¯´';
      default: return 'æ™®é€š';
    }
  }

  // è·å–å¡ç‰‡å›¾æ ‡
  getCardIcon(): string {
    const subjectId: string = this.cardDef.subjectId;
    if (subjectId.includes('geotechnical')) return 'ğŸ”ï¸';
    if (subjectId.includes('concrete')) return 'ğŸ§±';
    if (subjectId.includes('metal')) return 'âš™ï¸';
    if (subjectId.includes('mechanical')) return 'ğŸ”§';
    if (subjectId.includes('survey')) return 'ğŸ“';
    return 'ğŸ“š';
  }

  // è·å–ç§‘ç›®åç§°
  getSubjectName(): string {
    const subjectId: string = this.cardDef.subjectId;
    if (subjectId.includes('geotechnical')) return 'å²©åœŸå·¥ç¨‹';
    if (subjectId.includes('concrete')) return 'æ··å‡åœŸ';
    if (subjectId.includes('metal')) return 'é‡‘å±ç»“æ„';
    if (subjectId.includes('mechanical')) return 'æœºæ¢°ç”µæ°”';
    if (subjectId.includes('survey')) return 'æµ‹é‡';
    return 'ç»¼åˆ';
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  // æ¸²æŸ“æ˜Ÿçº§
  @Builder
  StarRating() {
    if (this.userCard) {
      Row() {
        ForEach([1, 2, 3, 4, 5], (star: number) => {
          Text(star <= this.userCard!.starLevel ? 'â˜…' : 'â˜†')
            .fontSize(24)
            .fontColor(star <= this.userCard!.starLevel ? '#FFD700' : '#444444')
            .textShadow({ radius: 4, color: star <= this.userCard!.starLevel ? '#FFD700' : 'transparent' })
        })
      }
    }
  }

  build() {
    Stack() {
      // èƒŒæ™¯é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.85)')
        .opacity(this.bgOpacity)
        .onClick(() => this.closeWithAnimation())

      // å¡ç‰‡å®¹å™¨
      Column() {
        // å¤§å¡ç‰‡
        Stack() {
          // å¡ç‰‡æ­£é¢
          if (!this.showBack) {
            this.CardFront()
          } else {
            // å¡ç‰‡èƒŒé¢ï¼ˆè§£æï¼‰
            this.CardBack()
          }
        }
        .width(280)
        .height(400)
        .borderRadius(20)
        .clip(true)
        .shadow({
          radius: 30,
          color: this.getRarityColor() + '80',
          offsetX: 0,
          offsetY: 10
        })
        // 3Dæ—‹è½¬æ•ˆæœ
        .rotate({
          x: 1,
          y: 0,
          z: 0,
          angle: this.rotateX,
          centerX: '50%',
          centerY: '50%'
        })
        .rotate({
          x: 0,
          y: 1,
          z: 0,
          angle: this.rotateY + this.flipAngle,
          centerX: '50%',
          centerY: '50%'
        })
        .scale({ x: this.cardScale, y: this.cardScale })
        .opacity(this.cardOpacity)
        .gesture(
          PanGesture({ direction: PanDirection.All })
            .onActionStart(() => {
              this.isPressed = true;
            })
            .onActionUpdate((event: GestureEvent) => {
              this.rotateY = Math.max(-20, Math.min(20, event.offsetX * 0.2));
              this.rotateX = Math.max(-20, Math.min(20, -event.offsetY * 0.2));
            })
            .onActionEnd(() => {
              animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
                this.rotateX = 0;
                this.rotateY = 0;
                this.isPressed = false;
              });
            })
        )

        // æ“ä½œæŒ‰é’®
        Row() {
          // ç¿»è½¬æŒ‰é’®
          Column() {
            Text('ğŸ”„')
              .fontSize(24)
            Text(this.showBack ? 'çœ‹æ­£é¢' : 'çœ‹è§£æ')
              .fontSize(12)
              .fontColor('#FFFFFF')
              .margin({ top: 4 })
          }
          .padding(16)
          .onClick(() => this.flipCard())

          // å…³é—­æŒ‰é’®
          Column() {
            Text('âœ•')
              .fontSize(24)
              .fontColor('#FFFFFF')
            Text('å…³é—­')
              .fontSize(12)
              .fontColor('#FFFFFF')
              .margin({ top: 4 })
          }
          .padding(16)
          .onClick(() => this.closeWithAnimation())
        }
        .margin({ top: 24 })
        .opacity(this.cardOpacity)
      }
    }
    .width('100%')
    .height('100%')
  }

  // å¡ç‰‡æ­£é¢
  @Builder
  CardFront() {
    Column() {
      // é¡¶éƒ¨è£…é¥°
      Row()
        .width('100%')
        .height(6)
        .linearGradient({
          angle: 90,
          colors: [['transparent', 0], [this.getRarityColor(), 0.2], [this.getRarityColor(), 0.8], ['transparent', 1]]
        })

      // ç¨€æœ‰åº¦æ ‡ç­¾
      Row() {
        Text(this.cardDef.rarity)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .padding({ left: 12, right: 12, top: 4, bottom: 4 })
          .backgroundColor(this.getRarityColor())
          .borderRadius(12)
          .shadow({ radius: 8, color: this.getRarityColor() })

        Blank()

        Text(this.getRarityName())
          .fontSize(12)
          .fontColor(this.getRarityColor())
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12 })

      // å¡ç‰‡å›¾æ ‡
      Stack() {
        // å…‰æ™•èƒŒæ™¯
        Column()
          .width(100)
          .height(100)
          .borderRadius(50)
          .backgroundColor(this.getRarityColor())
          .opacity(0.2)
          .blur(20)

        Text(this.getCardIcon())
          .fontSize(72)
      }
      .margin({ top: 20 })

      // å¡ç‰‡åç§°
      Text(this.cardDef.name)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ top: 16 })
        .textShadow({ radius: 4, color: this.getRarityColor() })

      // æ˜Ÿçº§
      this.StarRating()

      // ç§‘ç›®æ ‡ç­¾
      Text(this.getSubjectName())
        .fontSize(12)
        .fontColor('rgba(255,255,255,0.6)')
        .padding({ left: 12, right: 12, top: 4, bottom: 4 })
        .backgroundColor('rgba(255,255,255,0.1)')
        .borderRadius(10)
        .margin({ top: 12 })

      // çŸ¥è¯†ç‚¹ç®€ä»‹
      Text(this.cardDef.backContent)
        .fontSize(13)
        .fontColor('rgba(255,255,255,0.8)')
        .lineHeight(20)
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .margin({ top: 16, left: 20, right: 20 })
        .textAlign(TextAlign.Center)

      Blank()

      // åº•éƒ¨ä¿¡æ¯
      if (this.userCard) {
        Row() {
          Text(`è·å–: ${this.userCard.obtainCount}æ¬¡`)
            .fontSize(11)
            .fontColor('rgba(255,255,255,0.4)')
          
          Blank()
          
          Text(`ç¢ç‰‡: ${this.userCard.fragments}`)
            .fontSize(11)
            .fontColor('rgba(255,255,255,0.4)')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 12 })
      }

      // åº•éƒ¨è£…é¥°
      Row()
        .width('100%')
        .height(4)
        .linearGradient({
          angle: 90,
          colors: [['transparent', 0], [this.getRarityColor(), 0.3], [this.getRarityColor(), 0.7], ['transparent', 1]]
        })
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 180,
      colors: [['#2a2a3e', 0], ['#1a1a2e', 0.5], ['#0f0f1a', 1]]
    })
    .border({
      width: 3,
      color: this.getRarityColor()
    })
    .borderRadius(20)
  }

  // å¡ç‰‡èƒŒé¢ï¼ˆè§£æï¼‰
  @Builder
  CardBack() {
    Column() {
      // é¡¶éƒ¨
      Row()
        .width('100%')
        .height(6)
        .linearGradient({
          angle: 90,
          colors: [[this.getRarityColor(), 0], ['#FFD700', 0.5], [this.getRarityColor(), 1]]
        })

      // æ ‡é¢˜
      Row() {
        Text('ğŸ“–')
          .fontSize(20)
        Text('çŸ¥è¯†è§£æ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFD700')
          .margin({ left: 8 })
      }
      .margin({ top: 16 })

      // è§£æå†…å®¹
      Scroll() {
        Column() {
          // é¢˜ç›®è§£æ
          if (this.cardDef.questionAnalysis) {
            Column() {
              Text('ğŸ’¡ è§£æ')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#4CAF50')
                .alignSelf(ItemAlign.Start)

              Text(this.cardDef.questionAnalysis)
                .fontSize(13)
                .fontColor('rgba(255,255,255,0.9)')
                .lineHeight(22)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('rgba(76,175,80,0.1)')
            .borderRadius(12)
            .margin({ top: 12 })
          }

          // è€ƒç‚¹
          if (this.cardDef.examPoint) {
            Column() {
              Text('ğŸ“Œ è€ƒç‚¹')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF9800')
                .alignSelf(ItemAlign.Start)

              Text(this.cardDef.examPoint)
                .fontSize(13)
                .fontColor('rgba(255,255,255,0.9)')
                .lineHeight(20)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('rgba(255,152,0,0.1)')
            .borderRadius(12)
            .margin({ top: 12 })
          }

          // è®°å¿†å£è¯€
          if (this.cardDef.memoryTip) {
            Column() {
              Text('ğŸ§  è®°å¿†å£è¯€')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#E040FB')
                .alignSelf(ItemAlign.Start)

              Text(this.cardDef.memoryTip)
                .fontSize(13)
                .fontColor('#E040FB')
                .lineHeight(20)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('rgba(224,64,251,0.1)')
            .borderRadius(12)
            .margin({ top: 12 })
          }

          // è·å–ä¿¡æ¯
          if (this.userCard) {
            Column() {
              Text('ğŸ“Š æ”¶é›†ä¿¡æ¯')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2196F3')
                .alignSelf(ItemAlign.Start)

              Row() {
                Text('é¦–æ¬¡è·å–:')
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.5)')
                Text(this.formatTime(this.userCard.firstObtainTime))
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.8)')
                  .margin({ left: 8 })
              }
              .margin({ top: 8 })

              Row() {
                Text('è·å–æ¬¡æ•°:')
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.5)')
                Text(`${this.userCard.obtainCount}æ¬¡`)
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.8)')
                  .margin({ left: 8 })
              }
              .margin({ top: 4 })

              Row() {
                Text('å½“å‰ç¢ç‰‡:')
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.5)')
                Text(`${this.userCard.fragments}`)
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.8)')
                  .margin({ left: 8 })
              }
              .margin({ top: 4 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('rgba(33,150,243,0.1)')
            .borderRadius(12)
            .margin({ top: 12 })
          }
        }
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .layoutWeight(1)

      // åº•éƒ¨è£…é¥°
      Row()
        .width('100%')
        .height(4)
        .linearGradient({
          angle: 90,
          colors: [[this.getRarityColor(), 0], ['#FFD700', 0.5], [this.getRarityColor(), 1]]
        })
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 180,
      colors: [['#1a2a1a', 0], ['#0f1a0f', 0.5], ['#0a0f0a', 1]]
    })
    .border({
      width: 3,
      color: '#FFD700'
    })
    .borderRadius(20)
    // èƒŒé¢éœ€è¦é•œåƒç¿»è½¬
    .rotate({
      x: 0,
      y: 1,
      z: 0,
      angle: 180
    })
  }
}
