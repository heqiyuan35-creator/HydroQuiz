/**
 * Âç°ÁâáÊéâËêΩÂºπÁ™óÁªÑ‰ª∂
 * HydroQuiz - Ê∞¥Âà©Â∑•Á®ãÊ£ÄÊµãÂëòÂà∑È¢òÂÆù
 * ÁúüÂÆûÂç°ÁâáÊéâËêΩÊïàÊûú
 */
import { DroppedCard, CardRarity } from '../common/types/CardTypes';

/**
 * Á∫øÊÄßÊ∏êÂèòÈ¢úËâ≤È°π
 */
interface GradientColorStop {
  color: string;
  offset: number;
}

/**
 * Á∫øÊÄßÊ∏êÂèòÁ±ª
 */
class LinearGradient {
  colors: GradientColorStop[];
  constructor(colors: GradientColorStop[]) {
    this.colors = colors;
  }
}

@Component
export struct CardDropPopup {
  @Prop droppedCard: DroppedCard;
  @State cardScale: number = 0;
  @State cardRotateY: number = -180;
  @State cardRotateZ: number = -30;
  @State cardOffsetY: number = -200;
  @State showBack: boolean = false;
  @State glowOpacity: number = 0;
  @State isFlipping: boolean = false;
  // Ëß¶Êë∏ÊëÜÂä®
  @State touchRotateX: number = 0;
  @State touchRotateY: number = 0;
  @State bgOpacity: number = 0;
  onClose: () => void = () => {};

  aboutToAppear() {
    // ËÉåÊôØÊ∑°ÂÖ•
    animateTo({ duration: 200 }, () => {
      this.bgOpacity = 1;
    });

    // ÂÖ•Âú∫Âä®ÁîªÔºö‰ªé‰∏äÊñπÈ£òËêΩ + ÊóãËΩ¨Â±ïÂºÄ
    setTimeout(() => {
      animateTo({
        duration: 600,
        curve: Curve.EaseOut
      }, () => {
        this.cardOffsetY = 0;
        this.cardRotateZ = 0;
        this.cardScale = 1;
      });
      
      setTimeout(() => {
        animateTo({
          duration: 500,
          curve: Curve.EaseInOut
        }, () => {
          this.cardRotateY = 0;
        });
      }, 300);
    }, 100);

    // SR/SSRÂÖâÊïà
    if (this.droppedCard.card.rarity === CardRarity.SR || 
        this.droppedCard.card.rarity === CardRarity.SSR) {
      animateTo({
        duration: 1000,
        curve: Curve.EaseInOut,
        iterations: -1,
        playMode: PlayMode.Alternate
      }, () => {
        this.glowOpacity = 0.6;
      });
    }
  }

  // Ëé∑ÂèñÁ®ÄÊúâÂ∫¶È¢úËâ≤
  getRarityColor(): string {
    switch (this.droppedCard.card.rarity) {
      case CardRarity.N: return '#9E9E9E';
      case CardRarity.R: return '#2196F3';
      case CardRarity.SR: return '#9C27B0';
      case CardRarity.SSR: return '#FF9800';
      default: return '#9E9E9E';
    }
  }

  // Ëé∑ÂèñÂç°ÁâáÂõæÊ†á
  getCardIcon(): string {
    const subjectId: string = this.droppedCard.card.subjectId;
    if (subjectId.includes('geotechnical')) return 'üèîÔ∏è';
    if (subjectId.includes('concrete')) return 'üß±';
    if (subjectId.includes('metal')) return '‚öôÔ∏è';
    if (subjectId.includes('mechanical')) return 'üîß';
    if (subjectId.includes('survey')) return 'üìê';
    return 'üìö';
  }

  // Ëé∑ÂèñÁßëÁõÆÂêçÁß∞
  getSubjectName(): string {
    const subjectId: string = this.droppedCard.card.subjectId;
    if (subjectId.includes('geotechnical')) return 'Â≤©ÂúüÂ∑•Á®ã';
    if (subjectId.includes('concrete')) return 'Ê∑∑ÂáùÂúü';
    if (subjectId.includes('metal')) return 'ÈáëÂ±ûÁªìÊûÑ';
    if (subjectId.includes('mechanical')) return 'Êú∫Ê¢∞ÁîµÊ∞î';
    if (subjectId.includes('survey')) return 'ÊµãÈáè';
    return 'ÁªºÂêà';
  }

  // ÁøªËΩ¨Âç°Áâá
  private flipCard(): void {
    if (this.isFlipping) return;
    this.isFlipping = true;
    animateTo({
      duration: 400,
      curve: Curve.EaseInOut,
      onFinish: () => {
        this.isFlipping = false;
      }
    }, () => {
      this.showBack = !this.showBack;
    });
  }

  build() {
    Stack() {
      // ËÉåÊôØÈÅÆÁΩ©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.85)')
        .opacity(this.bgOpacity)
        .onClick(() => this.onClose())

      // Âç°ÁâáÂÆπÂô®
      Column() {
        // SR/SSRÂÖâÊïà
        if (this.droppedCard.card.rarity === CardRarity.SR || 
            this.droppedCard.card.rarity === CardRarity.SSR) {
          Column()
            .width(300)
            .height(460)
            .borderRadius(20)
            .backgroundColor(this.getRarityColor())
            .opacity(this.glowOpacity)
            .blur(30)
            .position({ x: -10, y: -10 })
        }

        // Âç°Áâá‰∏ª‰Ωì
        Stack() {
          if (!this.showBack) {
            this.CardFront()
          } else {
            this.CardBack()
          }
        }
        .width(280)
        .height(440)
        .borderRadius(20)
        .clip(true)
        .shadow({
          radius: 30,
          color: this.getRarityColor() + '80',
          offsetX: 0,
          offsetY: 10
        })
        .scale({ x: this.cardScale, y: this.cardScale })
        .rotate({ 
          x: 1,
          y: 0,
          z: 0,
          angle: this.touchRotateX,
          centerX: '50%',
          centerY: '50%'
        })
        .rotate({ 
          x: 0,
          y: 1,
          z: 0,
          angle: this.cardRotateY + this.touchRotateY,
          centerX: '50%',
          centerY: '50%'
        })
        .rotate({
          x: 0,
          y: 0, 
          z: 1,
          angle: this.cardRotateZ
        })
        .translate({ y: this.cardOffsetY })
        .gesture(
          GestureGroup(GestureMode.Parallel,
            PanGesture({ direction: PanDirection.All })
              .onActionUpdate((event: GestureEvent) => {
                this.touchRotateY = Math.max(-20, Math.min(20, event.offsetX * 0.2));
                this.touchRotateX = Math.max(-20, Math.min(20, -event.offsetY * 0.2));
              })
              .onActionEnd(() => {
                animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
                  this.touchRotateX = 0;
                  this.touchRotateY = 0;
                });
              }),
            TapGesture()
              .onAction(() => {
                this.flipCard();
              })
          )
        )

        // Êìç‰ΩúÊåâÈíÆ
        Row() {
          // ÁøªËΩ¨ÊèêÁ§∫
          Column() {
            Text('üîÑ')
              .fontSize(20)
            Text(this.showBack ? 'ÁúãÊ≠£Èù¢' : 'ÁúãËß£Êûê')
              .fontSize(11)
              .fontColor('rgba(255,255,255,0.7)')
              .margin({ top: 4 })
          }
          .onClick(() => this.flipCard())
          .margin({ right: 40 })

          // Êî∂‰∏ãÊåâÈíÆ
          Button('Êî∂‰∏ãÂç°Áâá')
            .width(140)
            .height(44)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .backgroundColor('#4CAF50')
            .shadow({ radius: 8, color: '#4CAF50' })
            .onClick(() => this.onClose())
        }
        .margin({ top: 24 })
        .opacity(this.cardScale)
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
  }

  // Âç°ÁâáÊ≠£Èù¢
  @Builder
  CardFront() {
    Column() {
      // È°∂ÈÉ®Ë£ÖÈ•∞
      Row()
        .width('100%')
        .height(6)
        .linearGradient({
          angle: 90,
          colors: [['transparent', 0], [this.getRarityColor(), 0.2], [this.getRarityColor(), 0.8], ['transparent', 1]]
        })

      // È°∂ÈÉ®Ê†áËØÜ
      Row() {
        if (this.droppedCard.isNew) {
          Text('‚ú® NEW')
            .fontSize(12)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .backgroundColor('#FF5722')
            .padding({ left: 8, right: 8, top: 3, bottom: 3 })
            .borderRadius(10)
            .shadow({ radius: 4, color: '#FF5722' })
        }
        Blank()
        Text(this.droppedCard.card.rarity)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .backgroundColor(this.getRarityColor())
          .padding({ left: 10, right: 10, top: 3, bottom: 3 })
          .borderRadius(10)
          .shadow({ radius: 6, color: this.getRarityColor() })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12 })

      // Âç°ÁâáÂõæÊ†á
      Stack() {
        Column()
          .width(100)
          .height(100)
          .borderRadius(50)
          .backgroundColor(this.getRarityColor())
          .opacity(0.2)
          .blur(20)

        Text(this.getCardIcon())
          .fontSize(72)
      }
      .margin({ top: 24 })

      // Âç°ÁâáÂêçÁß∞
      Text(this.droppedCard.card.name)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ top: 16 })
        .textShadow({ radius: 4, color: this.getRarityColor() })

      // Á¢éÁâá‰ø°ÊÅØ
      if (!this.droppedCard.isNew && this.droppedCard.fragmentCount > 0) {
        Row() {
          Text('üíé')
            .fontSize(16)
          Text(`Á¢éÁâá +${this.droppedCard.fragmentCount}`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFD700')
            .margin({ left: 4 })
        }
        .margin({ top: 8 })
      }

      // ÁßëÁõÆÊ†áÁ≠æ
      Text(this.getSubjectName())
        .fontSize(12)
        .fontColor('rgba(255,255,255,0.6)')
        .padding({ left: 12, right: 12, top: 4, bottom: 4 })
        .backgroundColor('rgba(255,255,255,0.1)')
        .borderRadius(10)
        .margin({ top: 12 })

      // Áü•ËØÜÁÇπÈ¢ÑËßà
      Scroll() {
        Text(this.droppedCard.card.backContent)
          .fontSize(13)
          .fontColor('rgba(255,255,255,0.8)')
          .lineHeight(20)
          .textAlign(TextAlign.Center)
          .padding({ left: 16, right: 16 })
      }
      .layoutWeight(1)
      .margin({ top: 16 })

      // Â∫ïÈÉ®Ë£ÖÈ•∞
      Row()
        .width('100%')
        .height(4)
        .linearGradient({
          angle: 90,
          colors: [['transparent', 0], [this.getRarityColor(), 0.3], [this.getRarityColor(), 0.7], ['transparent', 1]]
        })
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 180,
      colors: [['#2a2a3e', 0], ['#1a1a2e', 0.5], ['#0f0f1a', 1]]
    })
    .border({
      width: 3,
      color: this.getRarityColor()
    })
    .borderRadius(20)
  }

  // Âç°ÁâáËÉåÈù¢ÔºàËß£ÊûêÔºâ
  @Builder
  CardBack() {
    Column() {
      Row()
        .width('100%')
        .height(6)
        .linearGradient({
          angle: 90,
          colors: [[this.getRarityColor(), 0], ['#FFD700', 0.5], [this.getRarityColor(), 1]]
        })

      Row() {
        Text('üìñ')
          .fontSize(20)
        Text('Áü•ËØÜËß£Êûê')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFD700')
          .margin({ left: 8 })
      }
      .margin({ top: 16 })

      Scroll() {
        Column() {
          if (this.droppedCard.card.questionAnalysis) {
            Column() {
              Text('üí° Ëß£Êûê')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#4CAF50')
                .alignSelf(ItemAlign.Start)

              Text(this.droppedCard.card.questionAnalysis)
                .fontSize(13)
                .fontColor('rgba(255,255,255,0.9)')
                .lineHeight(22)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('rgba(76,175,80,0.1)')
            .borderRadius(12)
            .margin({ top: 12 })
          }

          if (this.droppedCard.card.examPoint) {
            Column() {
              Text('üìå ËÄÉÁÇπ')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF9800')
                .alignSelf(ItemAlign.Start)

              Text(this.droppedCard.card.examPoint)
                .fontSize(13)
                .fontColor('rgba(255,255,255,0.9)')
                .lineHeight(20)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('rgba(255,152,0,0.1)')
            .borderRadius(12)
            .margin({ top: 12 })
          }

          if (this.droppedCard.card.memoryTip) {
            Column() {
              Text('üß† ËÆ∞ÂøÜÂè£ËØÄ')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#E040FB')
                .alignSelf(ItemAlign.Start)

              Text(this.droppedCard.card.memoryTip)
                .fontSize(13)
                .fontColor('#E040FB')
                .lineHeight(20)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('rgba(224,64,251,0.1)')
            .borderRadius(12)
            .margin({ top: 12 })
          }
        }
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .layoutWeight(1)

      Row()
        .width('100%')
        .height(4)
        .linearGradient({
          angle: 90,
          colors: [[this.getRarityColor(), 0], ['#FFD700', 0.5], [this.getRarityColor(), 1]]
        })
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 180,
      colors: [['#1a2a1a', 0], ['#0f1a0f', 0.5], ['#0a0f0a', 1]]
    })
    .border({
      width: 3,
      color: '#FFD700'
    })
    .borderRadius(20)
  }
}
