/**
 * æ–°æ‰‹å¯¼å¼•é®ç½©ç»„ä»¶
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 * ç®€åŒ–ç‰ˆï¼šå…¨å±é®ç½© + å±…ä¸­/é¡¶éƒ¨/åº•éƒ¨è¯´æ˜å¡ç‰‡
 */
import { GuideStep, CardPosition } from '../common/types/OnboardingTypes';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';

@Component
export struct OnboardingGuideOverlay {
  @Link isVisible: boolean;
  @Prop currentStep: GuideStep | null = null;
  @Prop progressText: string = '';
  @Prop isLastStep: boolean = false;
  onNext: () => void = () => {};
  onSkip: () => void = () => {};

  // åŠ¨ç”»çŠ¶æ€
  @State maskOpacity: number = 0;
  @State cardScale: number = 0.9;
  @State cardOpacity: number = 0;

  aboutToAppear(): void {
    // å»¶è¿Ÿå¯åŠ¨åŠ¨ç”»ï¼Œè®©é¡µé¢å…ˆæ¸²æŸ“
    setTimeout(() => {
      animateTo({
        duration: 400,
        curve: Curve.EaseOut
      }, () => {
        this.maskOpacity = 1;
        this.cardScale = 1;
        this.cardOpacity = 1;
      });
    }, 100);
  }

  /**
   * å¤„ç†ä¸‹ä¸€æ­¥ç‚¹å‡»
   */
  private handleNext(): void {
    // å¡ç‰‡æ·¡å‡º
    animateTo({
      duration: 200,
      curve: Curve.EaseIn
    }, () => {
      this.cardOpacity = 0;
      this.cardScale = 0.95;
    });

    setTimeout(() => {
      this.onNext();
      // å¡ç‰‡æ·¡å…¥
      setTimeout(() => {
        animateTo({
          duration: 250,
          curve: Curve.EaseOut
        }, () => {
          this.cardOpacity = 1;
          this.cardScale = 1;
        });
      }, 100);
    }, 200);
  }

  /**
   * å¤„ç†è·³è¿‡/å®Œæˆç‚¹å‡»
   */
  private handleSkip(): void {
    animateTo({
      duration: 300,
      curve: Curve.EaseIn
    }, () => {
      this.maskOpacity = 0;
      this.cardOpacity = 0;
    });
    setTimeout(() => {
      this.onSkip();
    }, 300);
  }

  /**
   * è·å–å¡ç‰‡å‚ç›´å¯¹é½æ–¹å¼
   */
  private getCardAlignment(): FlexAlign {
    if (!this.currentStep) return FlexAlign.Center;
    switch (this.currentStep.position) {
      case 'top': return FlexAlign.Start;
      case 'bottom': return FlexAlign.End;
      default: return FlexAlign.Center;
    }
  }

  /**
   * è·å–å¡ç‰‡ä¸Šè¾¹è·
   */
  private getCardMarginTop(): number {
    if (!this.currentStep) return 0;
    return this.currentStep.position === 'top' ? 120 : 0;
  }

  /**
   * è·å–å¡ç‰‡ä¸‹è¾¹è·
   */
  private getCardMarginBottom(): number {
    if (!this.currentStep) return 0;
    return this.currentStep.position === 'bottom' ? 120 : 0;
  }

  build() {
    if (this.isVisible && this.currentStep) {
      Stack() {
        // åŠé€æ˜é®ç½©èƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.75)')
          .opacity(this.maskOpacity)

        // è¯´æ˜å¡ç‰‡å®¹å™¨
        Column() {
          this.GuideCard()
        }
        .width('100%')
        .height('100%')
        .padding({ left: 20, right: 20 })
        .justifyContent(this.getCardAlignment())
      }
      .width('100%')
      .height('100%')
    }
  }

  @Builder
  GuideCard() {
    Column() {
      // æ­¥éª¤å›¾æ ‡
      if (this.currentStep?.id === 'welcome') {
        Text('ğŸ‘‹')
          .fontSize(48)
          .margin({ bottom: 16 })
      } else {
        // Tabå›¾æ ‡
        Row() {
          Text(this.getTabEmoji())
            .fontSize(32)
        }
        .width(64)
        .height(64)
        .borderRadius(32)
        .backgroundColor(ThemeColors.PRIMARY + '20')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 16 })
      }

      // æ ‡é¢˜
      Text(this.currentStep?.title || '')
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .textAlign(TextAlign.Center)

      // æè¿°
      Text(this.currentStep?.description || '')
        .fontSize(15)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .textAlign(TextAlign.Center)
        .margin({ top: 12 })
        .lineHeight(24)

      // è¿›åº¦æŒ‡ç¤ºå™¨
      Row() {
        ForEach([0, 1, 2, 3, 4], (index: number) => {
          Column()
            .width(this.isCurrentDot(index) ? 20 : 8)
            .height(8)
            .borderRadius(4)
            .backgroundColor(this.isCurrentDot(index) ? ThemeColors.PRIMARY : ThemeColors.GRAY_300)
            .margin({ left: 4, right: 4 })
        })
      }
      .margin({ top: 24 })

      // æŒ‰é’®åŒºåŸŸ
      Row() {
        // è·³è¿‡æŒ‰é’®
        if (!this.isLastStep) {
          Text('è·³è¿‡')
            .fontSize(15)
            .fontColor(ThemeColors.TEXT_HINT)
            .padding({ left: 20, right: 20, top: 12, bottom: 12 })
            .onClick(() => {
              this.handleSkip();
            })
        }

        Blank()

        // ä¸‹ä¸€æ­¥/å¼€å§‹ä½¿ç”¨æŒ‰é’®
        Row() {
          Text(this.isLastStep ? 'å¼€å§‹ä½¿ç”¨' : 'ä¸‹ä¸€æ­¥')
            .fontSize(15)
            .fontColor(ThemeColors.WHITE)
            .fontWeight(FontWeight.Medium)
        }
        .padding({ left: 32, right: 32, top: 12, bottom: 12 })
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(24)
        .onClick(() => {
          if (this.isLastStep) {
            this.handleSkip();
          } else {
            this.handleNext();
          }
        })
      }
      .width('100%')
      .margin({ top: 32 })
    }
    .width('100%')
    .padding(24)
    .margin({ top: this.getCardMarginTop(), bottom: this.getCardMarginBottom() })
    .backgroundColor(ThemeColors.WHITE)
    .borderRadius(20)
    .shadow({ radius: 24, color: 'rgba(0, 0, 0, 0.2)', offsetX: 0, offsetY: 12 })
    .scale({ x: this.cardScale, y: this.cardScale })
    .opacity(this.cardOpacity)
  }

  /**
   * è·å–Tabå¯¹åº”çš„emoji
   */
  private getTabEmoji(): string {
    if (!this.currentStep) return '';
    switch (this.currentStep.id) {
      case 'tab-home': return 'ğŸ ';
      case 'tab-bank': return 'ğŸ“š';
      case 'tab-knowledge': return 'ğŸ’¡';
      case 'tab-profile': return 'ğŸ‘¤';
      default: return 'âœ¨';
    }
  }

  /**
   * åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰è¿›åº¦ç‚¹
   */
  private isCurrentDot(index: number): boolean {
    const stepIndex = parseInt(this.progressText.split('/')[0]) - 1;
    return index === stepIndex;
  }
}
