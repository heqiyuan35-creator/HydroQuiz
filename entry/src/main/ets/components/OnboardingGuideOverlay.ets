/**
 * æ–°æ‰‹å¯¼å¼•é®ç½©ç»„ä»¶
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 * ç®€åŒ–ç‰ˆï¼šå…¨å±åŠé€æ˜é®ç½© + è¯´æ˜å¡ç‰‡ï¼ˆä¸åšç²¾ç¡®æ¡†é€‰ï¼‰
 */
import { GuideStep, GUIDE_STEPS } from '../common/types/OnboardingTypes';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';

@Component
export struct OnboardingGuideOverlay {
  @Link isVisible: boolean;
  @Prop currentStep: GuideStep | null = null;
  @Prop progressText: string = '';
  @Prop isLastStep: boolean = false;
  onNext: () => void = () => {};
  onSkip: () => void = () => {};

  // åŠ¨ç”»çŠ¶æ€
  @State maskOpacity: number = 0;
  @State cardScale: number = 0.9;
  @State cardOpacity: number = 0;

  aboutToAppear(): void {
    setTimeout(() => {
      animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
        this.maskOpacity = 1;
        this.cardScale = 1;
        this.cardOpacity = 1;
      });
    }, 50);
  }

  private handleNext(): void {
    animateTo({ duration: 150, curve: Curve.EaseIn }, () => {
      this.cardOpacity = 0;
      this.cardScale = 0.95;
    });
    setTimeout(() => {
      this.onNext();
      setTimeout(() => {
        animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
          this.cardOpacity = 1;
          this.cardScale = 1;
        });
      }, 50);
    }, 150);
  }

  private handleSkip(): void {
    animateTo({ duration: 200, curve: Curve.EaseIn }, () => {
      this.maskOpacity = 0;
      this.cardOpacity = 0;
    });
    setTimeout(() => { this.onSkip(); }, 200);
  }


  // è·å–å½“å‰æ­¥éª¤ç´¢å¼•
  private getCurrentIndex(): number {
    const parts = this.progressText.split('/');
    return parts.length > 0 ? parseInt(parts[0]) - 1 : 0;
  }

  build() {
    if (this.isVisible && this.currentStep) {
      Stack() {
        // å…¨å±åŠé€æ˜é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.75)')
          .opacity(this.maskOpacity)
          .onClick(() => {
            // ç‚¹å‡»é®ç½©ä¸åšä»»ä½•æ“ä½œï¼Œé˜²æ­¢è¯¯è§¦
          })

        // è¯´æ˜å¡ç‰‡
        Column() {
          // å›¾æ ‡
          Row() {
            Text(this.getStepEmoji())
              .fontSize(36)
          }
          .width(72)
          .height(72)
          .borderRadius(36)
          .backgroundColor(ThemeColors.PRIMARY + '15')
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 16 })

          // æ ‡é¢˜
          Text(this.currentStep.title)
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .textAlign(TextAlign.Center)

          // æè¿°
          Text(this.currentStep.description)
            .fontSize(15)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .textAlign(TextAlign.Center)
            .margin({ top: 12 })
            .lineHeight(24)

          // è¿›åº¦ç‚¹
          Row() {
            ForEach(GUIDE_STEPS, (_: GuideStep, index: number) => {
              Column()
                .width(index === this.getCurrentIndex() ? 20 : 8)
                .height(8)
                .borderRadius(4)
                .backgroundColor(index === this.getCurrentIndex() ? ThemeColors.PRIMARY : ThemeColors.GRAY_300)
                .margin({ left: 3, right: 3 })
            })
          }
          .margin({ top: 24 })

          // æŒ‰é’®åŒºåŸŸ
          Row() {
            if (!this.isLastStep) {
              Text('è·³è¿‡')
                .fontSize(15)
                .fontColor(ThemeColors.TEXT_HINT)
                .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                .onClick(() => { this.handleSkip(); })
            }

            Blank()

            Row() {
              Text(this.isLastStep ? 'å¼€å§‹ä½¿ç”¨' : 'ä¸‹ä¸€æ­¥')
                .fontSize(15)
                .fontColor(ThemeColors.WHITE)
                .fontWeight(FontWeight.Medium)
            }
            .padding({ left: 32, right: 32, top: 12, bottom: 12 })
            .backgroundColor(ThemeColors.PRIMARY)
            .borderRadius(24)
            .onClick(() => {
              if (this.isLastStep) {
                this.handleSkip();
              } else {
                this.handleNext();
              }
            })
          }
          .width('100%')
          .margin({ top: 28 })
        }
        .width('88%')
        .padding(24)
        .backgroundColor(ThemeColors.WHITE)
        .borderRadius(20)
        .shadow({ radius: 24, color: 'rgba(0, 0, 0, 0.2)', offsetY: 12 })
        .scale({ x: this.cardScale, y: this.cardScale })
        .opacity(this.cardOpacity)
      }
      .width('100%')
      .height('100%')
      .alignContent(Alignment.Center)
    }
  }

  private getStepEmoji(): string {
    switch (this.currentStep?.id) {
      case 'welcome': return 'ğŸ‘‹';
      case 'user-header': return 'ğŸ‘¤';
      case 'daily-stats': return 'ğŸ“Š';
      case 'daily-practice': return 'ğŸ“';
      case 'intensive': return 'ğŸ’ª';
      case 'tab-bank': return 'ğŸ“š';
      case 'tab-knowledge': return 'ğŸ’¡';
      case 'tab-profile': return 'âš™ï¸';
      default: return 'âœ¨';
    }
  }
}
