/**
 * ä¸»Tabé¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router, RouteParams } from '../router/Router';
import { answerRecordService, ExamRecord, TodayStatistics } from '../services/AnswerRecordService';
import { questionBankService, SubjectStats } from '../services/QuestionBankService';
import { AppConstants } from '../common/constants/AppConstants';
import { userService, UserInfo } from '../services/UserService';
import { widgetDataService } from '../services/WidgetDataService';
import { databaseService } from '../data/database/DatabaseService';
import { TipsDialog, promptAction } from '@kit.ArkUI';
import { KnowledgeService } from '../services/KnowledgeService';
import { KnowledgeArticle, KnowledgeSubject, KnowledgeCategory, ContentType } from '../common/types/KnowledgeTypes';
import { achievementNotificationService, AchievementUnlockCallback } from '../services/AchievementNotificationService';
import { Achievement } from '../services/AchievementService';
import { smartRecommendService, RecommendCard, SubjectProgress, RecommendType } from '../services/SmartRecommendService';
import { wrongStatisticsService, SubjectDistribution } from '../services/WrongStatisticsService';
import { SUBJECT_LIST } from '../data/SubjectData';
import { SubjectInfo } from '../common/types/QuestionTypes';
import { onboardingService } from '../services/OnboardingService';
import { OnboardingGuideOverlay } from '../components/OnboardingGuideOverlay';
import { GuideStep, AreaRect } from '../common/types/OnboardingTypes';
import { componentUtils } from '@kit.ArkUI';

/**
 * Tabé¡¹é…ç½®æ¥å£
 */
interface TabItem {
  title: string;
  icon: string;
  iconSelected: string;
}

// TodayStatistics ä» AnswerRecordService å¯¼å…¥

/**
 * é¢˜å‹ç­›é€‰ç±»å‹
 */
type QuestionFilterType = 'all' | 'single' | 'multiple' | 'judge';

@Entry
@Component
struct MainTabPage {
  @State currentIndex: number = 0;
  @State isDarkMode: boolean = false;
  @State todayStats: TodayStatistics = { total: 0, correct: 0, accuracy: 0, streak: 0 };
  @State wrongCount: number = 0;
  @State favoriteCount: number = 0;
  @State totalQuestionCount: number = 0;
  @State selectedFilter: QuestionFilterType = 'all';
  @State examRecords: ExamRecord[] = [];
  @State examCount: number = 0;
  @State userInfo: UserInfo = { nickname: 'æ°´åˆ©å­¦å‘˜', gender: 'male', userId: '', status: 'æ°´åˆ©æ£€æµ‹å‘˜å¤‡è€ƒä¸­' };
  @State examDate: number = Date.now() + 30 * 24 * 60 * 60 * 1000;
  @State daysUntilExam: number = 30;
  @State showDatePicker: boolean = false;
  @State selectedDate: Date = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
  @State dailyGoal: number = 20;
  @State weeklyPlanDays: number[] = [1, 2, 3, 4, 5, 6, 7];
  @State hasCheckedIn: boolean = false;
  @State showCheckInSuccess: boolean = false;
  // ä¸“é¡¹ç»ƒä¹ é€‰æ‹©å¯¹è¯æ¡†
  @State showSpecialPracticeDialog: boolean = false;
  // ç§‘ç›®åˆ—è¡¨ï¼ˆä»é¢˜åº“æœåŠ¡è·å–ï¼‰
  @State subjectList: SubjectStats[] = [];
  // æ€»ä½“è¿›åº¦ï¼ˆå·²å®Œæˆçš„ä¸é‡å¤é¢˜ç›®æ•°ï¼‰
  @State completedQuestionCount: number = 0;
  // çŸ¥è¯†åº“ç›¸å…³çŠ¶æ€
  @State selectedKnowledgeCategory: string = 'å…¨éƒ¨';
  @State knowledgeSubjects: KnowledgeSubject[] = [];
  @State allKnowledgeArticles: KnowledgeArticle[] = [];
  @State knowledgeSearchText: string = '';
  @State expandedSubjects: Set<string> = new Set<string>();
  @State expandedCategories: Set<string> = new Set<string>();
  // æˆå°±è§£é”å¼¹çª—çŠ¶æ€
  @State showAchievementDialog: boolean = false;
  @State unlockedAchievement: Achievement | null = null;
  // æ™ºèƒ½æ¨èç›¸å…³çŠ¶æ€
  @State recommendCards: RecommendCard[] = [];
  @State subjectProgressList: SubjectProgress[] = [];
  // é”™é¢˜ç§‘ç›®åˆ†å¸ƒï¼ˆç”¨äºçŸ¥è¯†åº“æ¨èï¼‰
  @State wrongSubjectDistribution: SubjectDistribution[] = [];
  // æ–°æ‰‹å¯¼å¼•ç›¸å…³çŠ¶æ€
  @State showOnboardingGuide: boolean = false;
  @State currentGuideStep: GuideStep | null = null;
  @State guideTargetRect: AreaRect | null = null;
  @State guideProgressText: string = '';
  @State guideIsLastStep: boolean = false;
  @State guideScreenWidth: number = 360;
  @State guideScreenHeight: number = 800;
  private knowledgeService: KnowledgeService = KnowledgeService.getInstance();
  private achievementCallback: AchievementUnlockCallback | null = null;

  private tabList: TabItem[] = [
    { title: 'é¦–é¡µ', icon: 'Home', iconSelected: 'HomeSelected' },
    { title: 'é¢˜åº“', icon: 'Questionbank', iconSelected: 'Questionbankselected' },
    { title: 'çŸ¥è¯†åº“', icon: 'KnowledgeBase', iconSelected: 'Knowledgebaseselected' },
    { title: 'æˆ‘çš„', icon: 'My', iconSelected: 'Myselection' }
  ];

  private tabController: TabsController = new TabsController();

  // æœªè¾¾æ ‡æç¤ºå¼¹æ¡†
  checkInTipsDialog: CustomDialogController = new CustomDialogController({
    builder: TipsDialog({
      imageRes: $r('app.media.Questionbank'),
      title: 'è¿˜å·®ä¸€ç‚¹ç‚¹~',
      content: `ä»Šæ—¥ç›®æ ‡ ${this.dailyGoal} é¢˜ï¼Œä½ å·²å®Œæˆ ${this.todayStats.total} é¢˜ï¼Œå†åš ${this.dailyGoal - this.todayStats.total} é¢˜å°±èƒ½æ‰“å¡å•¦ï¼`,
      primaryButton: {
        value: 'ç»§ç»­åŠ æ²¹',
        action: () => {
          Router.goToPractice(undefined, 'sequence');
        },
      },
      secondaryButton: {
        value: 'ç¨åå†è¯´',
        action: () => {
          // å…³é—­å¼¹æ¡†
        },
      },
    }),
  });

  aboutToAppear(): void {
    // è·å–è·¯ç”±å‚æ•°ä¸­çš„åˆå§‹Tab
    const params: RouteParams = Router.getParams();
    if (params['initialTab'] !== undefined) {
      this.currentIndex = params['initialTab'] as number;
    }

    // æ³¨å†Œæˆå°±è§£é”é€šçŸ¥ç›‘å¬
    this.achievementCallback = (achievement: Achievement) => {
      this.unlockedAchievement = achievement;
      this.showAchievementDialog = true;
    };
    achievementNotificationService.register(this.achievementCallback);

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    this.loadStatistics();

    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ–°æ‰‹å¯¼å¼•
    this.checkOnboardingGuide();
  }

  /**
   * æ£€æŸ¥å¹¶å¯åŠ¨æ–°æ‰‹å¯¼å¼•
   */
  private async checkOnboardingGuide(): Promise<void> {
    try {
      const shouldShow = await onboardingService.shouldShowGuide();
      if (shouldShow) {
        // å»¶è¿Ÿå¯åŠ¨å¯¼å¼•ï¼Œç­‰å¾…é¡µé¢æ¸²æŸ“å®Œæˆ
        setTimeout(() => {
          this.startOnboardingGuide();
        }, 500);
      }
    } catch (error) {
      console.error('checkOnboardingGuide error:', error);
    }
  }

  /**
   * å¯åŠ¨æ–°æ‰‹å¯¼å¼•
   */
  private startOnboardingGuide(): void {
    onboardingService.startGuide();
    this.updateGuideState();
    this.showOnboardingGuide = true;
  }

  /**
   * æ›´æ–°å¯¼å¼•çŠ¶æ€
   */
  private updateGuideState(): void {
    this.currentGuideStep = onboardingService.getCurrentStep();
    this.guideProgressText = onboardingService.getProgressText();
    this.guideIsLastStep = onboardingService.isLastStep();
    // å¦‚æœæ­¥éª¤éœ€è¦åˆ‡æ¢Tabï¼Œåˆ™åˆ‡æ¢
    if (this.currentGuideStep?.tabIndex !== undefined) {
      this.currentIndex = this.currentGuideStep.tabIndex;
      this.tabController.changeIndex(this.currentGuideStep.tabIndex);
    }
    // å»¶è¿Ÿè·å–ç›®æ ‡åŒºåŸŸä½ç½®ï¼ˆç­‰å¾…Tabåˆ‡æ¢å®Œæˆï¼‰
    setTimeout(() => {
      this.updateTargetRect();
    }, 100);
  }

  /**
   * æ›´æ–°ç›®æ ‡åŒºåŸŸä½ç½®
   */
  private updateTargetRect(): void {
    if (!this.currentGuideStep || !this.currentGuideStep.targetId) {
      this.guideTargetRect = null;
      return;
    }
    try {
      const info = componentUtils.getRectangleById(this.currentGuideStep.targetId);
      if (info && info.size.width > 0) {
        this.guideTargetRect = {
          x: info.windowOffset.x as number,
          y: info.windowOffset.y as number,
          width: info.size.width as number,
          height: info.size.height as number
        };
      } else {
        this.guideTargetRect = null;
      }
    } catch (e) {
      this.guideTargetRect = null;
    }
  }

  /**
   * å¤„ç†å¯¼å¼•ä¸‹ä¸€æ­¥
   */
  private handleGuideNext(): void {
    const hasNext = onboardingService.nextStep();
    if (hasNext) {
      this.updateGuideState();
    } else {
      // å¯¼å¼•å®Œæˆ
      this.showOnboardingGuide = false;
      onboardingService.completeGuide();
    }
  }

  /**
   * å¤„ç†å¯¼å¼•è·³è¿‡
   */
  private handleGuideSkip(): void {
    this.showOnboardingGuide = false;
    onboardingService.skipGuide();
  }

  aboutToDisappear(): void {
    // å–æ¶ˆæˆå°±é€šçŸ¥ç›‘å¬
    if (this.achievementCallback) {
      achievementNotificationService.unregister(this.achievementCallback);
      this.achievementCallback = null;
    }
  }

  onPageShow(): void {
    // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®
    this.loadStatistics();
  }


  /**
   * åŠ è½½ç»Ÿè®¡æ•°æ®
   */
  private async loadStatistics(): Promise<void> {
    try {
      // ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰
      const isReady = await databaseService.waitForReady(10000);
      if (!isReady) {
        // æ•°æ®åº“æœªå°±ç»ªï¼Œä½¿ç”¨é»˜è®¤å€¼
        return;
      }

      this.todayStats = await answerRecordService.getTodayStatistics();
      this.wrongCount = await answerRecordService.getWrongQuestionCount();
      this.favoriteCount = await answerRecordService.getFavoriteCount();
      this.examRecords = await answerRecordService.getExamRecords(5);
      this.examCount = await answerRecordService.getExamRecordCount();
      this.userInfo = await userService.getUserInfo();
      // åŠ è½½è€ƒè¯•æ—¥æœŸ
      this.examDate = await userService.getExamDate();
      this.daysUntilExam = userService.calculateDaysUntilExam(this.examDate);
      this.selectedDate = new Date(this.examDate);
      // åŠ è½½æ¯æ—¥ç›®æ ‡
      this.dailyGoal = await userService.getDailyGoal();
      // åŠ è½½ä»Šæ—¥æ‰“å¡çŠ¶æ€
      this.hasCheckedIn = await userService.hasCheckedInToday();
      // åŠ è½½å‘¨è®¡åˆ’
      this.weeklyPlanDays = await userService.getWeeklyPlanDays();
      // åŠ è½½ç§‘ç›®åˆ—è¡¨ï¼ˆå«é¢˜ç›®æ•°é‡ï¼‰- ä½¿ç”¨ç»Ÿä¸€çš„é¢˜åº“æœåŠ¡ï¼Œå¼ºåˆ¶åˆ·æ–°
      const stats = await questionBankService.getQuestionBankStats(true);
      this.subjectList = stats.subjects;
      this.totalQuestionCount = stats.totalCount;
      // åŠ è½½æ€»ä½“è¿›åº¦ï¼ˆå·²å®Œæˆçš„ä¸é‡å¤é¢˜ç›®æ•°ï¼‰
      this.completedQuestionCount = await answerRecordService.getCompletedQuestionCount();

      // åŠ è½½çŸ¥è¯†åº“æ•°æ®
      this.knowledgeSubjects = this.knowledgeService.getSubjects();
      this.allKnowledgeArticles = this.knowledgeService.getAllArticles();

      // åŠ è½½æ™ºèƒ½æ¨èæ•°æ®
      this.recommendCards = await smartRecommendService.getTodayRecommendCards();
      this.subjectProgressList = await smartRecommendService.getAllSubjectProgress();

      // åŠ è½½é”™é¢˜ç§‘ç›®åˆ†å¸ƒï¼ˆç”¨äºçŸ¥è¯†åº“æ¨èï¼‰
      const wrongStats = await wrongStatisticsService.getStatisticsData();
      this.wrongSubjectDistribution = wrongStats.subjectDistribution;
    } catch (error) {
      // å¿½ç•¥é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
    }
  }

  /**
   * è·å–å¤´åƒèµ„æº
   */
  private getAvatarResource(): Resource {
    return this.userInfo.gender === 'male' ? $r('app.media.Maleavatar') : $r('app.media.Femaleavatar');
  }

  /**
   * æ„å»ºTabæ é¡¹
   */
  @Builder
  TabBarBuilder(item: TabItem, index: number) {
    Column() {
      // å›¾æ ‡
      Image(this.getTabIconResource(index))
        .width(24)
        .height(24)

      // æ ‡é¢˜
      Text(item.title)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(this.currentIndex === index ? ThemeColors.PRIMARY : ThemeColors.TEXT_HINT)
        .margin({ top: ThemeConstants.SPACING_XXS })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.currentIndex = index;
      this.tabController.changeIndex(index);
    })
    .id(this.getTabGuideId(index))
  }

  /**
   * è·å–Tabå¯¼å¼•ID
   */
  private getTabGuideId(index: number): string {
    const ids = ['guide-tab-home', 'guide-tab-bank', 'guide-tab-knowledge', 'guide-tab-profile'];
    return ids[index] || '';
  }

  /**
   * è·å–Tabå›¾æ ‡èµ„æº
   */
  private getTabIconResource(index: number): Resource {
    const isSelected = this.currentIndex === index;
    if (index === 0) {
      return isSelected ? $r('app.media.HomeSelected') : $r('app.media.Home');
    } else if (index === 1) {
      return isSelected ? $r('app.media.Questionbankselected') : $r('app.media.Questionbank');
    } else if (index === 2) {
      return isSelected ? $r('app.media.Knowledgebaseselected') : $r('app.media.KnowledgeBase');
    } else {
      return isSelected ? $r('app.media.Myselection') : $r('app.media.My');
    }
  }


  build() {
    Stack() {
      Column() {
        Tabs({ barPosition: BarPosition.End, controller: this.tabController }) {
          // é¦–é¡µTab
          TabContent() {
            this.HomeContent()
          }
          .tabBar(this.TabBarBuilder(this.tabList[0], 0))

          // é¢˜åº“Tab
          TabContent() {
            this.QuestionBankContent()
          }
          .tabBar(this.TabBarBuilder(this.tabList[1], 1))

          // ç»Ÿè®¡Tab
          TabContent() {
            this.StatisticsContent()
          }
          .tabBar(this.TabBarBuilder(this.tabList[2], 2))

          // æˆ‘çš„Tab
          TabContent() {
            this.ProfileContent()
          }
          .tabBar(this.TabBarBuilder(this.tabList[3], 3))
        }
        .barHeight(56)
        .barBackgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
        .onChange((index: number) => {
          this.currentIndex = index;
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.isDarkMode ? ThemeColors.BACKGROUND_DARK : ThemeColors.BACKGROUND)
      .padding({ top: AppConstants.STATUS_BAR_HEIGHT, bottom: AppConstants.BOTTOM_NAV_HEIGHT })

      // æ—¥æœŸé€‰æ‹©å¼¹çª—
      if (this.showDatePicker) {
        this.DatePickerDialog()
      }

      // æ‰“å¡æˆåŠŸå¼¹çª—
      if (this.showCheckInSuccess) {
        this.CheckInSuccessDialog()
      }

      // æˆå°±è§£é”å¼¹çª—
      if (this.showAchievementDialog && this.unlockedAchievement) {
        this.AchievementUnlockDialog()
      }

      // ä¸“é¡¹ç»ƒä¹ é€‰æ‹©å¼¹çª—
      if (this.showSpecialPracticeDialog) {
        this.SpecialPracticeDialog()
      }

      // æ–°æ‰‹å¯¼å¼•é®ç½©
      OnboardingGuideOverlay({
        isVisible: this.showOnboardingGuide,
        currentStep: this.currentGuideStep,
        targetRect: this.guideTargetRect,
        progressText: this.guideProgressText,
        isLastStep: this.guideIsLastStep,
        screenWidth: this.guideScreenWidth,
        screenHeight: this.guideScreenHeight,
        onNext: () => { this.handleGuideNext(); },
        onSkip: () => { this.handleGuideSkip(); }
      })
    }
    .width('100%')
    .height('100%')
    .onAreaChange((oldValue: Area, newValue: Area) => {
      this.guideScreenWidth = newValue.width as number;
      this.guideScreenHeight = newValue.height as number;
    })
  }

  /**
   * ä¸“é¡¹ç»ƒä¹ é€‰æ‹©å¼¹çª—
   */
  @Builder
  SpecialPracticeDialog() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showSpecialPracticeDialog = false; })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .justifyContent(FlexAlign.End)

    // åº•éƒ¨å¼¹çª—å†…å®¹
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©ç»ƒä¹ æ¨¡å¼')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Text('âœ•')
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .onClick(() => { this.showSpecialPracticeDialog = false; })
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD,
        top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_SM })

      // é”™é¢˜æ¨¡å¼
      Row() {
        Column() {
          Image($r('app.media.WrongQuestion'))
            .width(28)
            .height(28)
            .objectFit(ImageFit.Contain)
        }
        .width(50)
        .height(50)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .backgroundColor('#FFEBE8')
        .justifyContent(FlexAlign.Center)

        Column() {
          Text('é”™é¢˜å¼ºåŒ–')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Text('æ ¹æ®é”™é¢˜æ•°æ®æ™ºèƒ½å‡ºé¢˜ï¼Œè–„å¼±ç‚¹å¤šç»ƒ')
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_HINT)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: ThemeConstants.SPACING_SM })
        .layoutWeight(1)

        Image($r('app.media.Rightarrow'))
          .width(16)
          .height(16)
          .fillColor(ThemeColors.TEXT_HINT)
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)
      .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
      .backgroundColor(ThemeColors.SURFACE)
      .borderRadius(ThemeConstants.RADIUS_MD)
      .border({ width: 1, color: ThemeColors.GRAY_200 })
      .onClick(() => {
        this.showSpecialPracticeDialog = false;
        // æ£€æŸ¥æ˜¯å¦æœ‰é”™é¢˜
        if (this.wrongCount === 0) {
          promptAction.showToast({
            message: 'ğŸ‰ å¤ªæ£’äº†ï¼ä½ æ²¡æœ‰é”™é¢˜å“¦ï¼Œç»§ç»­ä¿æŒï¼',
            duration: 2000
          });
          return;
        }
        const params: RouteParams = {};
        params['mode'] = 'weakness' as Object;
        Router.goToAnswer(params);
      })

      // ç§‘ç›®å¼ºåŒ–æ ‡é¢˜
      Row() {
        Text('ç§‘ç›®å¼ºåŒ–')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Text('ï¼ˆéšæœº50é¢˜ï¼‰')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ left: 4 })
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_XS })

      // ç§‘ç›®åˆ—è¡¨
      Scroll() {
        Column() {
          ForEach(this.subjectList, (subject: SubjectStats) => {
            Row() {
              Column() {
                Image(this.getSubjectIcon(subject.id))
                  .width(22)
                  .height(22)
                  .objectFit(ImageFit.Contain)
              }
              .width(40)
              .height(40)
              .borderRadius(ThemeConstants.RADIUS_SM)
              .backgroundColor(subject.color + '20')
              .justifyContent(FlexAlign.Center)

              Text(subject.name)
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.TEXT_PRIMARY)
                .margin({ left: ThemeConstants.SPACING_SM })
                .layoutWeight(1)

              Text(`${subject.questionCount}é¢˜`)
                .fontSize(ThemeConstants.FONT_SIZE_XS)
                .fontColor(ThemeColors.TEXT_HINT)

              Image($r('app.media.Rightarrow'))
                .width(14)
                .height(14)
                .fillColor(ThemeColors.TEXT_HINT)
                .margin({ left: ThemeConstants.SPACING_XS })
            }
            .width('100%')
            .padding({ left: ThemeConstants.SPACING_SM, right: ThemeConstants.SPACING_SM,
              top: ThemeConstants.SPACING_SM, bottom: ThemeConstants.SPACING_SM })
            .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD,
              top: ThemeConstants.SPACING_XS })
            .backgroundColor(ThemeColors.SURFACE)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .border({ width: 1, color: ThemeColors.GRAY_200 })
            .onClick(() => {
              this.showSpecialPracticeDialog = false;
              const params: RouteParams = {};
              params['mode'] = 'subject' as Object;
              params['subjectId'] = subject.id as Object;
              params['questionCount'] = 50 as Object;
              Router.goToAnswer(params);
            })
          }, (subject: SubjectStats) => subject.id)
        }
      }
      .height(200)
      .scrollBar(BarState.Off)

      // åº•éƒ¨å®‰å…¨åŒºåŸŸ
      Column()
        .height(ThemeConstants.SPACING_2XL)
    }
    .width('100%')
    .backgroundColor(ThemeColors.BACKGROUND)
    .borderRadius({ topLeft: ThemeConstants.RADIUS_XL, topRight: ThemeConstants.RADIUS_XL })
    .position({ x: 0, y: '100%' })
    .translate({ y: -420 })
  }

  /**
   * æˆå°±è§£é”å¼¹çª—
   */
  @Builder
  AchievementUnlockDialog() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showAchievementDialog = false; })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)

    // å¼¹æ¡†å†…å®¹
    Column() {
      // å…‰æ•ˆèƒŒæ™¯
      Column() {
        Text('ğŸ‰')
          .fontSize(48)
          .margin({ bottom: 8 })
        Text('æˆå°±è§£é”!')
          .fontSize(20).fontWeight(FontWeight.Bold).fontColor('#FFD700')
      }
      .width('100%')
      .padding({ top: 30, bottom: 20 })
      .linearGradient({
        angle: 180,
        colors: [['#667eea', 0], ['#764ba2', 1]]
      })
      .borderRadius({ topLeft: 20, topRight: 20 })

      // æˆå°±ä¿¡æ¯
      Column() {
        Text(this.unlockedAchievement?.icon || '')
          .fontSize(56)
          .margin({ top: 20 })
        Text(this.unlockedAchievement?.name || '')
          .fontSize(22).fontWeight(FontWeight.Bold).fontColor(ThemeColors.TEXT_PRIMARY)
          .margin({ top: 12 })
        Text(this.unlockedAchievement?.description || '')
          .fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ top: 8 })

        Button('å¤ªæ£’äº†!')
          .fontSize(16).fontColor(ThemeColors.WHITE)
          .backgroundColor(ThemeColors.PRIMARY)
          .borderRadius(24).height(48).width('80%')
          .margin({ top: 30, bottom: 24 })
          .onClick(() => { this.showAchievementDialog = false; })
      }
      .width('100%')
      .backgroundColor(ThemeColors.WHITE)
      .borderRadius({ bottomLeft: 20, bottomRight: 20 })
    }
    .width('85%')
    .position({ x: '7.5%', y: '25%' })
    .shadow({ radius: 20, color: 'rgba(0,0,0,0.3)', offsetY: 10 })
  }


  /**
   * æ—¥æœŸé€‰æ‹©å¼¹çª—
   */
  @Builder
  DatePickerDialog() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#00000066')
        .onClick(() => {
          this.showDatePicker = false;
        })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .justifyContent(FlexAlign.End)

    Column() {
      // å¼¹çª—å†…å®¹
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('å–æ¶ˆ')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .onClick(() => {
              this.showDatePicker = false;
            })

          Text('é€‰æ‹©è€ƒè¯•æ—¥æœŸ')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Text('ç¡®å®š')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.PRIMARY)
            .onClick(() => {
              this.examDate = this.selectedDate.getTime();
              this.daysUntilExam = userService.calculateDaysUntilExam(this.examDate);
              userService.saveExamDate(this.examDate);
              this.showDatePicker = false;
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_MD })

        // æ—¥æœŸé€‰æ‹©å™¨
        DatePicker({
          start: new Date(),
          end: new Date('2030-12-31'),
          selected: this.selectedDate
        })
          .width('100%')
          .height(200)
          .onChange((value: DatePickerResult) => {
            const year = value.year as number;
            const month = value.month as number;
            const day = value.day as number;
            this.selectedDate = new Date(year, month, day);
          })
      }
      .width('100%')
      .backgroundColor(ThemeColors.SURFACE)
      .borderRadius({ topLeft: 16, topRight: 16 })
      .padding({ bottom: ThemeConstants.SPACING_LG })
    }
    .width('100%')
    .position({ x: 0, y: 0 })
    .height('100%')
    .justifyContent(FlexAlign.End)
  }

  /**
   * æ‰“å¡æˆåŠŸå¼¹çª—
   */
  @Builder
  CheckInSuccessDialog() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          this.showCheckInSuccess = false;
        })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .justifyContent(FlexAlign.Center)

    // å¼¹çª—å†…å®¹
    Column() {
      // é¡¶éƒ¨è£…é¥°
      Stack() {
        Column()
          .width(100)
          .height(100)
          .borderRadius(50)
          .linearGradient({
            angle: 135,
            colors: [[ThemeColors.SUCCESS, 0], ['#73D13D', 1]]
          })

        Text('ğŸ‰')
          .fontSize(48)
      }
      .margin({ top: -50 })

      Text('æ‰“å¡æˆåŠŸï¼')
        .fontSize(ThemeConstants.FONT_SIZE_2XL)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ top: ThemeConstants.SPACING_LG })

      Text('ä»Šå¤©çš„å­¦ä¹ ä»»åŠ¡å·²å®Œæˆ')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: ThemeConstants.SPACING_SM })

      Row() {
        Text('ğŸ”¥')
          .fontSize(16)
        Text(' ç»§ç»­ä¿æŒï¼Œæ˜å¤©è§ï¼')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_HINT)
      }
      .margin({ top: ThemeConstants.SPACING_XS })

      Row() {
        Text('å¤ªæ£’äº†')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.WHITE)
      }
      .width('85%')
      .height(48)
      .margin({ top: ThemeConstants.SPACING_XL })
      .borderRadius(ThemeConstants.RADIUS_LG)
      .justifyContent(FlexAlign.Center)
      .linearGradient({
        angle: 90,
        colors: [[ThemeColors.SUCCESS, 0], ['#73D13D', 1]]
      })
      .shadow({ radius: 8, color: 'rgba(82, 196, 26, 0.4)', offsetX: 0, offsetY: 4 })
      .onClick(() => {
        this.showCheckInSuccess = false;
      })
    }
    .width('85%')
    .padding({ left: ThemeConstants.SPACING_LG, right: ThemeConstants.SPACING_LG, top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_LG })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_XL)
    .shadow({ radius: 24, color: 'rgba(0,0,0,0.15)', offsetX: 0, offsetY: 12 })
    .position({ x: '7.5%', y: '28%' })
  }


  /**
   * é¦–é¡µå†…å®¹
   */
  @Builder
  HomeContent() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨ç”¨æˆ·é—®å€™åŒº
        this.HomeHeader()

        // å­¦ä¹ è¿›åº¦ä¸æ‰“å¡ï¼ˆåˆå¹¶ï¼‰
        this.LearningAndCheckInSection()

        // æ ¸å¿ƒåŠŸèƒ½åŒº
        this.CoreFunctionSection()
      }
      .padding({ bottom: ThemeConstants.SPACING_2XL })
    }
    .scrollBar(BarState.Off)
    .width('100%')
    .height('100%')
  }

  /**
   * ä»Šæ—¥æ¨èæ¨¡å—
   */
  @Builder
  TodayRecommendSection() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Row() {
          Text('ğŸ¯')
            .fontSize(18)
          Text(' ä»Šæ—¥æ¨è')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }

        Blank()

        Text('åŸºäºä½ çš„å­¦ä¹ æ•°æ®')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })

      // æ¨èå¡ç‰‡åˆ—è¡¨
      if (this.recommendCards.length > 0) {
        Row() {
          ForEach(this.recommendCards.slice(0, 2), (card: RecommendCard, index: number) => {
            this.RecommendCardItem(card)
          }, (card: RecommendCard) => card.type)
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
        .margin({ top: ThemeConstants.SPACING_SM })
      }
    }
    .width('100%')
    .margin({ top: ThemeConstants.SPACING_MD })
  }

  /**
   * æ¨èå¡ç‰‡é¡¹
   */
  @Builder
  RecommendCardItem(card: RecommendCard) {
    Column() {
      Row() {
        Column() {
          Image(card.icon)
            .width(32)
            .height(32)
            .objectFit(ImageFit.Contain)
        }
        .width(52)
        .height(52)
        .borderRadius(ThemeConstants.RADIUS_LG)
        .backgroundColor(card.color + '15')
        .justifyContent(FlexAlign.Center)

        Blank()

        Column() {
          Text(`${card.count}`)
            .fontSize(26)
            .fontWeight(FontWeight.Bold)
            .fontColor(card.color)
          Text('é¢˜')
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_HINT)
        }
      }
      .width('100%')

      Text(card.title)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ top: ThemeConstants.SPACING_SM })

      Text(card.subtitle)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ top: 4 })
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })

      // å¼€å§‹æŒ‰é’®
      Row() {
        Text('å¼€å§‹ç»ƒä¹ ')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.WHITE)
      }
      .width('100%')
      .height(36)
      .margin({ top: ThemeConstants.SPACING_SM })
      .borderRadius(18)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(card.color)
      .onClick(() => {
        this.handleRecommendCardClick(card);
      })
    }
    .layoutWeight(1)
    .padding(ThemeConstants.SPACING_BASE)
    .margin({ left: 4, right: 4 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_LG)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)', offsetX: 0, offsetY: 2 })
  }

  /**
   * å¤„ç†æ¨èå¡ç‰‡ç‚¹å‡»
   */
  private handleRecommendCardClick(card: RecommendCard): void {
    const params: RouteParams = {};
    switch (card.type) {
      case RecommendType.WRONG_REVIEW:
        Router.goToWrongBook();
        break;
      case RecommendType.WEAK_POINT:
        if (card.subjectId) {
          Router.goToPractice(card.subjectId, 'sequence');
        } else {
          Router.goToPractice(undefined, 'sequence');
        }
        break;
      case RecommendType.NEW_LEARN:
      case RecommendType.DAILY_TASK:
      default:
        Router.goToPractice(undefined, 'sequence');
        break;
    }
  }

  /**
   * é¦–é¡µé¡¶éƒ¨é—®å€™åŒº
   */
  @Builder
  HomeHeader() {
    Row() {
      // å¤´åƒ - æ·»åŠ æ¸å˜è¾¹æ¡†æ•ˆæœ
      Stack() {
        // æ¸å˜è¾¹æ¡†èƒŒæ™¯
        Column()
          .width(52)
          .height(52)
          .borderRadius(26)
          .linearGradient({
            angle: 135,
            colors: [[ThemeColors.PRIMARY, 0], [ThemeColors.SECONDARY, 1]]
          })

        // å¤´åƒ
        Image(this.getAvatarResource())
          .width(48)
          .height(48)
          .borderRadius(24)
          .objectFit(ImageFit.Cover)
          .border({ width: 2, color: ThemeColors.WHITE })
      }

      // é—®å€™è¯­
      Column() {
        Row() {
          Text(this.getGreetingText())
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)

          Text(' ğŸ‘‹')
            .fontSize(14)
        }

        Text(`${this.userInfo.nickname}ï¼ŒåŠ æ²¹ï¼`)
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: ThemeConstants.SPACING_BASE })

      Blank()

      // è®¾ç½®å›¾æ ‡ - æ·»åŠ èƒŒæ™¯
      Column() {
        Image($r('app.media.Settings'))
          .width(22)
          .height(22)
      }
      .width(40)
      .height(40)
      .borderRadius(20)
      .backgroundColor(ThemeColors.GRAY_100)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        Router.goToSettings();
      })
    }
    .width('100%')
    .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_LG })
    .id('guide-user-header')
  }

  /**
   * è·å–é—®å€™è¯­
   */
  private getGreetingText(): string {
    const hour = new Date().getHours();
    if (hour < 6) {
      return 'å¤œæ·±äº†';
    } else if (hour < 9) {
      return 'æ—©ä¸Šå¥½';
    } else if (hour < 12) {
      return 'ä¸Šåˆå¥½';
    } else if (hour < 14) {
      return 'ä¸­åˆå¥½';
    } else if (hour < 18) {
      return 'ä¸‹åˆå¥½';
    } else if (hour < 22) {
      return 'æ™šä¸Šå¥½';
    } else {
      return 'å¤œæ·±äº†';
    }
  }


  /**
   * è€ƒè¯•å€’è®¡æ—¶å¡ç‰‡
   */
  @Builder
  ExamCountdownCard() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡
      Image($r('app.media.Wavebackground'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .borderRadius(ThemeConstants.RADIUS_LG)

      // æ¸å˜é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .borderRadius(ThemeConstants.RADIUS_LG)
        .linearGradient({
          angle: 135,
          colors: [['rgba(24, 144, 255, 0.85)', 0], ['rgba(114, 46, 209, 0.9)', 1]]
        })

      // å†…å®¹å±‚
      Column() {
        // ä¸ŠåŠéƒ¨åˆ† - å€’è®¡æ—¶
        Row() {
          Column() {
            // æ ‡ç­¾
            Row() {
              Text('ğŸ¯')
                .fontSize(14)
              Text(' æ°´åˆ©æ£€æµ‹å‘˜èµ„æ ¼è€ƒè¯•')
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.WHITE)
                .opacity(0.95)
            }
            .padding({ left: 10, right: 10, top: 5, bottom: 5 })
            .backgroundColor('rgba(255,255,255,0.15)')
            .borderRadius(ThemeConstants.RADIUS_LG)

            // å€’è®¡æ—¶æ•°å­—
            Row() {
              Text('è·è€ƒè¯•')
                .fontSize(ThemeConstants.FONT_SIZE_BASE)
                .fontColor(ThemeColors.WHITE)
                .opacity(0.9)

              Text(`${this.daysUntilExam}`)
                .fontSize(56)
                .fontWeight(FontWeight.Bold)
                .fontColor(ThemeColors.WHITE)
                .margin({ left: 12, right: 4 })
                .textShadow({ radius: 8, color: 'rgba(0,0,0,0.3)', offsetX: 0, offsetY: 2 })

              Text('å¤©')
                .fontSize(ThemeConstants.FONT_SIZE_LG)
                .fontColor(ThemeColors.WHITE)
                .opacity(0.9)
            }
            .margin({ top: ThemeConstants.SPACING_SM })
            .alignItems(VerticalAlign.Bottom)
          }
          .alignItems(HorizontalAlign.Start)

          Blank()

          // å³ä¾§è£…é¥°
          Column() {
            Image($r('app.media.Questionbank'))
              .width(48)
              .height(48)
              .opacity(0.3)
              .objectFit(ImageFit.Contain)
          }
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACING_LG, right: ThemeConstants.SPACING_LG, top: ThemeConstants.SPACING_LG })

        Blank()

        // ä¸‹åŠéƒ¨åˆ† - è€ƒè¯•æ—¥æœŸå’Œç¼–è¾‘æŒ‰é’®
        Row() {
          Row() {
            Column() {
              Text('ğŸ“…')
                .fontSize(16)
            }
            .width(28)
            .height(28)
            .borderRadius(14)
            .backgroundColor('rgba(255,255,255,0.15)')
            .justifyContent(FlexAlign.Center)

            Text(`${userService.formatExamDate(this.examDate)}`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.WHITE)
              .margin({ left: ThemeConstants.SPACING_SM })
          }

          Blank()

          Row() {
            Text('è®¾ç½®æ—¥æœŸ')
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.WHITE)
            Text(' â†’')
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.WHITE)
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('rgba(255,255,255,0.2)')
          .borderRadius(ThemeConstants.RADIUS_LG)
          .onClick(() => {
            this.showDatePicker = true;
          })
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACING_LG, right: ThemeConstants.SPACING_LG, top: 14, bottom: 14 })
        .backgroundColor('rgba(0,0,0,0.2)')
        .borderRadius({ bottomLeft: ThemeConstants.RADIUS_LG, bottomRight: ThemeConstants.RADIUS_LG })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height(190)
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_MD })
    .borderRadius(ThemeConstants.RADIUS_LG)
    .shadow({ radius: 16, color: 'rgba(24, 144, 255, 0.25)', offsetX: 0, offsetY: 8 })
  }


  /**
   * å­¦ä¹ è¿›åº¦æ¦‚è§ˆ
   */
  @Builder
  LearningAndCheckInSection() {
    Column() {
      // å°æ ‡é¢˜
      Row() {
        Text('ğŸ“Š')
          .fontSize(16)
        Text(' æˆ‘çš„æ—¥å¸¸')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_SM })

      // ä¸ŠåŠéƒ¨åˆ†ï¼šä¸‰ä¸ªç»Ÿè®¡å¡ç‰‡
      Row() {
        // æ€»æŒæ¡åº¦ - ç‚¹å‡»è¿›å…¥ä»Šæ—¥é”™é¢˜
        Column() {
          Stack() {
            // èƒŒæ™¯åœ†ç¯
            Progress({ value: this.todayStats.accuracy, total: 100, type: ProgressType.Ring })
              .width(50)
              .height(50)
              .color(ThemeColors.PRIMARY)
              .backgroundColor(ThemeColors.GRAY_200)
              .style({ strokeWidth: 5 })

            Text(`${this.todayStats.accuracy}%`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.PRIMARY)
          }

          Text('æŒæ¡åº¦')
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: ThemeConstants.SPACING_SM })
        }
        .layoutWeight(1)
        .padding({ top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_MD })
        .backgroundColor(ThemeColors.SURFACE)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .justifyContent(FlexAlign.Center)
        .border({ width: 1, color: ThemeColors.GRAY_200 })
        .onClick(() => {
          const params: RouteParams = {};
          params['filter'] = 'today' as Object;
          Router.push('pages/WrongBookPage', params);
        })

        // è¿ç»­æ‰“å¡
        Column() {
          Row() {
            Text('ğŸ”¥')
              .fontSize(20)
            Text(`${this.isTodayChecked() ? 1 : 0}`)
              .fontSize(26)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.WARNING)
              .margin({ left: 4 })
            Text('å¤©')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.WARNING)
              .margin({ left: 2, bottom: 2 })
          }
          .alignItems(VerticalAlign.Bottom)

          Text('è¿ç»­æ‰“å¡')
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: ThemeConstants.SPACING_SM })
        }
        .layoutWeight(1)
        .padding({ top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_MD })
        .margin({ left: ThemeConstants.SPACING_SM })
        .backgroundColor(ThemeColors.SURFACE)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .justifyContent(FlexAlign.Center)
        .border({ width: 1, color: ThemeColors.GRAY_200 })

        // ä»Šæ—¥åˆ·é¢˜
        Column() {
          Row() {
            Image($r('app.media.Edit'))
              .width(20)
              .height(20)
              .objectFit(ImageFit.Contain)
            Text(`${this.todayStats.total}`)
              .fontSize(26)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.SUCCESS)
              .margin({ left: 4 })
            Text('é¢˜')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.SUCCESS)
              .margin({ left: 2, bottom: 2 })
          }
          .alignItems(VerticalAlign.Bottom)

          Text('ä»Šæ—¥åˆ·é¢˜')
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: ThemeConstants.SPACING_SM })
        }
        .layoutWeight(1)
        .padding({ top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_MD })
        .margin({ left: ThemeConstants.SPACING_SM })
        .backgroundColor(ThemeColors.SURFACE)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .justifyContent(FlexAlign.Center)
        .border({ width: 1, color: ThemeColors.GRAY_200 })
        .onClick(() => {
          Router.push('pages/TodayRecordPage');
        })
      }
      .width('100%')
      .id('guide-daily-stats')

      // ä¸‹åŠéƒ¨åˆ†ï¼šæœ¬å‘¨å­¦ä¹ è®°å½•
      Column() {
        Row() {
          Row() {
            Text('ğŸ“…')
              .fontSize(14)
            Text(' æœ¬å‘¨å­¦ä¹ ')
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.TEXT_PRIMARY)
          }

          Blank()

          Text(this.getWeekDateRange())
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_HINT)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(ThemeColors.GRAY_100)
            .borderRadius(ThemeConstants.RADIUS_SM)
        }
        .width('100%')

        // å‘¨æ‰“å¡çŠ¶æ€
        Row() {
          this.WeekDayCheckItem('ä¸€', 1)
          this.WeekDayCheckItem('äºŒ', 2)
          this.WeekDayCheckItem('ä¸‰', 3)
          this.WeekDayCheckItem('å››', 4)
          this.WeekDayCheckItem('äº”', 5)
          this.WeekDayCheckItem('å…­', 6)
          this.WeekDayCheckItem('æ—¥', 7)
        }
        .width('100%')
        .margin({ top: ThemeConstants.SPACING_BASE })
        .justifyContent(FlexAlign.SpaceBetween)

        // ä»Šæ—¥æ‰“å¡æŒ‰é’®
        Row() {
          if (this.hasCheckedIn) {
            Text('âœ“')
              .fontSize(18)
              .fontColor(ThemeColors.WHITE)
              .margin({ right: 6 })
          }
          Text(this.getCheckInButtonText())
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.WHITE)
        }
        .width('100%')
        .height(46)
        .margin({ top: ThemeConstants.SPACING_MD })
        .borderRadius(ThemeConstants.RADIUS_LG)
        .justifyContent(FlexAlign.Center)
        .linearGradient(this.hasCheckedIn ? {
          angle: 90,
          colors: [[ThemeColors.SUCCESS, 0], ['#73D13D', 1]]
        } : {
          angle: 90,
          colors: [[ThemeColors.PRIMARY, 0], [ThemeColors.PRIMARY_LIGHT, 1]]
        })
        .shadow({ radius: 8, color: this.hasCheckedIn ? 'rgba(82, 196, 26, 0.3)' : 'rgba(24, 144, 255, 0.3)', offsetX: 0, offsetY: 4 })
        .onClick(() => {
          this.doCheckIn();
        })
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)
      .margin({ top: ThemeConstants.SPACING_SM })
      .backgroundColor(ThemeColors.SURFACE)
      .borderRadius(ThemeConstants.RADIUS_MD)
      .border({ width: 1, color: ThemeColors.GRAY_200 })
    }
    .width('100%')
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_MD })
  }


  /**
   * æ ¸å¿ƒåŠŸèƒ½åŒº - 2x2ç½‘æ ¼å¸ƒå±€
   */
  @Builder
  CoreFunctionSection() {
    Column() {
      // æ ‡é¢˜åŒº
      Row() {
        Row() {
          Text('ğŸš€')
            .fontSize(18)
          Text(' å¼€å§‹å­¦ä¹ ')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }

        Blank()

        Text('å…± ' + this.totalQuestionCount + ' é¢˜')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })

      // ç¬¬ä¸€è¡Œï¼šæ¯æ—¥ä¸€ç»ƒ + å¼ºåŒ–è®­ç»ƒ
      Row() {
        // æ¯æ—¥ä¸€ç»ƒ - è“è‰²æ¸å˜å¡ç‰‡
        Stack() {
          Column()
            .width('100%')
            .height('100%')
            .borderRadius(ThemeConstants.RADIUS_LG)
            .linearGradient({
              angle: 135,
              colors: [[ThemeColors.PRIMARY, 0], [ThemeColors.SECONDARY, 1]]
            })

          // è£…é¥°åœ†åœˆ
          Column()
            .width(60)
            .height(60)
            .borderRadius(30)
            .backgroundColor('rgba(255,255,255,0.1)')
            .position({ x: '65%', y: -15 })

          Column() {
            Row() {
              Text(`${this.dailyGoal}`)
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor(ThemeColors.WHITE)
              Text(' é¢˜')
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.WHITE)
                .opacity(0.9)
                .margin({ bottom: 4 })
            }
            .alignItems(VerticalAlign.Bottom)

            Blank()

            Text('æ¯æ—¥ä¸€ç»ƒ')
              .fontSize(ThemeConstants.FONT_SIZE_LG)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.WHITE)

            Text('å®Œæˆå³å¯æ‰“å¡')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.WHITE)
              .opacity(0.85)
              .margin({ top: 4 })
          }
          .width('100%')
          .height('100%')
          .padding(ThemeConstants.SPACING_MD)
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .height(120)
        .borderRadius(ThemeConstants.RADIUS_LG)
        .shadow({ radius: 12, color: 'rgba(24, 144, 255, 0.3)', offsetX: 0, offsetY: 6 })
        .onClick(() => {
          // æ¯æ—¥ä¸€ç»ƒï¼šéšæœºé¢˜ç›®ï¼Œæ•°é‡=æ¯æ—¥ç›®æ ‡
          const params: RouteParams = {};
          params['mode'] = 'daily' as Object;
          params['questionCount'] = this.dailyGoal as Object;
          Router.goToAnswer(params);
        })
        .id('guide-daily-practice')

        // å¼ºåŒ–è®­ç»ƒ - æ©™è‰²ä¸»é¢˜
        Stack() {
          Column()
            .width('100%')
            .height('100%')
            .borderRadius(ThemeConstants.RADIUS_LG)
            .linearGradient({
              angle: 135,
              colors: [['#FF9500', 0], ['#FF6B00', 1]]
            })

          Column()
            .width(50)
            .height(50)
            .borderRadius(25)
            .backgroundColor('rgba(255,255,255,0.1)')
            .position({ x: '60%', y: -10 })

          Column() {
            Row() {
              Text('100')
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor(ThemeColors.WHITE)
              Text(' é¢˜')
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.WHITE)
                .opacity(0.9)
                .margin({ bottom: 4 })
            }
            .alignItems(VerticalAlign.Bottom)

            Blank()

            Text('å¼ºåŒ–è®­ç»ƒ')
              .fontSize(ThemeConstants.FONT_SIZE_LG)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.WHITE)

            Text('ç»¼åˆéšæœºå‡ºé¢˜')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.WHITE)
              .opacity(0.85)
              .margin({ top: 4 })
          }
          .width('100%')
          .height('100%')
          .padding(ThemeConstants.SPACING_MD)
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .height(120)
        .margin({ left: ThemeConstants.SPACING_SM })
        .borderRadius(ThemeConstants.RADIUS_LG)
        .shadow({ radius: 12, color: 'rgba(255, 149, 0, 0.3)', offsetX: 0, offsetY: 6 })
        .onClick(() => {
          // å¼ºåŒ–è®­ç»ƒï¼š100é“å…¨éšæœº
          const params: RouteParams = {};
          params['mode'] = 'intensive' as Object;
          params['questionCount'] = 100 as Object;
          Router.goToAnswer(params);
        })
        .id('guide-intensive')
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
      .margin({ top: ThemeConstants.SPACING_SM })

      // ç¬¬äºŒè¡Œï¼šä¸“é¡¹ç»ƒä¹  + é«˜é¢‘é‡ç‚¹
      Row() {
        // ä¸“é¡¹ç»ƒä¹  - çº¢è‰²ä¸»é¢˜
        Stack() {
          Column()
            .width('100%')
            .height('100%')
            .borderRadius(ThemeConstants.RADIUS_LG)
            .linearGradient({
              angle: 135,
              colors: [['#FF4D4F', 0], ['#CF1322', 1]]
            })

          Column()
            .width(45)
            .height(45)
            .borderRadius(22)
            .backgroundColor('rgba(255,255,255,0.1)')
            .position({ x: '65%', y: -8 })

          Column() {
            Row() {
              Image($r('app.media.WrongQuestion'))
                .width(24)
                .height(24)
                .objectFit(ImageFit.Contain)
            }
            .width(40)
            .height(40)
            .borderRadius(ThemeConstants.RADIUS_MD)
            .backgroundColor('rgba(255,255,255,0.2)')
            .justifyContent(FlexAlign.Center)

            Blank()

            Text('ä¸“é¡¹ç»ƒä¹ ')
              .fontSize(ThemeConstants.FONT_SIZE_LG)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.WHITE)

            Text('é’ˆå¯¹è–„å¼±ç‚¹å‡ºé¢˜')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.WHITE)
              .opacity(0.85)
              .margin({ top: 4 })
          }
          .width('100%')
          .height('100%')
          .padding(ThemeConstants.SPACING_MD)
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .height(120)
        .borderRadius(ThemeConstants.RADIUS_LG)
        .shadow({ radius: 12, color: 'rgba(255, 77, 79, 0.3)', offsetX: 0, offsetY: 6 })
        .onClick(() => {
          // æ˜¾ç¤ºä¸“é¡¹ç»ƒä¹ é€‰æ‹©å¯¹è¯æ¡†
          this.showSpecialPracticeDialog = true;
        })

        // é«˜é¢‘é‡ç‚¹ - ç»¿è‰²ä¸»é¢˜
        Stack() {
          Column()
            .width('100%')
            .height('100%')
            .borderRadius(ThemeConstants.RADIUS_LG)
            .linearGradient({
              angle: 135,
              colors: [['#52C41A', 0], ['#389E0D', 1]]
            })

          Column()
            .width(50)
            .height(50)
            .borderRadius(25)
            .backgroundColor('rgba(255,255,255,0.1)')
            .position({ x: '60%', y: -10 })

          Column() {
            Row() {
              Text('50')
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor(ThemeColors.WHITE)
              Text(' é¢˜')
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.WHITE)
                .opacity(0.9)
                .margin({ bottom: 4 })
            }
            .alignItems(VerticalAlign.Bottom)

            Blank()

            Text('é«˜é¢‘é‡ç‚¹')
              .fontSize(ThemeConstants.FONT_SIZE_LG)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.WHITE)

            Text('å¿…è€ƒé¢˜ç›®ç²¾é€‰')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.WHITE)
              .opacity(0.85)
              .margin({ top: 4 })
          }
          .width('100%')
          .height('100%')
          .padding(ThemeConstants.SPACING_MD)
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .height(120)
        .margin({ left: ThemeConstants.SPACING_SM })
        .borderRadius(ThemeConstants.RADIUS_LG)
        .shadow({ radius: 12, color: 'rgba(82, 196, 26, 0.3)', offsetX: 0, offsetY: 6 })
        .onClick(() => {
          // é«˜é¢‘é‡ç‚¹ï¼šé‡è¦é¢˜ç›®éšæœº50é“
          const params: RouteParams = {};
          params['mode'] = 'important' as Object;
          params['questionCount'] = 50 as Object;
          Router.goToAnswer(params);
        })
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
      .margin({ top: ThemeConstants.SPACING_SM })

      // æ¨¡æ‹Ÿè€ƒè¯•å…¥å£ - ç´«è‰²æ¸å˜æ¨ªå¹…
      Stack() {
        // èƒŒæ™¯æ¸å˜
        Column()
          .width('100%')
          .height('100%')
          .borderRadius(ThemeConstants.RADIUS_LG)
          .linearGradient({
            angle: 135,
            colors: [['#722ED1', 0], ['#531DAB', 1]]
          })

        // è£…é¥°å…ƒç´ 
        Column()
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor('rgba(255,255,255,0.08)')
          .position({ x: '75%', y: -20 })

        Column()
          .width(40)
          .height(40)
          .borderRadius(20)
          .backgroundColor('rgba(255,255,255,0.06)')
          .position({ x: '85%', y: 50 })

        // å†…å®¹
        Row() {
          // å·¦ä¾§å›¾æ ‡å’Œæ–‡å­—
          Column() {
            Row() {
              Image($r('app.media.Exam'))
                .width(28)
                .height(28)
                .objectFit(ImageFit.Contain)
            }
            .width(48)
            .height(48)
            .borderRadius(ThemeConstants.RADIUS_MD)
            .backgroundColor('rgba(255,255,255,0.2)')
            .justifyContent(FlexAlign.Center)

            Text('æ¨¡æ‹Ÿè€ƒè¯•')
              .fontSize(ThemeConstants.FONT_SIZE_LG)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.WHITE)
              .margin({ top: ThemeConstants.SPACING_SM })

            Text('å…¨çœŸæ¨¡æ‹Ÿ Â· é™æ—¶ä½œç­” Â· æ™ºèƒ½è¯„åˆ†')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.WHITE)
              .opacity(0.85)
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)

          Blank()

          // å³ä¾§è¿›å…¥æŒ‰é’®
          Row() {
            Text('è¿›å…¥è€ƒè¯•')
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor('#722ED1')
              .fontWeight(FontWeight.Medium)
            Text(' â†’')
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor('#722ED1')
          }
          .padding({ left: 16, right: 16, top: 10, bottom: 10 })
          .backgroundColor(ThemeColors.WHITE)
          .borderRadius(20)
        }
        .width('100%')
        .height('100%')
        .padding(ThemeConstants.SPACING_MD)
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .height(110)
      .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
      .borderRadius(ThemeConstants.RADIUS_LG)
      .shadow({ radius: 12, color: 'rgba(114, 46, 209, 0.3)', offsetX: 0, offsetY: 6 })
      .onClick(() => {
        Router.push('pages/MockExamEntryPage');
      })
    }
    .width('100%')
    .margin({ top: ThemeConstants.SPACING_LG })
  }
  /**
   * è·å–æœ¬å‘¨æ—¥æœŸèŒƒå›´
   */
  private getWeekDateRange(): string {
    const now = new Date();
    const dayOfWeek = now.getDay() || 7;
    const monday = new Date(now);
    monday.setDate(now.getDate() - dayOfWeek + 1);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);

    const startMonth = monday.getMonth() + 1;
    const startDay = monday.getDate();
    const endMonth = sunday.getMonth() + 1;
    const endDay = sunday.getDate();

    return `${startMonth}æœˆ${startDay}æ—¥ - ${endMonth}æœˆ${endDay}æ—¥`;
  }

  /**
   * è·å–ä»Šå¤©æ˜¯å‘¨å‡ ï¼ˆ1-7ï¼‰
   */
  private getTodayWeekDay(): number {
    const day = new Date().getDay();
    return day === 0 ? 7 : day;
  }

  /**
   * åˆ¤æ–­æŸå¤©æ˜¯å¦åœ¨å‘¨è®¡åˆ’ä¸­
   */
  private isDayInPlan(dayIndex: number): boolean {
    return this.weeklyPlanDays.includes(dayIndex);
  }

  /**
   * åˆ¤æ–­æŸå¤©æ˜¯å¦å·²æ‰“å¡ï¼ˆæ‰‹åŠ¨æ‰“å¡ï¼‰
   */
  private isDayChecked(dayIndex: number): boolean {
    if (!this.isDayInPlan(dayIndex)) {
      return false;
    }
    return dayIndex === this.getTodayWeekDay() && this.hasCheckedIn;
  }

  /**
   * åˆ¤æ–­ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡ï¼ˆæ‰‹åŠ¨æ‰“å¡ï¼‰
   */
  private isTodayChecked(): boolean {
    return this.hasCheckedIn;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦å¯ä»¥æ‰“å¡ï¼ˆä»Šæ—¥åˆ·é¢˜æ•° >= æ¯æ—¥ç›®æ ‡ï¼‰
   */
  private canCheckIn(): boolean {
    return this.todayStats.total >= this.dailyGoal;
  }

  /**
   * è·å–æ‰“å¡æŒ‰é’®æ–‡å­—
   */
  private getCheckInButtonText(): string {
    if (this.hasCheckedIn) {
      return ' ä»Šæ—¥å·²æ‰“å¡';
    } else {
      return 'ç‚¹å‡»æ‰“å¡';
    }
  }

  /**
   * æ‰§è¡Œæ‰‹åŠ¨æ‰“å¡
   */
  private async doCheckIn(): Promise<void> {
    if (this.hasCheckedIn) return;

    if (!this.canCheckIn()) {
      this.checkInTipsDialog.open();
      return;
    }

    const success = await userService.checkInToday();
    if (success) {
      this.hasCheckedIn = true;
      this.showCheckInSuccess = true;
      widgetDataService.updateCheckInStatus(true, 1);
    }
  }

  /**
   * è·å–å‘¨æ‰“å¡é¡¹çš„èƒŒæ™¯è‰²
   */
  private getWeekDayBgColor(dayIndex: number): ResourceColor {
    if (this.isDayChecked(dayIndex)) {
      return ThemeColors.PRIMARY;
    }
    if (!this.isDayInPlan(dayIndex)) {
      return ThemeColors.GRAY_100;
    }
    return ThemeColors.GRAY_200;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©
   */
  private isToday(dayIndex: number): boolean {
    return dayIndex === this.getTodayWeekDay();
  }

  /**
   * å‘¨æ‰“å¡é¡¹
   */
  @Builder
  WeekDayCheckItem(label: string, dayIndex: number) {
    Column() {
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(this.isToday(dayIndex) ? ThemeColors.PRIMARY : ThemeColors.TEXT_HINT)
        .fontWeight(this.isToday(dayIndex) ? FontWeight.Bold : FontWeight.Normal)

      Stack() {
        Column()
          .width(36)
          .height(36)
          .borderRadius(18)
          .backgroundColor(this.getWeekDayBgColor(dayIndex))
          .border({
            width: this.isToday(dayIndex) ? 2 : 0,
            color: ThemeColors.PRIMARY
          })

        if (this.isDayChecked(dayIndex)) {
          Text('âœ“')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.WHITE)
        } else if (!this.isDayInPlan(dayIndex)) {
          Text('ä¼‘')
            .fontSize(10)
            .fontColor(ThemeColors.TEXT_HINT)
        } else if (this.isToday(dayIndex)) {
          Text('ä»Š')
            .fontSize(11)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.PRIMARY)
        }
      }
      .margin({ top: ThemeConstants.SPACING_SM })
    }
  }

  /**
   * è®¡ç®—æ€»ä½“è¿›åº¦ç™¾åˆ†æ¯”
   */
  private getOverallProgress(): number {
    if (this.totalQuestionCount === 0) return 0;
    return Math.round((this.completedQuestionCount / this.totalQuestionCount) * 100);
  }

  /**
   * è·å–è¿›åº¦é¼“åŠ±è¯­
   */
  private getProgressEncouragement(): string {
    const progress = this.getOverallProgress();
    if (progress >= 80) {
      return 'å¤ªæ£’äº†ï¼ä½ å·²ç»æŒæ¡äº†å¤§éƒ¨åˆ†å†…å®¹ï¼Œç»§ç»­ä¿æŒï¼';
    } else if (progress >= 60) {
      return 'è¿›åº¦ä¸é”™ï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼Œå·²è¶…è¿‡ 60% çš„è€ƒç”Ÿ';
    } else if (progress >= 40) {
      return 'åŠ æ²¹ï¼ä½ å·²ç»å®Œæˆäº†è¿‘ä¸€åŠçš„å­¦ä¹ ä»»åŠ¡';
    } else if (progress >= 20) {
      return 'è‰¯å¥½çš„å¼€å§‹æ˜¯æˆåŠŸçš„ä¸€åŠï¼Œç»§ç»­åŠªåŠ›ï¼';
    } else {
      return 'å¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…å§ï¼Œæ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ï¼';
    }
  }

  /**
   * è·å–æœ€é«˜æ¨¡æ‹Ÿè€ƒè¯•åˆ†æ•°
   */
  private getHighestExamScore(): string {
    if (this.examRecords.length === 0) {
      return '--';
    }
    let highest = 0;
    this.examRecords.forEach((record: ExamRecord) => {
      if (record.score > highest) {
        highest = record.score;
      }
    });
    return highest > 0 ? `${Math.round(highest)}` : '--';
  }


  /**
   * é¢˜åº“å†…å®¹
   */
  @Builder
  QuestionBankContent() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('é¢˜åº“åˆ†ç±»')
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Row() {
          Image($r('app.media.Questionbank'))
            .width(14)
            .height(14)
            .objectFit(ImageFit.Contain)
          Text(`${this.totalQuestionCount} é¢˜`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ left: 4 })
        }
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .backgroundColor(ThemeColors.PRIMARY + '15')
        .borderRadius(12)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD,
        top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_SM })

      Scroll() {
        Column() {
          // æ€»ä½“è¿›åº¦å¡ç‰‡
          this.QuestionBankProgressCard()

          // æ‰€æœ‰åˆ†ç±»æ ‡é¢˜
          Row() {
            Text('ç§‘ç›®è¿›åº¦')
              .fontSize(ThemeConstants.FONT_SIZE_MD)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.TEXT_PRIMARY)

            Blank()

            Text(`${this.subjectList.length} ä¸ªç§‘ç›®`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_HINT)
          }
          .width('100%')
          .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD,
            top: ThemeConstants.SPACING_LG, bottom: ThemeConstants.SPACING_XS })

          // ç§‘ç›®åˆ—è¡¨ï¼ˆå¸¦è¿›åº¦å¯è§†åŒ–ï¼‰
          Column() {
            ForEach(this.subjectProgressList, (progress: SubjectProgress) => {
              this.QuestionBankItemWithProgress(progress)
            }, (progress: SubjectProgress) => progress.subjectId)
          }
          .padding({ bottom: ThemeConstants.SPACING_2XL })
        }
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * é¢˜åº“æ€»ä½“è¿›åº¦å¡ç‰‡
   */
  @Builder
  QuestionBankProgressCard() {
    Column() {
      Row() {
        Column() {
          Text('å­¦ä¹ è¿›åº¦')
            .fontSize(ThemeConstants.FONT_SIZE_LG)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Row() {
            Text(`å·²å®Œæˆ `)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_SECONDARY)
            Text(`${this.completedQuestionCount}`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.PRIMARY)
            Text(` / ${this.totalQuestionCount} é¢˜`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_SECONDARY)
          }
          .margin({ top: ThemeConstants.SPACING_XS })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Stack() {
          Progress({ value: this.getOverallProgress(), total: 100, type: ProgressType.Ring })
            .width(70)
            .height(70)
            .color(ThemeColors.PRIMARY)
            .backgroundColor(ThemeColors.GRAY_200)
            .style({ strokeWidth: 6 })

          Text(`${this.getOverallProgress()}%`)
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY)
        }
      }
      .width('100%')

      Text(this.getProgressEncouragement())
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ top: ThemeConstants.SPACING_SM })
        .width('100%')
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_LG)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
  }

  /**
   * å¸¦è¿›åº¦å¯è§†åŒ–çš„é¢˜åº“é¡¹
   */
  @Builder
  QuestionBankItemWithProgress(progress: SubjectProgress) {
    Column() {
      Row() {
        // å·¦ä¾§å›¾æ ‡
        Column() {
          Image(this.getSubjectIcon(progress.subjectId))
            .width(24)
            .height(24)
            .objectFit(ImageFit.Contain)
        }
        .width(48)
        .height(48)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .backgroundColor(progress.color + '20')
        .justifyContent(FlexAlign.Center)

        // ä¸­é—´ä¿¡æ¯
        Column() {
          Row() {
            Text(progress.subjectName)
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            // æŒæ¡ç¨‹åº¦æ ‡ç­¾
            Text(progress.masteryLevel)
              .fontSize(10)
              .fontColor(ThemeColors.WHITE)
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor(progress.masteryColor)
              .borderRadius(10)
          }
          .width('100%')

          // è¿›åº¦æ¡
          Row() {
            Progress({ value: progress.progress, total: 100, type: ProgressType.Linear })
              .width('100%')
              .height(6)
              .color(progress.color)
              .backgroundColor(ThemeColors.GRAY_200)
              .borderRadius(3)
          }
          .width('100%')
          .margin({ top: 8 })

          // ç»Ÿè®¡ä¿¡æ¯
          Row() {
            Text(`${progress.completedCount}/${progress.totalCount} é¢˜`)
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.TEXT_HINT)

            Blank()

            Text(`æ­£ç¡®ç‡ ${progress.accuracy}%`)
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(progress.accuracy >= 70 ? ThemeColors.SUCCESS : ThemeColors.WARNING)
          }
          .width('100%')
          .margin({ top: 4 })
        }
        .layoutWeight(1)
        .margin({ left: ThemeConstants.SPACING_SM })
        .alignItems(HorizontalAlign.Start)

        // å³ä¾§ç®­å¤´
        Image($r('app.media.Rightarrow'))
          .width(16)
          .height(16)
          .fillColor(ThemeColors.TEXT_HINT)
          .margin({ left: ThemeConstants.SPACING_SM })
      }
      .width('100%')
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
    .onClick(() => {
      // ç›´æ¥è¿›å…¥ç­”é¢˜é¡µé¢ï¼Œé»˜è®¤é¡ºåºç»ƒä¹ æ¨¡å¼
      const params: RouteParams = {};
      params['subjectId'] = progress.subjectId as Object;
      params['mode'] = 'sequence' as Object;
      Router.goToAnswer(params);
    })
  }

  /**
   * åŠ¨æ€é¢˜åº“é¡¹ï¼ˆä¿ç•™å…¼å®¹ï¼‰
   */
  @Builder
  QuestionBankItemDynamic(subject: SubjectStats) {
    Row() {
      Column() {
        Image(this.getSubjectIcon(subject.id))
          .width(24)
          .height(24)
          .objectFit(ImageFit.Contain)
      }
      .width(48)
      .height(48)
      .borderRadius(ThemeConstants.RADIUS_MD)
      .backgroundColor(subject.color + '20')
      .justifyContent(FlexAlign.Center)

      Column() {
        Text(subject.name)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row() {
          Text(`${subject.questionCount} é¢˜`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_HINT)
        }
        .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: ThemeConstants.SPACING_SM })

      Image($r('app.media.Rightarrow'))
        .width(16)
        .height(16)
        .fillColor(ThemeColors.TEXT_HINT)
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
    .onClick(() => {
      // ç›´æ¥è¿›å…¥ç­”é¢˜é¡µé¢ï¼Œé»˜è®¤é¡ºåºç»ƒä¹ æ¨¡å¼
      const params: RouteParams = {};
      params['subjectId'] = subject.id as Object;
      params['mode'] = 'sequence' as Object;
      Router.goToAnswer(params);
    })
  }


  /**
   * çŸ¥è¯†åº“å†…å®¹ï¼ˆç»Ÿè®¡Tabï¼‰
   */
  @Builder
  StatisticsContent() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('çŸ¥è¯†åº“')
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Row() {
          Image($r('app.media.KnowledgeBase'))
            .width(14)
            .height(14)
            .objectFit(ImageFit.Contain)
          Text(`${this.allKnowledgeArticles.length} ç¯‡`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ left: 4 })
        }
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .backgroundColor(ThemeColors.PRIMARY + '15')
        .borderRadius(12)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD,
        top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_SM })

      // æœç´¢æ¡†
      Row() {
        Image($r('app.media.Search'))
          .width(18)
          .height(18)
          .margin({ left: 12 })
          .objectFit(ImageFit.Contain)

        TextInput({ placeholder: 'æœç´¢çŸ¥è¯†ç‚¹...', text: this.knowledgeSearchText })
          .placeholderColor(ThemeColors.TEXT_HINT)
          .placeholderFont({ size: 14 })
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .backgroundColor(Color.Transparent)
          .layoutWeight(1)
          .height(40)
          .onChange((value: string) => {
            this.knowledgeSearchText = value;
          })
      }
      .width('100%')
      .height(44)
      .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
      .backgroundColor(ThemeColors.GRAY_100)
      .borderRadius(22)

      // çŸ¥è¯†åº“å†…å®¹
      if (this.knowledgeSearchText.trim()) {
        // æœç´¢æ¨¡å¼ï¼šæ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨
        this.KnowledgeSearchResults()
      } else {
        // æ ‘å½¢ç›®å½•æ¨¡å¼ï¼ˆåŒ…å«æ¨èåŒºåŸŸï¼‰
        this.KnowledgeTreeView()
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * è·å–æ¨èå­¦ä¹ çš„ç§‘ç›®åˆ—è¡¨ï¼ˆæ ¹æ®é”™é¢˜æ•°é‡æ’åºï¼Œå–å‰3ä¸ªï¼‰
   */
  private getRecommendedSubjects(): SubjectInfo[] {
    if (this.wrongSubjectDistribution.length === 0) {
      return [];
    }

    // æŒ‰é”™é¢˜æ•°é‡æ’åºï¼Œè¿‡æ»¤æ‰é”™é¢˜ä¸º0çš„
    const sorted = this.wrongSubjectDistribution
      .filter((d: SubjectDistribution) => d.count > 0)
      .sort((a: SubjectDistribution, b: SubjectDistribution) => b.count - a.count)
      .slice(0, 3);

    // è½¬æ¢ä¸ºç§‘ç›®ä¿¡æ¯
    const result: SubjectInfo[] = [];
    for (const dist of sorted) {
      const subject = SUBJECT_LIST.find((s: SubjectInfo) => s.id === dist.subjectId);
      if (subject) {
        result.push(subject);
      }
    }
    return result;
  }

  /**
   * è·å–ç§‘ç›®çš„é”™é¢˜æ•°é‡
   */
  private getSubjectWrongCount(subjectId: string): number {
    const dist = this.wrongSubjectDistribution.find((d: SubjectDistribution) => d.subjectId === subjectId);
    return dist ? dist.count : 0;
  }

  /**
   * è·å–é”™é¢˜æ€»æ•°
   */
  private getTotalWrongCount(): number {
    let total = 0;
    for (const dist of this.wrongSubjectDistribution) {
      total += dist.count;
    }
    return total;
  }

  /**
   * çŸ¥è¯†åº“æ™ºèƒ½æ¨èåŒºåŸŸ
   */
  @Builder
  KnowledgeRecommendSection() {
    Column() {
      // è·å–æ¨èç§‘ç›®åˆ—è¡¨
      if (this.getRecommendedSubjects().length > 0) {
        Column() {
          Row() {
            Text('ğŸ’¡')
              .fontSize(13)
            Text(' è–„å¼±çŸ¥è¯†ç‚¹')
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.TEXT_PRIMARY)
            
            Blank()
            
            Text(`${this.getTotalWrongCount()} é“é”™é¢˜`)
              .fontSize(11)
              .fontColor(ThemeColors.TEXT_HINT)
          }
          .width('100%')
          .margin({ bottom: 8 })

          // æ¨ªå‘æ’åˆ—çš„æ¨èç§‘ç›®
          Row({ space: 8 }) {
            ForEach(this.getRecommendedSubjects(), (subject: SubjectInfo, index: number) => {
              Row() {
                // æ’åå°åœ†ç‚¹
                Text(`${index + 1}`)
                  .fontSize(9)
                  .fontColor(ThemeColors.WHITE)
                  .fontWeight(FontWeight.Bold)
                  .textAlign(TextAlign.Center)
                  .width(14)
                  .height(14)
                  .borderRadius(7)
                  .backgroundColor(index === 0 ? '#FF4D4F' : (index === 1 ? '#FF7A45' : '#FAAD14'))

                // ç§‘ç›®åç§°ï¼ˆç®€çŸ­ï¼‰
                Text(subject.shortName)
                  .fontSize(12)
                  .fontColor(ThemeColors.TEXT_PRIMARY)
                  .margin({ left: 6 })

                // é”™é¢˜æ•°
                Text(`${this.getSubjectWrongCount(subject.id)}`)
                  .fontSize(11)
                  .fontColor(ThemeColors.ERROR)
                  .margin({ left: 4 })
              }
              .padding({ left: 8, right: 10, top: 6, bottom: 6 })
              .backgroundColor(ThemeColors.SURFACE)
              .borderRadius(16)
              .border({ width: 1, color: ThemeColors.GRAY_200 })
              .onClick(() => {
                if (!this.expandedSubjects.has(subject.id)) {
                  this.toggleSubjectExpand(subject.id);
                }
              })
            }, (subject: SubjectInfo) => subject.id)
          }
          .width('100%')
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
        .margin({ top: ThemeConstants.SPACING_SM, bottom: ThemeConstants.SPACING_XS })
      }
    }
  }

  /**
   * çŸ¥è¯†åº“æ ‘å½¢ç›®å½•è§†å›¾
   */
  @Builder
  KnowledgeTreeView() {
    Scroll() {
      Column() {
        // æ™ºèƒ½æ¨èåŒºåŸŸ
        this.KnowledgeRecommendSection()

        // ç§‘ç›®æ ‘å½¢åˆ—è¡¨
        ForEach(this.knowledgeSubjects, (subject: KnowledgeSubject) => {
          this.KnowledgeSubjectTree(subject)
        }, (subject: KnowledgeSubject) => subject.id)
      }
      .padding({ bottom: ThemeConstants.SPACING_2XL })
    }
    .scrollBar(BarState.Off)
    .layoutWeight(1)
    .margin({ top: ThemeConstants.SPACING_SM })
  }

  /**
   * ç§‘ç›®æ ‘å½¢èŠ‚ç‚¹
   */
  @Builder
  KnowledgeSubjectTree(subject: KnowledgeSubject) {
    Column() {
      // ç§‘ç›®æ ‡é¢˜è¡Œï¼ˆå¯å±•å¼€/æŠ˜å ï¼‰
      Row() {
        // å±•å¼€/æŠ˜å å›¾æ ‡
        Image($r('app.media.right'))
          .width(12)
          .height(12)
          .objectFit(ImageFit.Contain)
          .rotate({ angle: this.isSubjectExpanded(subject.id) ? 90 : 0 })
          .margin({ right: 8 })

        // ç§‘ç›®å›¾æ ‡ï¼ˆä½¿ç”¨å¯¹åº”ç§‘ç›®å›¾ç‰‡èµ„æºï¼‰
        Column() {
          Image(this.getSubjectIcon(subject.id))
            .width(22)
            .height(22)
            .objectFit(ImageFit.Contain)
        }
        .width(36)
        .height(36)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .backgroundColor(subject.color + '20')
        .justifyContent(FlexAlign.Center)

        // ç§‘ç›®ä¿¡æ¯
        Column() {
          Text(subject.name)
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Text(`${subject.articleCount} ç¯‡çŸ¥è¯†ç‚¹`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_HINT)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: ThemeConstants.SPACING_SM })
        .layoutWeight(1)

        // è¿›åº¦æŒ‡ç¤º - åªæœ‰è¿›åº¦å¤§äº0æ—¶æ‰æ˜¾ç¤º
        if (this.getSubjectReadProgress(subject.id) > 0) {
          Text(`${this.getSubjectReadProgress(subject.id)}%`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.WHITE)
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor(subject.color)
            .borderRadius(10)
        }
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_BASE)
      .backgroundColor(ThemeColors.SURFACE)
      .borderRadius(ThemeConstants.RADIUS_MD)
      .border({ width: 1, color: ThemeColors.GRAY_200 })
      .onClick(() => {
        this.toggleSubjectExpand(subject.id);
      })

      // å±•å¼€çš„åˆ†ç±»åˆ—è¡¨
      if (this.isSubjectExpanded(subject.id)) {
        Column() {
          ForEach(subject.categories.filter((c: KnowledgeCategory) => c.articleCount > 0), (category: KnowledgeCategory) => {
            this.KnowledgeCategoryTree(subject, category)
          }, (category: KnowledgeCategory) => category.id)
        }
        .width('100%')
        .padding({ left: 20 })
        .margin({ top: 4 })
      }
    }
    .width('100%')
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
  }

  /**
   * åˆ†ç±»æ ‘å½¢èŠ‚ç‚¹
   */
  @Builder
  KnowledgeCategoryTree(subject: KnowledgeSubject, category: KnowledgeCategory) {
    Column() {
      // åˆ†ç±»æ ‡é¢˜è¡Œ
      Row() {
        // å±•å¼€/æŠ˜å å›¾æ ‡
        Image($r('app.media.right'))
          .width(10)
          .height(10)
          .objectFit(ImageFit.Contain)
          .rotate({ angle: this.isCategoryExpanded(category.id) ? 90 : 0 })
          .margin({ right: 6 })

        // åˆ†ç±»å›¾æ ‡ï¼ˆä½¿ç”¨å›¾ç‰‡èµ„æºï¼‰
        Image($r('app.media.KnowledgeBase'))
          .width(16)
          .height(16)
          .objectFit(ImageFit.Contain)

        // åˆ†ç±»åç§°
        Text(category.name)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .margin({ left: 6 })
          .layoutWeight(1)

        // æ–‡ç« æ•°é‡
        Text(`${category.articleCount}`)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
      }
      .width('100%')
      .padding({ left: 8, right: 12, top: 10, bottom: 10 })
      .backgroundColor(ThemeColors.GRAY_100)
      .borderRadius(ThemeConstants.RADIUS_SM)
      .onClick(() => {
        this.toggleCategoryExpand(category.id);
      })

      // å±•å¼€çš„æ–‡ç« åˆ—è¡¨
      if (this.isCategoryExpanded(category.id)) {
        Column() {
          ForEach(this.getArticlesByCategory(category.id), (article: KnowledgeArticle) => {
            this.KnowledgeArticleTreeItem(article, subject.color)
          }, (article: KnowledgeArticle) => article.id)
        }
        .width('100%')
        .padding({ left: 16 })
        .margin({ top: 4 })
      }
    }
    .width('100%')
    .margin({ top: 4 })
  }

  /**
   * æ–‡ç« æ ‘å½¢é¡¹
   */
  @Builder
  KnowledgeArticleTreeItem(article: KnowledgeArticle, color: string) {
    Row() {
      // è¿æ¥çº¿æŒ‡ç¤º
      Column()
        .width(3)
        .height(20)
        .backgroundColor(color + '40')
        .borderRadius(2)

      // æ–‡ç« æ ‡é¢˜
      Text(article.title)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .margin({ left: 10 })
        .layoutWeight(1)

      // é˜…è¯»çŠ¶æ€
      if (article.viewCount > 0) {
        Text('âœ“')
          .fontSize(14)
          .fontColor(ThemeColors.SUCCESS)
      }
    }
    .width('100%')
    .padding({ left: 12, right: 16, top: 14, bottom: 14 })
    .onClick(() => {
      const params: RouteParams = {};
      params['articleId'] = article.id;
      Router.push('pages/KnowledgeDetailPage', params);
    })
  }

  /**
   * çŸ¥è¯†åº“æœç´¢ç»“æœ
   */
  @Builder
  KnowledgeSearchResults() {
    Scroll() {
      Column() {
        ForEach(this.getFilteredKnowledgeArticles(), (article: KnowledgeArticle) => {
          this.KnowledgeArticleItem(article)
        }, (article: KnowledgeArticle) => article.id)

        if (this.getFilteredKnowledgeArticles().length === 0) {
          Column() {
            Image($r('app.media.Search'))
              .width(48)
              .height(48)
              .margin({ top: 60 })
              .objectFit(ImageFit.Contain)
            Text('æœªæ‰¾åˆ°ç›¸å…³çŸ¥è¯†ç‚¹')
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .fontColor(ThemeColors.TEXT_HINT)
              .margin({ top: ThemeConstants.SPACING_MD })
          }
          .width('100%')
        }
      }
      .padding({ bottom: ThemeConstants.SPACING_2XL })
    }
    .scrollBar(BarState.Off)
    .layoutWeight(1)
    .margin({ top: ThemeConstants.SPACING_SM })
  }

  /**
   * åˆ¤æ–­ç§‘ç›®æ˜¯å¦å±•å¼€
   */
  private isSubjectExpanded(subjectId: string): boolean {
    return this.expandedSubjects.has(subjectId);
  }

  /**
   * åˆ‡æ¢ç§‘ç›®å±•å¼€çŠ¶æ€
   */
  private toggleSubjectExpand(subjectId: string): void {
    const newSet = new Set<string>(this.expandedSubjects);
    if (newSet.has(subjectId)) {
      newSet.delete(subjectId);
    } else {
      newSet.add(subjectId);
    }
    this.expandedSubjects = newSet;
  }

  /**
   * åˆ¤æ–­åˆ†ç±»æ˜¯å¦å±•å¼€
   */
  private isCategoryExpanded(categoryId: string): boolean {
    return this.expandedCategories.has(categoryId);
  }

  /**
   * åˆ‡æ¢åˆ†ç±»å±•å¼€çŠ¶æ€
   */
  private toggleCategoryExpand(categoryId: string): void {
    const newSet = new Set<string>(this.expandedCategories);
    if (newSet.has(categoryId)) {
      newSet.delete(categoryId);
    } else {
      newSet.add(categoryId);
    }
    this.expandedCategories = newSet;
  }

  /**
   * è·å–åˆ†ç±»ä¸‹çš„æ–‡ç« 
   */
  private getArticlesByCategory(categoryId: string): KnowledgeArticle[] {
    return this.allKnowledgeArticles.filter((a: KnowledgeArticle) => a.categoryId === categoryId);
  }

  /**
   * è·å–ç§‘ç›®é˜…è¯»è¿›åº¦
   */
  private getSubjectReadProgress(subjectId: string): number {
    const subjectArticles = this.allKnowledgeArticles.filter((a: KnowledgeArticle) => a.subjectId === subjectId);
    if (subjectArticles.length === 0) return 0;
    const readCount = subjectArticles.filter((a: KnowledgeArticle) => a.viewCount > 0).length;
    return Math.round((readCount / subjectArticles.length) * 100);
  }

  /**
   * è·å–è¿‡æ»¤åçš„çŸ¥è¯†æ–‡ç« 
   */
  private getFilteredKnowledgeArticles(): KnowledgeArticle[] {
    let articles = this.allKnowledgeArticles;

    // æŒ‰åˆ†ç±»è¿‡æ»¤
    if (this.selectedKnowledgeCategory !== 'å…¨éƒ¨') {
      const subject = this.knowledgeSubjects.find(s => s.name === this.selectedKnowledgeCategory);
      if (subject) {
        articles = articles.filter(a => a.subjectId === subject.id);
      }
    }

    // æŒ‰æœç´¢å…³é”®è¯è¿‡æ»¤
    if (this.knowledgeSearchText.trim()) {
      const keyword = this.knowledgeSearchText.trim().toLowerCase();
      articles = articles.filter(a =>
        a.title.toLowerCase().includes(keyword) ||
        a.summary.toLowerCase().includes(keyword)
      );
    }

    return articles;
  }

  /**
   * çŸ¥è¯†åˆ†ç±»æ ‡ç­¾
   */
  @Builder
  KnowledgeCategoryTag(name: string, isSelected: boolean) {
    Text(name)
      .fontSize(ThemeConstants.FONT_SIZE_SM)
      .fontColor(isSelected ? ThemeColors.WHITE : ThemeColors.TEXT_SECONDARY)
      .padding({ left: 14, right: 14, top: 8, bottom: 8 })
      .backgroundColor(isSelected ? ThemeColors.PRIMARY : ThemeColors.GRAY_100)
      .borderRadius(16)
      .onClick(() => {
        this.selectedKnowledgeCategory = name;
      })
  }

  /**
   * çŸ¥è¯†æ–‡ç« é¡¹
   */
  @Builder
  KnowledgeArticleItem(article: KnowledgeArticle) {
    Column() {
      Row() {
        Column() {
          Text(article.title)
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(article.summary)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_HINT)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 6 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')

      Row() {
        Text(this.getSubjectName(article.subjectId))
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.PRIMARY)
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .backgroundColor(ThemeColors.PRIMARY + '15')
          .borderRadius(4)

        Text(this.getContentTypeName(article.contentType))
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ left: 8 })

        Blank()

        Text(`${article.viewCount} é˜…è¯»`)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
      }
      .width('100%')
      .margin({ top: 10 })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
    .onClick(() => {
      const params: RouteParams = {};
      params['articleId'] = article.id;
      Router.push('pages/KnowledgeDetailPage', params);
    })
  }

  /**
   * è·å–ç§‘ç›®åç§°
   */
  private getSubjectName(subjectId: string): string {
    const subject = this.knowledgeSubjects.find(s => s.id === subjectId);
    return subject ? subject.name : 'æœªåˆ†ç±»';
  }

  /**
   * è·å–å†…å®¹ç±»å‹åç§°
   */
  private getContentTypeName(type: ContentType): string {
    switch (type) {
      case ContentType.TEXT: return 'å›¾æ–‡';
      case ContentType.VIDEO: return 'è§†é¢‘';
      case ContentType.PDF: return 'æ–‡æ¡£';
      case ContentType.IMAGE: return 'å›¾ç‰‡';
      default: return 'å…¶ä»–';
    }
  }

  /**
   * è·å–ç§‘ç›®å¯¹åº”çš„å›¾æ ‡èµ„æº
   */
  private getSubjectIcon(subjectId: string): Resource {
    switch (subjectId) {
      case AppConstants.SUBJECT_BASIC: return $r('app.media.Basicknowledge');
      case AppConstants.SUBJECT_CONCRETE: return $r('app.media.Concrete');
      case AppConstants.SUBJECT_GEOTECHNICAL_ROCK: return $r('app.media.Rock');
      case AppConstants.SUBJECT_GEOTECHNICAL_FOUNDATION: return $r('app.media.Foundation');
      case AppConstants.SUBJECT_MEASUREMENT: return $r('app.media.Measurement');
      case AppConstants.SUBJECT_METAL: return $r('app.media.Metal');
      case AppConstants.SUBJECT_MECHANICAL: return $r('app.media.Machine');
      default: return $r('app.media.Questionbank');
    }
  }


  /**
   * æˆ‘çš„é¡µé¢å†…å®¹
   */
  @Builder
  ProfileContent() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Column() {
          Image($r('app.media.Settings'))
            .width(22)
            .height(22)
        }
        .width(40)
        .height(40)
        .borderRadius(20)
        .backgroundColor(ThemeColors.GRAY_100)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          Router.goToSettings();
        })
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD,
        top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_SM })

      Scroll() {
        Column() {
          // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          this.ProfileUserCard()

          // è€ƒè¯•å€’è®¡æ—¶å¡ç‰‡
          this.ExamCountdownCard()

          // å­¦ä¹ æ•°æ®ç»Ÿè®¡è¡Œ
          this.ProfileStatsRow()

          // å¸¸ç”¨åŠŸèƒ½ 2x2 ç½‘æ ¼
          this.ProfileCommonFunctions()

          // æ›´å¤šæœåŠ¡
          this.ProfileMoreServices()
        }
        .padding({ bottom: ThemeConstants.SPACING_2XL })
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
   */
  @Builder
  ProfileUserCard() {
    Row() {
      // å¤´åƒ
      Stack() {
        Column()
          .width(68)
          .height(68)
          .borderRadius(34)
          .linearGradient({
            angle: 135,
            colors: [[ThemeColors.PRIMARY, 0], [ThemeColors.SECONDARY, 1]]
          })

        Image(this.getAvatarResource())
          .width(64)
          .height(64)
          .borderRadius(32)
          .objectFit(ImageFit.Cover)
          .border({ width: 2, color: ThemeColors.WHITE })
      }

      Column() {
        Text(this.userInfo.nickname)
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text(`ID: ${this.userInfo.userId || 'æœªè®¾ç½®'}`)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ top: 4 })

        Row() {
          Text(this.userInfo.status)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.PRIMARY)
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor(ThemeColors.PRIMARY + '15')
            .borderRadius(10)
        }
        .margin({ top: 6 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: ThemeConstants.SPACING_MD })
      .layoutWeight(1)

      // ç¼–è¾‘æŒ‰é’®
      Row() {
        Text('ç¼–è¾‘')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.PRIMARY)
        Image($r('app.media.Rightarrow'))
          .width(12)
          .height(12)
          .fillColor(ThemeColors.PRIMARY)
          .margin({ left: 2 })
      }
      .padding({ left: 10, right: 10, top: 6, bottom: 6 })
      .backgroundColor(ThemeColors.PRIMARY + '10')
      .borderRadius(14)
      .onClick(() => {
        Router.push('pages/ProfileEditPage');
      })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_LG)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
  }

  /**
   * å­¦ä¹ æ•°æ®ç»Ÿè®¡è¡Œ
   */
  @Builder
  ProfileStatsRow() {
    Row() {
      // å·²åšé¢˜æ•°
      Column() {
        Text(`${this.completedQuestionCount}`)
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Text('å·²åšé¢˜æ•°')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      // åˆ†éš”çº¿
      Column()
        .width(1)
        .height(30)
        .backgroundColor(ThemeColors.GRAY_200)

      // å®Œæˆè¿›åº¦
      Column() {
        Text(`${this.getOverallProgress()}%`)
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Text('å®Œæˆè¿›åº¦')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      // åˆ†éš”çº¿
      Column()
        .width(1)
        .height(30)
        .backgroundColor(ThemeColors.GRAY_200)

      // æœ€é«˜æ¨¡æ‹Ÿåˆ†
      Column() {
        Text(this.getHighestExamScore())
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Text('æœ€é«˜æ¨¡æ‹Ÿåˆ†')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_MD })
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_SM })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_LG)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
  }

  /**
   * è€ƒè¯•è¿›åº¦å¡ç‰‡
   */
  /**
   * å¸¸ç”¨åŠŸèƒ½ 2x2 ç½‘æ ¼
   */
  @Builder
  ProfileCommonFunctions() {
    Column() {
      Row() {
        Text('å¸¸ç”¨åŠŸèƒ½')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_LG, bottom: ThemeConstants.SPACING_SM })

      // 2x2 ç½‘æ ¼
      Column() {
        Row() {
          // å­¦ä¹ æŠ¥å‘Š
          this.ProfileFunctionItem($r('app.media.Report'), 'å­¦ä¹ æŠ¥å‘Š', () => {
            Router.push('pages/StudyReportPage');
          })

          // è€ƒè¯•æˆç»©
          this.ProfileFunctionItem($r('app.media.Examresults'), 'è€ƒè¯•æˆç»©', () => {
            Router.push('pages/ExamScorePage');
          })
        }
        .width('100%')

        Row() {
          // æˆ‘çš„æˆå°±
          this.ProfileFunctionItem($r('app.media.Achievement'), 'æˆ‘çš„æˆå°±', () => {
            Router.push('pages/AchievementPage');
          })

          // é”™é¢˜æœ¬
          this.ProfileFunctionItem($r('app.media.WrongQuestion'), 'é”™é¢˜æœ¬', () => {
            Router.goToWrongBook();
          })
        }
        .width('100%')
        .margin({ top: ThemeConstants.SPACING_SM })
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
    }
    .width('100%')
  }

  /**
   * åŠŸèƒ½é¡¹
   */
  @Builder
  ProfileFunctionItem(icon: Resource, title: string, onClick: () => void) {
    Column() {
      Image(icon)
        .width(50)
        .height(50)
        .objectFit(ImageFit.Contain)
        .borderRadius(ThemeConstants.RADIUS_MD)

      Text(title)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ top: 8 })
    }
    .layoutWeight(1)
    .padding({ top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_MD })
    .margin({ left: ThemeConstants.SPACING_XS, right: ThemeConstants.SPACING_XS })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({ width: 1, color: ThemeColors.GRAY_200 })
    .onClick(onClick)
  }

  /**
   * æ›´å¤šæœåŠ¡
   */
  @Builder
  ProfileMoreServices() {
    Column() {
      Row() {
        Text('æ›´å¤šæœåŠ¡')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_LG, bottom: ThemeConstants.SPACING_SM })

      Column() {
        // æˆ‘çš„æ”¶è—
        this.ProfileServiceItem($r('app.media.AddedtoFavorites'), 'æˆ‘çš„æ”¶è—', `${this.favoriteCount} é“æ”¶è—`, () => {
          Router.goToFavorite();
        })

        Divider()
          .color(ThemeColors.GRAY_200)
          .margin({ left: 44 })

        // å…³äºåº”ç”¨
        this.ProfileServiceItem($r('app.media.Settings'), 'å…³äºåº”ç”¨', 'ç‰ˆæœ¬ä¿¡æ¯', () => {
          Router.push('pages/AboutPage');
        })
      }
      .width('100%')
      .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
      .backgroundColor(ThemeColors.SURFACE)
      .borderRadius(ThemeConstants.RADIUS_MD)
      .border({ width: 1, color: ThemeColors.GRAY_200 })
    }
    .width('100%')
  }

  /**
   * æœåŠ¡é¡¹
   */
  @Builder
  ProfileServiceItem(icon: Resource, title: string, desc: string, onClick: () => void) {
    Row() {
      Image(icon)
        .width(22)
        .height(22)
        .objectFit(ImageFit.Contain)

      Text(title)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ left: ThemeConstants.SPACING_SM })
        .layoutWeight(1)

      Text(desc)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ right: ThemeConstants.SPACING_XS })

      Image($r('app.media.Rightarrow'))
        .width(16)
        .height(16)
        .fillColor(ThemeColors.TEXT_HINT)
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .onClick(onClick)
  }
}
