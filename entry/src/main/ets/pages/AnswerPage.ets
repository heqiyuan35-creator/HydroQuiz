/**
 * ç­”é¢˜é¡µé¢ - æ ¸å¿ƒåˆ·é¢˜ç•Œé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Question, QuestionOption, QuestionType, SubjectInfo } from '../common/types/QuestionTypes';
import { getSubjectShortName, getSubjectColor, SUBJECT_LIST } from '../data/SubjectData';
import { questionService, QuestionQuery } from '../services/QuestionService';
import { answerRecordService, AnswerRecordInput, SubjectWrongStat } from '../services/AnswerRecordService';
import { AppConstants } from '../common/constants/AppConstants';
import { Logger } from '../common/utils/Logger';

/**
 * ç§‘ç›®é”™é¢˜ç»Ÿè®¡æ¥å£
 */
interface SubjectWrongInfo {
  subjectId: string;
  subjectName: string;
  shortName: string;
  color: string;
  wrongCount: number;
}

@Entry
@Component
struct AnswerPage {
  @State currentIndex: number = 0;
  @State questions: Question[] = [];
  @State userAnswers: Map<string, string> = new Map();
  @State showAnswer: boolean = false;
  @State isFavorite: boolean = false;
  @State isDarkMode: boolean = false;
  @State subjectId: string = '';
  @State mode: string = 'sequence';
  @State isLoading: boolean = true;
  @State answerStartTime: number = 0;
  @State showAnswerCard: boolean = false;
  @State answerResultMap: Map<string, boolean> = new Map(); // questionId -> isCorrect
  // ç»ƒä¹ å®Œæˆåˆ†æå¼¹çª—
  @State showAnalysisDialog: boolean = false;
  @State analysisWeakSubjects: SubjectWrongInfo[] = [];

  // å½“å‰é¢˜ç›®
  @State currentQuestion: Question | null = null;
  // ç”¨æˆ·é€‰æ‹©çš„ç­”æ¡ˆ
  @State selectedOptions: string[] = [];
  // æ˜¯å¦æ¥è‡ªé”™é¢˜æœ¬ï¼ˆå•é¢˜ç»ƒä¹ æ¨¡å¼ï¼‰
  @State fromWrongBook: boolean = false;
  // æŒ‡å®šçš„é¢˜ç›®ID
  @State specifiedQuestionId: string = '';
  // é”™é¢˜é‡åšæ¨¡å¼ï¼šsequence/random/highFreq/timed
  @State wrongMode: string = 'sequence';
  // é™æ—¶æŒ‘æˆ˜ç›¸å…³
  @State timeLimit: number = 0; // é™æ—¶ç§’æ•°ï¼Œ0è¡¨ç¤ºä¸é™æ—¶
  @State remainingTime: number = 0; // å‰©ä½™æ—¶é—´
  @State isTimedMode: boolean = false; // æ˜¯å¦é™æ—¶æ¨¡å¼
  @State questionCount: number = 0; // ç»ƒä¹ é¢˜ç›®æ•°é‡
  private timerInterval: number = -1; // è®¡æ—¶å™¨ID

  aboutToAppear(): void {
    const params: RouteParams = Router.getParams();
    if (params['subjectId']) {
      this.subjectId = params['subjectId'] as string;
    }
    if (params['mode']) {
      this.mode = params['mode'] as string;
    }
    if (params['fromWrongBook']) {
      this.fromWrongBook = params['fromWrongBook'] as boolean;
    }
    if (params['questionId']) {
      this.specifiedQuestionId = params['questionId'] as string;
    }
    // é”™é¢˜é‡åšæ¨¡å¼å‚æ•°
    if (params['wrongMode']) {
      this.wrongMode = params['wrongMode'] as string;
    }
    if (params['timeLimit']) {
      this.timeLimit = params['timeLimit'] as number;
      this.remainingTime = this.timeLimit;
      this.isTimedMode = this.timeLimit > 0;
    }
    if (params['questionCount']) {
      this.questionCount = params['questionCount'] as number;
    }

    // åŠ è½½é¢˜ç›®
    this.loadQuestions();
  }

  aboutToDisappear(): void {
    // æ¸…é™¤è®¡æ—¶å™¨
    this.clearTimer();
  }

  /**
   * æ¸…é™¤è®¡æ—¶å™¨
   */
  private clearTimer(): void {
    if (this.timerInterval !== -1) {
      clearInterval(this.timerInterval);
      this.timerInterval = -1;
    }
  }

  /**
   * åŠ è½½é¢˜ç›®
   */
  private async loadQuestions(): Promise<void> {
    try {
      // å¦‚æœæ¥è‡ªé”™é¢˜æœ¬ä¸”æŒ‡å®šäº†é¢˜ç›®IDï¼ŒåªåŠ è½½è¿™ä¸€é“é¢˜
      if (this.fromWrongBook && this.specifiedQuestionId) {
        await this.loadSingleQuestion(this.specifiedQuestionId);
      } else if (this.mode === AppConstants.PRACTICE_MODE_WRONG) {
        // é”™é¢˜ç»ƒä¹ æ¨¡å¼
        await this.loadWrongQuestions();
      } else if (this.mode === AppConstants.PRACTICE_MODE_FAVORITE) {
        // æ”¶è—ç»ƒä¹ æ¨¡å¼
        await this.loadFavoriteQuestions();
      } else if (this.mode === 'single' && this.specifiedQuestionId) {
        // å•é¢˜æ¨¡å¼
        await this.loadSingleQuestion(this.specifiedQuestionId);
      } else if (this.mode === 'daily') {
        // æ¯æ—¥ä¸€ç»ƒï¼šéšæœºé¢˜ç›®ï¼Œæ•°é‡=æ¯æ—¥ç›®æ ‡
        await this.loadDailyQuestions();
      } else if (this.mode === 'intensive') {
        // å¼ºåŒ–è®­ç»ƒï¼š100é“å…¨éšæœº
        await this.loadIntensiveQuestions();
      } else if (this.mode === 'weakness') {
        // ä¸“é¡¹ç»ƒä¹ ï¼šæ ¹æ®é”™é¢˜æ•°æ®æ™ºèƒ½å‡ºé¢˜
        await this.loadWeaknessQuestions();
      } else if (this.mode === 'important') {
        // é«˜é¢‘é‡ç‚¹ï¼šé‡è¦é¢˜ç›®éšæœº50é“
        await this.loadImportantQuestions();
      } else if (this.mode === 'subject') {
        // ç§‘ç›®å¼ºåŒ–ï¼šæŒ‡å®šç§‘ç›®éšæœº50é¢˜
        await this.loadSubjectQuestions();
      } else {
        // æ™®é€šç»ƒä¹ æ¨¡å¼
        await this.loadNormalQuestions();
      }

      if (this.questions.length > 0) {
        this.currentQuestion = this.questions[0];
        this.answerStartTime = Date.now();
        // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
        this.checkFavoriteStatus();
      }

      Logger.info(`[AnswerPage] Loaded ${this.questions.length} questions in ${this.mode} mode, fromWrongBook: ${this.fromWrongBook}`);
    } catch (error) {
      Logger.error('[AnswerPage] Failed to load questions', error as Error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½å•ä¸ªé¢˜ç›®
   */
  private async loadSingleQuestion(questionId: string): Promise<void> {
    const question = await questionService.getQuestionById(questionId);
    if (question) {
      this.questions = [question];
    } else {
      this.questions = [];
    }
  }

  /**
   * åŠ è½½æ™®é€šç»ƒä¹ é¢˜ç›®
   */
  private async loadNormalQuestions(): Promise<void> {
    const query: QuestionQuery = {
      // ä¸è®¾ç½®limitï¼ŒåŠ è½½å…¨éƒ¨é¢˜ç›®
    };

    // æ ¹æ®ç§‘ç›®ç­›é€‰
    if (this.subjectId) {
      query.subjectId = this.subjectId;
    }

    // æ ¹æ®æ¨¡å¼è®¾ç½®
    if (this.mode === AppConstants.PRACTICE_MODE_RANDOM) {
      query.random = true;
    }

    this.questions = await questionService.getQuestions(query);
  }

  /**
   * åŠ è½½é”™é¢˜ç»ƒä¹ é¢˜ç›®
   */
  private async loadWrongQuestions(): Promise<void> {
    let wrongQuestions = await answerRecordService.getWrongQuestions();

    if (wrongQuestions.length === 0) {
      this.questions = [];
      return;
    }

    // æ ¹æ®é”™é¢˜é‡åšæ¨¡å¼å¤„ç†
    switch (this.wrongMode) {
      case 'random':
        // éšæœºæ‰“ä¹±
        wrongQuestions = this.shuffleArray(wrongQuestions);
        break;
      case 'highFreq':
        // æŒ‰é”™è¯¯æ¬¡æ•°é™åºæ’åˆ—
        wrongQuestions.sort((a, b) => b.wrongCount - a.wrongCount);
        break;
      case 'timed':
        // é™æ—¶æ¨¡å¼ï¼Œéšæœºæ‰“ä¹±
        wrongQuestions = this.shuffleArray(wrongQuestions);
        break;
      case 'sequence':
      default:
        // æŒ‰æ—¶é—´é¡ºåºï¼ˆé»˜è®¤å·²æ’åºï¼‰
        break;
    }

    // é™åˆ¶é¢˜ç›®æ•°é‡
    if (this.questionCount > 0 && this.questionCount < wrongQuestions.length) {
      wrongQuestions = wrongQuestions.slice(0, this.questionCount);
    }

    // è·å–é¢˜ç›®è¯¦æƒ…
    const wrongIds = wrongQuestions.map(w => w.questionId);
    const questions = await questionService.getQuestionsByIds(wrongIds);

    // ä¿æŒæ’åºé¡ºåº
    const orderedQuestions: Question[] = [];
    wrongIds.forEach((id: string) => {
      const found = questions.find((q: Question) => q.id === id);
      if (found) {
        orderedQuestions.push(found);
      }
    });
    this.questions = orderedQuestions;

    // å¦‚æœæ˜¯é™æ—¶æ¨¡å¼ï¼Œå¯åŠ¨è®¡æ—¶å™¨
    if (this.isTimedMode && this.questions.length > 0) {
      this.startTimer();
    }
  }

  /**
   * éšæœºæ‰“ä¹±æ•°ç»„
   */
  private shuffleArray<T>(array: T[]): T[] {
    const result = [...array];
    for (let i = result.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const temp = result[i];
      result[i] = result[j];
      result[j] = temp;
    }
    return result;
  }

  /**
   * å¯åŠ¨é™æ—¶è®¡æ—¶å™¨
   */
  private startTimer(): void {
    this.timerInterval = setInterval(() => {
      if (this.remainingTime > 0) {
        this.remainingTime--;
      } else {
        // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨ç»“æŸ
        clearInterval(this.timerInterval);
        this.timerInterval = -1;
        this.onTimeUp();
      }
    }, 1000);
  }

  /**
   * æ—¶é—´åˆ°å¤„ç†
   */
  private onTimeUp(): void {
    // æ¸…é™¤è®¡æ—¶å™¨
    this.clearTimer();
    // æ˜¾ç¤ºæ—¶é—´åˆ°æç¤ºï¼Œç„¶åè¿”å›
    AlertDialog.show({
      title: 'â±ï¸ æ—¶é—´åˆ°ï¼',
      message: `æœ¬æ¬¡ç»ƒä¹ å®Œæˆ ${this.userAnswers.size} é¢˜ï¼Œæ­£ç¡® ${this.getCorrectCount()} é¢˜`,
      confirm: {
        value: 'ç¡®å®š',
        action: () => {
          Router.back();
        }
      }
    });
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
   */
  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  /**
   * åŠ è½½æ”¶è—ç»ƒä¹ é¢˜ç›®
   */
  private async loadFavoriteQuestions(): Promise<void> {
    const favoriteIds = await answerRecordService.getFavoriteQuestionIds();
    if (favoriteIds.length > 0) {
      this.questions = await questionService.getQuestionsByIds(favoriteIds);
    } else {
      this.questions = [];
    }
  }

  /**
   * æ¯æ—¥ä¸€ç»ƒï¼šéšæœºé¢˜ç›®ï¼Œé»˜è®¤20é¢˜
   */
  private async loadDailyQuestions(): Promise<void> {
    const query: QuestionQuery = {
      random: true,
      limit: this.questionCount > 0 ? this.questionCount : 20 // é»˜è®¤20é¢˜
    };
    this.questions = await questionService.getQuestions(query);
  }

  /**
   * å¼ºåŒ–è®­ç»ƒï¼š100é“å…¨éšæœºç»¼åˆé¢˜
   */
  private async loadIntensiveQuestions(): Promise<void> {
    const query: QuestionQuery = {
      random: true,
      limit: 100
    };
    this.questions = await questionService.getQuestions(query);
  }

  /**
   * ä¸“é¡¹ç»ƒä¹ ï¼šæ ¹æ®é”™é¢˜æ•°æ®æ™ºèƒ½å‡ºé¢˜ï¼Œé”™çš„ç±»åˆ«å¤šçš„é¢˜ç›®å¤š
   */
  private async loadWeaknessQuestions(): Promise<void> {
    // è·å–é”™é¢˜ç»Ÿè®¡ï¼ŒæŒ‰ç§‘ç›®åˆ†ç»„
    const wrongStats = await answerRecordService.getWrongQuestionsBySubject();
    
    if (wrongStats.length === 0) {
      // æ²¡æœ‰é”™é¢˜æ•°æ®ï¼Œéšæœºå‡º50é¢˜
      const query: QuestionQuery = {
        random: true,
        limit: 50
      };
      this.questions = await questionService.getQuestions(query);
      return;
    }

    // è®¡ç®—æ€»é”™é¢˜æ•°
    let totalWrong = 0;
    wrongStats.forEach((stat: SubjectWrongStat) => {
      totalWrong += stat.wrongCount;
    });

    // æŒ‰é”™é¢˜æ¯”ä¾‹åˆ†é…é¢˜ç›®æ•°é‡ï¼Œæ€»å…±50é¢˜
    const totalQuestions = 50;
    const allQuestions: Question[] = [];

    for (const stat of wrongStats) {
      // æŒ‰æ¯”ä¾‹è®¡ç®—è¯¥ç§‘ç›®åº”å‡ºçš„é¢˜ç›®æ•°é‡
      const ratio = stat.wrongCount / totalWrong;
      const count = Math.max(1, Math.round(totalQuestions * ratio));
      
      const query: QuestionQuery = {
        subjectId: stat.subjectId,
        random: true,
        limit: count
      };
      const questions = await questionService.getQuestions(query);
      allQuestions.push(...questions);
    }

    // æ‰“ä¹±é¡ºåº
    this.questions = this.shuffleArray(allQuestions).slice(0, totalQuestions);
  }

  /**
   * é«˜é¢‘é‡ç‚¹ï¼šé‡è¦é¢˜ç›®éšæœº50é“
   */
  private async loadImportantQuestions(): Promise<void> {
    // è·å–æ ‡è®°ä¸ºé‡è¦çš„é¢˜ç›®
    const query: QuestionQuery = {
      random: true,
      limit: 50
    };
    // ä¼˜å…ˆè·å–é«˜é¢‘é”™é¢˜å’Œæ”¶è—é¢˜ç›®
    const wrongQuestions = await answerRecordService.getWrongQuestions();
    const favoriteIds = await answerRecordService.getFavoriteQuestionIds();
    
    // åˆå¹¶é«˜é¢‘é”™é¢˜IDå’Œæ”¶è—ID
    const importantIds = new Set<string>();
    
    // æ·»åŠ é”™è¯¯æ¬¡æ•°>=2çš„é¢˜ç›®
    wrongQuestions.filter(w => w.wrongCount >= 2).forEach(w => {
      importantIds.add(w.questionId);
    });
    
    // æ·»åŠ æ”¶è—é¢˜ç›®
    favoriteIds.forEach((id: string) => {
      importantIds.add(id);
    });

    if (importantIds.size >= 50) {
      // ä»é‡è¦é¢˜ç›®ä¸­éšæœºé€‰50é“
      const idArray = Array.from(importantIds);
      const shuffled = this.shuffleArray(idArray).slice(0, 50);
      this.questions = await questionService.getQuestionsByIds(shuffled);
    } else {
      // é‡è¦é¢˜ç›®ä¸è¶³50é“ï¼Œè¡¥å……éšæœºé¢˜ç›®
      const importantQuestions = importantIds.size > 0 
        ? await questionService.getQuestionsByIds(Array.from(importantIds))
        : [];
      
      const remainingCount = 50 - importantQuestions.length;
      if (remainingCount > 0) {
        const randomQuestions = await questionService.getQuestions(query);
        // è¿‡æ»¤æ‰å·²æœ‰çš„é¢˜ç›®
        const filtered = randomQuestions.filter((q: Question) => !importantIds.has(q.id));
        this.questions = [...importantQuestions, ...filtered.slice(0, remainingCount)];
      } else {
        this.questions = importantQuestions;
      }
    }
    
    // æ‰“ä¹±é¡ºåº
    this.questions = this.shuffleArray(this.questions);
  }

  /**
   * ç§‘ç›®å¼ºåŒ–ï¼šæŒ‡å®šç§‘ç›®éšæœº50é¢˜
   */
  private async loadSubjectQuestions(): Promise<void> {
    const limit = this.questionCount > 0 ? this.questionCount : 50;
    const query: QuestionQuery = {
      subjectId: this.subjectId,
      random: true,
      limit: limit
    };
    this.questions = await questionService.getQuestions(query);
  }

  /**
   * æ£€æŸ¥æ”¶è—çŠ¶æ€
   */
  private async checkFavoriteStatus(): Promise<void> {
    if (this.currentQuestion) {
      this.isFavorite = await answerRecordService.isFavorite(this.currentQuestion.id);
    }
  }

  /**
   * é€‰æ‹©é€‰é¡¹
   */
  private selectOption(optionKey: string): void {
    if (this.showAnswer) return;

    const question = this.currentQuestion;
    if (!question) return;

    if (question.type === QuestionType.SINGLE || question.type === QuestionType.JUDGE) {
      // å•é€‰é¢˜/åˆ¤æ–­é¢˜ï¼šé€‰æ‹©åç›´æ¥æ˜¾ç¤ºç­”æ¡ˆè§£æï¼Œä¸è‡ªåŠ¨è·³è½¬
      this.selectedOptions = [optionKey];
      this.submitAnswer();
    } else if (question.type === QuestionType.MULTIPLE) {
      // å¤šé€‰é¢˜ï¼šéœ€è¦æ‰‹åŠ¨ç¡®è®¤
      const index = this.selectedOptions.indexOf(optionKey);
      if (index > -1) {
        this.selectedOptions = this.selectedOptions.filter((item: string) => item !== optionKey);
      } else {
        this.selectedOptions = [...this.selectedOptions, optionKey];
      }
    }
  }

  /**
   * æäº¤ç­”æ¡ˆ
   */
  private async submitAnswer(): Promise<void> {
    if (this.selectedOptions.length === 0) return;

    const question = this.currentQuestion;
    if (!question) return;

    // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
    const userAnswer = [...this.selectedOptions].sort().join(',');
    this.userAnswers.set(question.id, userAnswer);

    // è®¡ç®—ç­”é¢˜æ—¶é—´
    const answerTime = Math.round((Date.now() - this.answerStartTime) / 1000);
    const isCorrect = userAnswer === question.answer;

    // ä¿å­˜ç­”é¢˜è®°å½•åˆ°æ•°æ®åº“
    try {
      const recordInput: AnswerRecordInput = {
        questionId: question.id,
        userAnswer: userAnswer,
        isCorrect: isCorrect,
        answerTime: answerTime,
        createTime: Date.now()
      };
      await answerRecordService.saveAnswerRecord(recordInput);
      // è®°å½•ç­”é¢˜ç»“æœ
      this.answerResultMap.set(question.id, isCorrect);
    } catch (error) {
      Logger.error('[AnswerPage] Failed to save answer record', error as Error);
    }

    // æ˜¾ç¤ºç­”æ¡ˆ
    this.showAnswer = true;
  }

  /**
   * è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
   */
  private goToQuestion(index: number): void {
    if (index >= 0 && index < this.questions.length) {
      const targetQuestion = this.questions[index];
      const savedAnswer = this.userAnswers.get(targetQuestion.id);
      
      // ä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰çŠ¶æ€ï¼Œé¿å…å¤šæ¬¡è§¦å‘æ¸²æŸ“
      this.currentIndex = index;
      this.currentQuestion = targetQuestion;
      this.answerStartTime = Date.now();
      
      // æ ¹æ®æ˜¯å¦æœ‰ä¿å­˜çš„ç­”æ¡ˆï¼Œä¸€æ¬¡æ€§è®¾ç½®é€‰é¡¹å’Œæ˜¾ç¤ºçŠ¶æ€
      if (savedAnswer) {
        this.selectedOptions = savedAnswer.split(',');
        this.showAnswer = true;
      } else {
        this.selectedOptions = [];
        this.showAnswer = false;
      }

      // æ£€æŸ¥æ”¶è—çŠ¶æ€
      this.checkFavoriteStatus();
    }
  }

  /**
   * ä¸‹ä¸€é¢˜
   */
  private nextQuestion(): void {
    if (this.currentIndex < this.questions.length - 1) {
      const nextIndex = this.currentIndex + 1;
      const targetQuestion = this.questions[nextIndex];
      const savedAnswer = this.userAnswers.get(targetQuestion.id);
      
      // ä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰çŠ¶æ€ï¼Œé¿å…å¤šæ¬¡è§¦å‘æ¸²æŸ“
      this.currentIndex = nextIndex;
      this.currentQuestion = targetQuestion;
      this.answerStartTime = Date.now();
      
      // æ ¹æ®æ˜¯å¦æœ‰ä¿å­˜çš„ç­”æ¡ˆï¼Œä¸€æ¬¡æ€§è®¾ç½®é€‰é¡¹å’Œæ˜¾ç¤ºçŠ¶æ€
      if (savedAnswer) {
        this.selectedOptions = savedAnswer.split(',');
        this.showAnswer = true;
      } else {
        this.selectedOptions = [];
        this.showAnswer = false;
      }

      // æ£€æŸ¥æ”¶è—çŠ¶æ€
      this.checkFavoriteStatus();
    }
  }

  /**
   * ä¸Šä¸€é¢˜
   */
  private prevQuestion(): void {
    if (this.currentIndex > 0) {
      const prevIndex = this.currentIndex - 1;
      const targetQuestion = this.questions[prevIndex];
      const savedAnswer = this.userAnswers.get(targetQuestion.id);
      
      // ä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰çŠ¶æ€ï¼Œé¿å…å¤šæ¬¡è§¦å‘æ¸²æŸ“
      this.currentIndex = prevIndex;
      this.currentQuestion = targetQuestion;
      this.answerStartTime = Date.now();
      
      // æ ¹æ®æ˜¯å¦æœ‰ä¿å­˜çš„ç­”æ¡ˆï¼Œä¸€æ¬¡æ€§è®¾ç½®é€‰é¡¹å’Œæ˜¾ç¤ºçŠ¶æ€
      if (savedAnswer) {
        this.selectedOptions = savedAnswer.split(',');
        this.showAnswer = true;
      } else {
        this.selectedOptions = [];
        this.showAnswer = false;
      }

      // æ£€æŸ¥æ”¶è—çŠ¶æ€
      this.checkFavoriteStatus();
    }
  }

  /**
   * åˆ‡æ¢æ”¶è—çŠ¶æ€
   */
  private async toggleFavorite(): Promise<void> {
    if (!this.currentQuestion) return;

    try {
      if (this.isFavorite) {
        await answerRecordService.removeFavorite(this.currentQuestion.id);
      } else {
        await answerRecordService.addFavorite(this.currentQuestion.id);
      }
      this.isFavorite = !this.isFavorite;
    } catch (error) {
      Logger.error('[AnswerPage] Failed to toggle favorite', error as Error);
    }
  }

  /**
   * åˆ¤æ–­é€‰é¡¹æ˜¯å¦æ­£ç¡®
   */
  private isOptionCorrect(optionKey: string): boolean {
    if (!this.currentQuestion) return false;
    const correctAnswers = this.currentQuestion.answer.split(',');
    return correctAnswers.includes(optionKey);
  }

  /**
   * åˆ¤æ–­ç”¨æˆ·ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
   */
  private isAnswerCorrect(): boolean {
    if (!this.currentQuestion) return false;
    // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆ›å»ºå‰¯æœ¬ï¼Œé¿å…ä¿®æ”¹åŸæ•°ç»„
    const userAnswer = [...this.selectedOptions].sort().join(',');
    return userAnswer === this.currentQuestion.answer;
  }

  /**
   * è·å–é¢˜å‹åç§°
   */
  private getQuestionTypeName(type: QuestionType): string {
    switch (type) {
      case QuestionType.SINGLE:
        return 'å•é€‰é¢˜';
      case QuestionType.MULTIPLE:
        return 'å¤šé€‰é¢˜';
      case QuestionType.JUDGE:
        return 'åˆ¤æ–­é¢˜';
      case QuestionType.CASE:
        return 'æ¡ˆä¾‹åˆ†æ';
      default:
        return 'æœªçŸ¥';
    }
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        this.NavigationBar()

        if (this.isLoading) {
          // åŠ è½½ä¸­
          Column() {
            LoadingProgress()
              .width(48)
              .height(48)
              .color(ThemeColors.PRIMARY)

            Text('åŠ è½½é¢˜ç›®ä¸­...')
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .margin({ top: ThemeConstants.SPACING_MD })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else if (this.currentQuestion) {
          // é¢˜ç›®+é€‰é¡¹+è§£æï¼ˆæ•´ä½“å¯æ»šåŠ¨ï¼‰
          Scroll() {
            Column() {
              // é¢˜ç›®ä¿¡æ¯
              this.QuestionInfo()
              // é¢˜ç›®å†…å®¹
              this.QuestionContent()
              // é€‰é¡¹åˆ—è¡¨
              this.OptionList()
              // ç­”æ¡ˆè§£æï¼ˆæäº¤åæ˜¾ç¤ºï¼‰
              if (this.showAnswer) {
                this.AnswerAnalysis()
              }
            }
            .width('100%')
            .padding(ThemeConstants.SPACING_MD)
          }
          .scrollBar(BarState.Off)
          .layoutWeight(1)
          .align(Alignment.Top)

          // åº•éƒ¨æ“ä½œæ 
          this.BottomBar()
        } else {
          // æ— é¢˜ç›®
          Column() {
            Text('æš‚æ— é¢˜ç›®')
              .fontSize(ThemeConstants.FONT_SIZE_LG)
              .fontColor(ThemeColors.TEXT_SECONDARY)
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')

      // ç­”é¢˜å¡å¼¹çª—
      if (this.showAnswerCard) {
        Column() {
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.showAnswerCard = false;
            })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })

        this.PracticeAnswerCardPanel()
      }

      // ç»ƒä¹ å®Œæˆåˆ†æå¼¹çª—
      if (this.showAnalysisDialog) {
        Column() {
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })

        Column() {
          this.PracticeAnalysisDialog()
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .position({ x: 0, y: 0 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.isDarkMode ? ThemeColors.BACKGROUND_DARK : ThemeColors.BACKGROUND)
    .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
  }

  /**
   * ç»ƒä¹ å®Œæˆåˆ†æå¼¹çª—
   */
  @Builder
  PracticeAnalysisDialog() {
    Column() {
      // é¡¶éƒ¨ç»“æœåŒºåŸŸ
      Column() {
        Text('ğŸ¯')
          .fontSize(36)

        Text(this.getModeName() + 'å®Œæˆï¼')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .margin({ top: 8 })

        // æˆç»©ç»Ÿè®¡
        Row() {
          this.ResultStatItem(`${this.userAnswers.size}`, 'ç­”é¢˜', ThemeColors.PRIMARY)
          this.ResultStatItem(`${this.getCorrectCount()}`, 'æ­£ç¡®', ThemeColors.SUCCESS)
          this.ResultStatItem(`${this.getWrongCount()}`, 'é”™è¯¯', ThemeColors.ERROR)
          this.ResultStatItem(`${this.userAnswers.size > 0 ? Math.round(this.getCorrectCount() / this.userAnswers.size * 100) : 0}%`, 'æ­£ç¡®ç‡', ThemeColors.WARNING)
        }
        .width('100%')
        .margin({ top: 16 })
        .justifyContent(FlexAlign.SpaceEvenly)

        // æ­£å‘åé¦ˆ
        Text(this.getPositiveFeedback())
          .fontSize(13)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ top: 12 })
      }
      .width('100%')
      .padding(20)

      Divider().color(ThemeColors.GRAY_200)

      // è–„å¼±ç§‘ç›®åˆ†æ
      if (this.analysisWeakSubjects.length > 0) {
        Column() {
          Row() {
            Text('ğŸ“Š è–„å¼±æ–¹å‘')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.TEXT_PRIMARY)
          }
          .width('100%')
          .margin({ bottom: 10 })

          ForEach(this.analysisWeakSubjects, (item: SubjectWrongInfo, index: number) => {
            Row() {
              // æ’å
              Text(`${index + 1}`)
                .fontSize(11)
                .fontColor(ThemeColors.WHITE)
                .fontWeight(FontWeight.Bold)
                .textAlign(TextAlign.Center)
                .width(20)
                .height(20)
                .borderRadius(10)
                .backgroundColor(index === 0 ? '#FF4D4F' : (index === 1 ? '#FF7A45' : '#FAAD14'))

              // ç§‘ç›®åç§°
              Text(item.shortName)
                .fontSize(14)
                .fontColor(ThemeColors.TEXT_PRIMARY)
                .margin({ left: 8 })

              // é”™é¢˜æ•°
              Text(`${item.wrongCount}é“`)
                .fontSize(12)
                .fontColor(ThemeColors.ERROR)
                .margin({ left: 6 })

              Blank()

              // ç»ƒä¹ æŒ‰é’®
              Text('ç»ƒä¹ ')
                .fontSize(12)
                .fontColor(ThemeColors.WHITE)
                .padding({ left: 12, right: 12, top: 5, bottom: 5 })
                .backgroundColor(item.color)
                .borderRadius(12)
                .onClick(() => {
                  this.showAnalysisDialog = false;
                  const params: RouteParams = {};
                  params['subjectId'] = item.subjectId as Object;
                  params['mode'] = 'subject' as Object;
                  params['questionCount'] = 30 as Object;
                  Router.replace('pages/AnswerPage', params);
                })

              // çŸ¥è¯†æŒ‰é’®
              Text('çŸ¥è¯†')
                .fontSize(12)
                .fontColor(item.color)
                .padding({ left: 12, right: 12, top: 5, bottom: 5 })
                .backgroundColor(item.color + '15')
                .borderRadius(12)
                .margin({ left: 8 })
                .onClick(() => {
                  this.showAnalysisDialog = false;
                  const params: RouteParams = {};
                  params['subjectId'] = item.subjectId as Object;
                  Router.push('pages/KnowledgeListPage', params);
                })
            }
            .width('100%')
            .padding(10)
            .margin({ bottom: 6 })
            .backgroundColor(ThemeColors.GRAY_50)
            .borderRadius(8)
          }, (item: SubjectWrongInfo) => item.subjectId)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      }

      // åº•éƒ¨æŒ‰é’®
      Row({ space: 12 }) {
        Button('è¿”å›')
          .layoutWeight(1)
          .height(42)
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .backgroundColor(ThemeColors.GRAY_100)
          .borderRadius(21)
          .onClick(() => {
            this.showAnalysisDialog = false;
            Router.back();
          })

        Button('å†æ¥ä¸€ç»„')
          .layoutWeight(1)
          .height(42)
          .fontSize(14)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(ThemeColors.PRIMARY)
          .borderRadius(21)
          .onClick(() => {
            this.showAnalysisDialog = false;
            const params: RouteParams = {};
            params['mode'] = this.mode as Object;
            if (this.subjectId) {
              params['subjectId'] = this.subjectId as Object;
            }
            Router.replace('pages/AnswerPage', params);
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })
    }
    .width('85%')
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(16)
    .shadow({ radius: 16, color: 'rgba(0,0,0,0.1)', offsetY: 4 })
  }

  @Builder
  ResultStatItem(value: string, label: string, color: ResourceColor) {
    Column() {
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      Text(label)
        .fontSize(11)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ top: 2 })
    }
  }

  /**
   * å¯¼èˆªæ 
   */
  @Builder
  NavigationBar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        Router.back();
      })

      // ä¸­é—´åŒºåŸŸï¼šè¿›åº¦ + é™æ—¶å€’è®¡æ—¶
      Column() {
        // è¿›åº¦ï¼ˆç‚¹å‡»æ‰“å¼€ç­”é¢˜å¡ï¼‰
        Row() {
          Text(`${this.currentIndex + 1} / ${this.questions.length}`)
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Text(' ğŸ“‹')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
        }
        .onClick(() => {
          this.showAnswerCard = true;
        })

        // é™æ—¶æ¨¡å¼æ˜¾ç¤ºå€’è®¡æ—¶
        if (this.isTimedMode) {
          Row() {
            Text('â±ï¸')
              .fontSize(12)
            Text(this.formatTime(this.remainingTime))
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.remainingTime <= 60 ? ThemeColors.ERROR : ThemeColors.WARNING)
              .margin({ left: 4 })
          }
          .margin({ top: 2 })
        }
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)

      // æ”¶è—æŒ‰é’®
      Row() {
        Image(this.isFavorite ? $r('app.media.AddedtoFavorites') : $r('app.media.Tobesaved'))
          .width(24)
          .height(24)
          .objectFit(ImageFit.Contain)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        this.toggleFavorite();
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: ThemeConstants.SPACING_SM, right: ThemeConstants.SPACING_SM })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
  }

  /**
   * é¢˜ç›®ä¿¡æ¯
   */
  @Builder
  QuestionInfo() {
    Row() {
      // é¢˜å‹æ ‡ç­¾
      Text(this.getQuestionTypeName(this.currentQuestion!.type))
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.WHITE)
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(10)

      // ç§‘ç›®æ ‡ç­¾
      Text(getSubjectShortName(this.currentQuestion!.subjectId))
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.WHITE)
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .backgroundColor(getSubjectColor(this.currentQuestion!.subjectId))
        .borderRadius(10)
        .margin({ left: ThemeConstants.SPACING_SM })
    }
    .width('100%')
  }

  /**
   * é¢˜ç›®å†…å®¹
   */
  @Builder
  QuestionContent() {
    Column() {
      Text(this.currentQuestion!.content)
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .lineHeight(24)
    }
    .width('100%')
    .margin({ top: ThemeConstants.SPACING_MD })
    .alignItems(HorizontalAlign.Start)
  }

  /**
   * é€‰é¡¹åˆ—è¡¨
   */
  @Builder
  OptionList() {
    Column() {
      ForEach(this.currentQuestion!.options, (option: QuestionOption) => {
        this.OptionItem(option)
      })
    }
    .width('100%')
  }

  /**
   * é€‰é¡¹é¡¹
   */
  @Builder
  OptionItem(option: QuestionOption) {
    Row() {
      // é€‰é¡¹æ ‡è¯†
      Column() {
        Text(option.key)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getOptionKeyColor(option.key))
      }
      .width(32)
      .height(32)
      .borderRadius(16)
      .backgroundColor(this.getOptionKeyBgColor(option.key))
      .justifyContent(FlexAlign.Center)

      // é€‰é¡¹å†…å®¹
      Text(option.content)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .margin({ left: ThemeConstants.SPACING_BASE })

      // æ­£ç¡®/é”™è¯¯æ ‡è¯†
      if (this.showAnswer) {
        if (this.isOptionCorrect(option.key)) {
          Text('âœ“')
            .fontSize(ThemeConstants.FONT_SIZE_LG)
            .fontColor(ThemeColors.SUCCESS)
        } else if (this.selectedOptions.includes(option.key)) {
          Text('âœ—')
            .fontSize(ThemeConstants.FONT_SIZE_LG)
            .fontColor(ThemeColors.ERROR)
        }
      }
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_BASE)
    .margin({ top: ThemeConstants.SPACING_SM })
    .backgroundColor(this.getOptionBgColor(option.key))
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({
      width: 1,
      color: this.getOptionBorderColor(option.key)
    })
    .onClick(() => {
      this.selectOption(option.key);
    })
  }

  /**
   * è·å–é€‰é¡¹æ ‡è¯†é¢œè‰²
   */
  private getOptionKeyColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) {
        return ThemeColors.WHITE;
      } else if (this.selectedOptions.includes(key)) {
        return ThemeColors.WHITE;
      }
    } else if (this.selectedOptions.includes(key)) {
      return ThemeColors.WHITE;
    }
    return ThemeColors.TEXT_SECONDARY;
  }

  /**
   * è·å–é€‰é¡¹æ ‡è¯†èƒŒæ™¯è‰²
   */
  private getOptionKeyBgColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) {
        return ThemeColors.SUCCESS;
      } else if (this.selectedOptions.includes(key)) {
        return ThemeColors.ERROR;
      }
    } else if (this.selectedOptions.includes(key)) {
      return ThemeColors.PRIMARY;
    }
    return this.isDarkMode ? ThemeColors.SURFACE_VARIANT_DARK : ThemeColors.GRAY_100;
  }

  /**
   * è·å–é€‰é¡¹èƒŒæ™¯è‰²
   */
  private getOptionBgColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) {
        return 'rgba(82, 196, 26, 0.1)';
      } else if (this.selectedOptions.includes(key)) {
        return 'rgba(255, 77, 79, 0.1)';
      }
    }
    return this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE;
  }

  /**
   * è·å–é€‰é¡¹è¾¹æ¡†è‰²
   */
  private getOptionBorderColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) {
        return ThemeColors.SUCCESS;
      } else if (this.selectedOptions.includes(key)) {
        return ThemeColors.ERROR;
      }
    } else if (this.selectedOptions.includes(key)) {
      return ThemeColors.PRIMARY;
    }
    return this.isDarkMode ? ThemeColors.BORDER_DARK : ThemeColors.BORDER;
  }

  /**
   * ç­”æ¡ˆè§£æ
   */
  @Builder
  AnswerAnalysis() {
    Column() {
      // ç»“æœæç¤ºå¡ç‰‡
      Row() {
        // ç»“æœå›¾æ ‡
        Column() {
          Text(this.isAnswerCorrect() ? 'âœ“' : 'âœ—')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.WHITE)
        }
        .width(56)
        .height(56)
        .borderRadius(28)
        .backgroundColor(this.isAnswerCorrect() ? ThemeColors.SUCCESS : ThemeColors.ERROR)
        .justifyContent(FlexAlign.Center)

        Column() {
          Text(this.isAnswerCorrect() ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯')
            .fontSize(ThemeConstants.FONT_SIZE_LG)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.isAnswerCorrect() ? ThemeColors.SUCCESS : ThemeColors.ERROR)

          Text(this.isAnswerCorrect() ? 'ç»§ç»­ä¿æŒï¼Œä½ å¾ˆæ£’ï¼' : 'åˆ«ç°å¿ƒï¼Œçœ‹çœ‹è§£æå§')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_HINT)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: ThemeConstants.SPACING_MD })
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)
      .backgroundColor(this.isAnswerCorrect() ? 'rgba(82, 196, 26, 0.1)' : 'rgba(255, 77, 79, 0.1)')
      .borderRadius(ThemeConstants.RADIUS_MD)

      // è§£æ
      Column() {
        Row() {
          Text('ğŸ’¡')
            .fontSize(16)
          Text(' é¢˜ç›®è§£æ')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
        .width('100%')

        Text(this.currentQuestion!.analysis || 'æš‚æ— è§£æ')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .lineHeight(24)
          .margin({ top: ThemeConstants.SPACING_SM })
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)
      .margin({ top: ThemeConstants.SPACING_SM })
      .backgroundColor(ThemeColors.SURFACE)
      .borderRadius(ThemeConstants.RADIUS_MD)
      .border({ width: 1, color: ThemeColors.GRAY_200 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .margin({ top: ThemeConstants.SPACING_MD })
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºå¤šé€‰é¢˜ä¸”æœªæäº¤ç­”æ¡ˆ
   */
  private isMultipleAndNotSubmitted(): boolean {
    return this.currentQuestion !== null &&
      this.currentQuestion.type === QuestionType.MULTIPLE &&
      !this.showAnswer;
  }

  /**
   * åº•éƒ¨æ“ä½œæ 
   */
  @Builder
  BottomBar() {
    Row() {
      // ä¸Šä¸€é¢˜
      Button('ä¸Šä¸€é¢˜')
        .width(100)
        .height(44)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(this.currentIndex > 0 ? ThemeColors.PRIMARY : ThemeColors.TEXT_DISABLED)
        .backgroundColor(ThemeColors.TRANSPARENT)
        .borderWidth(1)
        .borderColor(this.currentIndex > 0 ? ThemeColors.PRIMARY : ThemeColors.BORDER)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .enabled(this.currentIndex > 0)
        .onClick(() => {
          this.prevQuestion();
        })

      Blank()

      // æ¥è‡ªé”™é¢˜æœ¬çš„å•é¢˜æ¨¡å¼ï¼Œç­”å®Œç›´æ¥è¿”å›
      if (this.fromWrongBook && this.showAnswer) {
        Button('è¿”å›é”™é¢˜æœ¬')
          .width(120)
          .height(44)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(ThemeColors.PRIMARY)
          .borderRadius(ThemeConstants.RADIUS_BASE)
          .onClick(() => {
            Router.back();
          })
      } else if (this.isMultipleAndNotSubmitted()) {
        // å¤šé€‰é¢˜æœªæäº¤æ—¶æ˜¾ç¤º"ç¡®è®¤ç­”æ¡ˆ"æŒ‰é’®
        Button('ç¡®è®¤ç­”æ¡ˆ')
          .width(120)
          .height(44)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(this.selectedOptions.length > 0 ? ThemeColors.PRIMARY : ThemeColors.TEXT_DISABLED)
          .borderRadius(ThemeConstants.RADIUS_BASE)
          .enabled(this.selectedOptions.length > 0)
          .onClick(() => {
            this.submitAnswer();
          })
      } else {
        // ä¸‹ä¸€é¢˜æŒ‰é’®
        Button(this.currentIndex < this.questions.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'å®Œæˆ')
          .width(120)
          .height(44)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(this.currentIndex < this.questions.length - 1 ? ThemeColors.PRIMARY : ThemeColors.SUCCESS)
          .borderRadius(ThemeConstants.RADIUS_BASE)
          .onClick(() => {
            if (this.currentIndex < this.questions.length - 1) {
              this.nextQuestion();
            } else {
              // å®Œæˆç»ƒä¹ ï¼Œæ˜¾ç¤ºåˆ†æå¼¹çª—
              this.showPracticeAnalysis();
            }
          })
      }
    }
    .width('100%')
    .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_MD, bottom: 32 })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
  }

  /**
   * æ˜¾ç¤ºç»ƒä¹ å®Œæˆåˆ†æ
   */
  private showPracticeAnalysis(): void {
    // åªæœ‰ç‰¹å®šæ¨¡å¼æ‰æ˜¾ç¤ºåˆ†æå¼¹çª—
    const analysisModels = ['daily', 'intensive', 'weakness', 'important'];
    if (!analysisModels.includes(this.mode)) {
      Router.back();
      return;
    }

    // è®¡ç®—æœ¬æ¬¡ç»ƒä¹ çš„é”™é¢˜ç§‘ç›®åˆ†å¸ƒ
    this.analysisWeakSubjects = this.calculateWeakSubjects();
    
    // å¦‚æœæ²¡æœ‰é”™é¢˜ï¼Œç›´æ¥è¿”å›
    if (this.getWrongCount() === 0) {
      Router.back();
      return;
    }

    this.showAnalysisDialog = true;
  }

  /**
   * è®¡ç®—è–„å¼±ç§‘ç›®ï¼ˆæœ¬æ¬¡ç»ƒä¹ çš„é”™é¢˜åˆ†å¸ƒï¼‰
   */
  private calculateWeakSubjects(): SubjectWrongInfo[] {
    const subjectWrongMap: Map<string, number> = new Map();

    // ç»Ÿè®¡æ¯ä¸ªç§‘ç›®çš„é”™é¢˜æ•°
    this.answerResultMap.forEach((isCorrect: boolean, questionId: string) => {
      if (!isCorrect) {
        const question = this.questions.find((q: Question) => q.id === questionId);
        if (question) {
          const count = subjectWrongMap.get(question.subjectId) || 0;
          subjectWrongMap.set(question.subjectId, count + 1);
        }
      }
    });

    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
    const result: SubjectWrongInfo[] = [];
    subjectWrongMap.forEach((wrongCount: number, subjectId: string) => {
      const subject = SUBJECT_LIST.find((s: SubjectInfo) => s.id === subjectId);
      if (subject) {
        const info: SubjectWrongInfo = {
          subjectId: subjectId,
          subjectName: subject.name,
          shortName: subject.shortName,
          color: subject.color,
          wrongCount: wrongCount
        };
        result.push(info);
      }
    });

    // æŒ‰é”™é¢˜æ•°é‡é™åºæ’åºï¼Œå–å‰3ä¸ª
    result.sort((a: SubjectWrongInfo, b: SubjectWrongInfo) => b.wrongCount - a.wrongCount);
    return result.slice(0, 3);
  }

  /**
   * è·å–æ­£å‘åé¦ˆæ–‡æ¡ˆ
   */
  private getPositiveFeedback(): string {
    const accuracy = this.userAnswers.size > 0 
      ? Math.round(this.getCorrectCount() / this.userAnswers.size * 100) 
      : 0;
    
    if (accuracy >= 90) {
      return 'å¤ªæ£’äº†ï¼ä½ çš„è¡¨ç°éå¸¸å‡ºè‰²ï¼ğŸ‰';
    } else if (accuracy >= 70) {
      return 'åšå¾—ä¸é”™ï¼ç»§ç»­ä¿æŒè¿™ä¸ªåŠ¿å¤´ï¼ğŸ’ª';
    } else if (accuracy >= 50) {
      return 'æœ‰è¿›æ­¥ç©ºé—´ï¼Œé’ˆå¯¹è–„å¼±ç‚¹å¤šç»ƒä¹ ï¼ğŸ“š';
    } else {
      return 'åˆ«ç°å¿ƒï¼Œæ¯æ¬¡ç»ƒä¹ éƒ½æ˜¯è¿›æ­¥ï¼åŠ æ²¹ï¼ğŸŒŸ';
    }
  }

  /**
   * è·å–ç»ƒä¹ æ¨¡å¼åç§°
   */
  private getModeName(): string {
    switch (this.mode) {
      case 'daily': return 'æ¯æ—¥ä¸€ç»ƒ';
      case 'intensive': return 'å¼ºåŒ–è®­ç»ƒ';
      case 'weakness': return 'ä¸“é¡¹ç»ƒä¹ ';
      case 'important': return 'é«˜é¢‘é‡ç‚¹';
      default: return 'ç»ƒä¹ ';
    }
  }

  /**
   * ç»ƒä¹ ç­”é¢˜å¡é¢æ¿
   */
  @Builder
  PracticeAnswerCardPanel() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ç­”é¢˜å¡')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Text('âœ•')
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontColor(ThemeColors.TEXT_HINT)
          .onClick(() => {
            this.showAnswerCard = false;
          })
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)

      // ç»Ÿè®¡ä¿¡æ¯
      Row() {
        this.PracticeStatItem('å·²ç­”', this.userAnswers.size, ThemeColors.PRIMARY)
        this.PracticeStatItem('æ­£ç¡®', this.getCorrectCount(), ThemeColors.SUCCESS)
        this.PracticeStatItem('é”™è¯¯', this.getWrongCount(), ThemeColors.ERROR)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
      .justifyContent(FlexAlign.SpaceAround)

      // é¢˜ç›®ç½‘æ ¼
      Scroll() {
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
          ForEach(this.generatePracticeIndexArray(), (index: number) => {
            this.PracticeQuestionItem(index)
          })
        }
        .width('100%')
        .padding(ThemeConstants.SPACING_SM)
      }
      .layoutWeight(1)

      // å›¾ä¾‹
      Row() {
        this.PracticeLegendItem(ThemeColors.GRAY_200, 'æœªç­”')
        this.PracticeLegendItem(ThemeColors.SUCCESS, 'æ­£ç¡®')
        this.PracticeLegendItem(ThemeColors.ERROR, 'é”™è¯¯')
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(ThemeColors.GRAY_50)
    }
    .width('100%')
    .height('60%')
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius({ topLeft: ThemeConstants.RADIUS_LG, topRight: ThemeConstants.RADIUS_LG })
  }

  private generatePracticeIndexArray(): number[] {
    const arr: number[] = [];
    for (let i = 0; i < this.questions.length; i++) {
      arr.push(i);
    }
    return arr;
  }

  private getCorrectCount(): number {
    let count = 0;
    this.answerResultMap.forEach((isCorrect: boolean) => {
      if (isCorrect) count++;
    });
    return count;
  }

  private getWrongCount(): number {
    let count = 0;
    this.answerResultMap.forEach((isCorrect: boolean) => {
      if (!isCorrect) count++;
    });
    return count;
  }

  @Builder
  PracticeStatItem(label: string, count: number, color: string) {
    Row() {
      Circle()
        .width(12)
        .height(12)
        .fill(color)

      Text(`${label}: ${count}`)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ left: ThemeConstants.SPACING_XS })
    }
  }

  @Builder
  PracticeQuestionItem(index: number) {
    Column() {
      Text(`${index + 1}`)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(this.getPracticeItemTextColor(index))
    }
    .width(44)
    .height(44)
    .margin(4)
    .borderRadius(ThemeConstants.RADIUS_BASE)
    .backgroundColor(this.getPracticeItemBgColor(index))
    .border({
      width: this.currentIndex === index ? 2 : 0,
      color: ThemeColors.WARNING
    })
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.goToQuestion(index);
      this.showAnswerCard = false;
    })
  }

  private getPracticeItemBgColor(index: number): string {
    if (index >= this.questions.length) return ThemeColors.GRAY_200;
    const question = this.questions[index];
    const result = this.answerResultMap.get(question.id);
    if (result === undefined) return ThemeColors.GRAY_200;
    return result ? ThemeColors.SUCCESS : ThemeColors.ERROR;
  }

  private getPracticeItemTextColor(index: number): string {
    if (index >= this.questions.length) return ThemeColors.TEXT_SECONDARY;
    const question = this.questions[index];
    const result = this.answerResultMap.get(question.id);
    if (result === undefined) return ThemeColors.TEXT_SECONDARY;
    return ThemeColors.WHITE;
  }

  @Builder
  PracticeLegendItem(color: string, label: string) {
    Row() {
      Column()
        .width(16)
        .height(16)
        .borderRadius(4)
        .backgroundColor(color)

      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ left: ThemeConstants.SPACING_XXS })
    }
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
  }
}
