/**
 * å…¥é—¨æµ‹è¯•é¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 * é¦–æ¬¡ä½¿ç”¨æ—¶è¿›è¡Œæ°´å¹³æµ‹è¯•ï¼Œäº†è§£ç”¨æˆ·åŸºç¡€
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Question, QuestionOption, QuestionType, SubjectInfo } from '../common/types/QuestionTypes';
import { getSubjectShortName, getSubjectColor, SUBJECT_LIST } from '../data/SubjectData';
import { questionService } from '../services/QuestionService';
import { answerRecordService, AnswerRecordInput } from '../services/AnswerRecordService';
import { userService } from '../services/UserService';
import { AppConstants } from '../common/constants/AppConstants';
import { Logger } from '../common/utils/Logger';
import { onboardingService } from '../services/OnboardingService';

/**
 * ç§‘ç›®é”™é¢˜ç»Ÿè®¡
 */
interface SubjectWrongStat {
  subjectId: string;
  shortName: string;
  color: string;
  wrongCount: number;
}

/**
 * çŸ¥è¯†ç±»å‹å®šä¹‰
 */
interface KnowledgeType {
  id: string;
  name: string;
  color: string;
}

// çŸ¥è¯†ç±»å‹åˆ—è¡¨
const KNOWLEDGE_TYPES: KnowledgeType[] = [
  { id: 'concept', name: 'æ¦‚å¿µç†è§£', color: '#1677FF' },
  { id: 'standard', name: 'è§„èŒƒæ ‡å‡†', color: '#722ED1' },
  { id: 'calculation', name: 'è®¡ç®—åº”ç”¨', color: '#13C2C2' },
  { id: 'process', name: 'å·¥è‰ºæµç¨‹', color: '#FA8C16' },
  { id: 'safety', name: 'å®‰å…¨è§„ç¨‹', color: '#F5222D' },
  { id: 'equipment', name: 'è®¾å¤‡ä»ªå™¨', color: '#52C41A' },
  { id: 'material', name: 'ææ–™æ€§èƒ½', color: '#EB2F96' },
  { id: 'method', name: 'æ£€æµ‹æ–¹æ³•', color: '#2F54EB' },
  { id: 'quality', name: 'è´¨é‡æ§åˆ¶', color: '#FAAD14' },
  { id: 'analysis', name: 'æ•°æ®åˆ†æ', color: '#A0D911' }
];

/**
 * ç”¨æˆ·ç­‰çº§å®šä¹‰
 */
interface UserLevel {
  title: string;
  description: string;
  emoji: string;
  color: string;
}

// æ ¹æ®æ­£ç¡®ç‡è·å–ç”¨æˆ·ç­‰çº§
function getUserLevel(correctRate: number): UserLevel {
  if (correctRate >= 0.8) {
    return {
      title: 'æ°´åˆ©ä¸“å®¶',
      description: 'æ‚¨çš„æ°´åˆ©çŸ¥è¯†å‚¨å¤‡éå¸¸æ‰å®ï¼Œç»§ç»­ä¿æŒï¼',
      emoji: 'ğŸ†',
      color: '#FFD700'
    };
  } else if (correctRate >= 0.6) {
    return {
      title: 'æ°´åˆ©è€æ‰‹',
      description: 'æ‚¨å·²ç»æœ‰ä¸é”™çš„åŸºç¡€ï¼Œå†æ¥å†å‰ï¼',
      emoji: 'â­',
      color: '#1677FF'
    };
  } else {
    return {
      title: 'æ°´åˆ©å­¦å‘˜',
      description: 'æ¯ä¸ªä¸“å®¶éƒ½æ˜¯ä»å­¦å‘˜å¼€å§‹çš„ï¼ŒåŠ æ²¹ï¼',
      emoji: 'ğŸŒ±',
      color: '#52C41A'
    };
  }
}

@Entry
@Component
struct EntryTestPage {
  @State currentIndex: number = 0;
  @State questions: Question[] = [];
  @State userAnswers: Map<string, string> = new Map();
  @State answerResultMap: Map<string, boolean> = new Map();
  @State showAnswer: boolean = false;
  @State selectedOptions: string[] = [];
  @State isLoading: boolean = true;
  @State currentQuestion: Question | null = null;
  @State showResult: boolean = false;
  @State weakSubjects: SubjectWrongStat[] = [];
  @State showWelcome: boolean = true;
  @State questionKnowledgeTypes: Map<string, string> = new Map();

  private readonly TEST_COUNT: number = 10; // æµ‹è¯•é¢˜ç›®æ•°é‡æ”¹ä¸º10é¢˜

  aboutToAppear(): void {
    // ä¸è‡ªåŠ¨åŠ è½½ï¼Œç­‰ç”¨æˆ·ç‚¹å‡»å¼€å§‹æµ‹è¯•
  }

  /**
   * å¼€å§‹æµ‹è¯•
   */
  private startTest(): void {
    this.showWelcome = false;
    this.loadTestQuestions();
  }

  /**
   * åŠ è½½æµ‹è¯•é¢˜ç›® - æ¯ä¸ªç§‘ç›®éšæœºæŠ½å–é¢˜ç›®ï¼Œå¹¶åˆ†é…çŸ¥è¯†ç±»å‹
   */
  private async loadTestQuestions(): Promise<void> {
    try {
      const allQuestions: Question[] = [];
      const questionsPerSubject = Math.ceil(this.TEST_COUNT / SUBJECT_LIST.length);

      // ä»æ¯ä¸ªç§‘ç›®éšæœºæŠ½å–é¢˜ç›®
      for (const subject of SUBJECT_LIST) {
        const questions = await questionService.getQuestions({
          subjectId: subject.id,
          random: true,
          limit: questionsPerSubject
        });
        allQuestions.push(...questions);
      }

      // æ‰“ä¹±é¡ºåºå¹¶å–å‰10é¢˜
      this.questions = this.shuffleArray(allQuestions).slice(0, this.TEST_COUNT);

      // ä¸ºæ¯é“é¢˜åˆ†é…çŸ¥è¯†ç±»å‹
      this.questions.forEach((q: Question, index: number) => {
        const typeIndex = index % KNOWLEDGE_TYPES.length;
        this.questionKnowledgeTypes.set(q.id, KNOWLEDGE_TYPES[typeIndex].id);
      });

      if (this.questions.length > 0) {
        this.currentQuestion = this.questions[0];
      }

      Logger.info(`[EntryTestPage] Loaded ${this.questions.length} test questions`);
    } catch (error) {
      Logger.error('[EntryTestPage] Failed to load questions', error as Error);
    } finally {
      this.isLoading = false;
    }
  }

  private shuffleArray<T>(array: T[]): T[] {
    const result = [...array];
    for (let i = result.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const temp = result[i];
      result[i] = result[j];
      result[j] = temp;
    }
    return result;
  }

  /**
   * è·å–é¢˜ç›®çš„çŸ¥è¯†ç±»å‹
   */
  private getQuestionKnowledgeType(questionId: string): KnowledgeType {
    const typeId = this.questionKnowledgeTypes.get(questionId) || 'concept';
    return KNOWLEDGE_TYPES.find((t: KnowledgeType) => t.id === typeId) || KNOWLEDGE_TYPES[0];
  }

  private selectOption(optionKey: string): void {
    if (this.showAnswer) return;
    const question = this.currentQuestion;
    if (!question) return;

    if (question.type === QuestionType.SINGLE || question.type === QuestionType.JUDGE) {
      this.selectedOptions = [optionKey];
      this.submitAnswer();
    } else if (question.type === QuestionType.MULTIPLE) {
      const index = this.selectedOptions.indexOf(optionKey);
      if (index > -1) {
        this.selectedOptions = this.selectedOptions.filter((item: string) => item !== optionKey);
      } else {
        this.selectedOptions = [...this.selectedOptions, optionKey];
      }
    }
  }

  private async submitAnswer(): Promise<void> {
    if (this.selectedOptions.length === 0) return;
    const question = this.currentQuestion;
    if (!question) return;

    const userAnswer = [...this.selectedOptions].sort().join(',');
    this.userAnswers.set(question.id, userAnswer);
    const isCorrect = userAnswer === question.answer;
    this.answerResultMap.set(question.id, isCorrect);

    // ä¿å­˜ç­”é¢˜è®°å½•
    try {
      const recordInput: AnswerRecordInput = {
        questionId: question.id,
        userAnswer: userAnswer,
        isCorrect: isCorrect,
        answerTime: 0,
        createTime: Date.now()
      };
      await answerRecordService.saveAnswerRecord(recordInput);
    } catch (error) {
      Logger.error('[EntryTestPage] Failed to save answer', error as Error);
    }

    this.showAnswer = true;
  }

  private nextQuestion(): void {
    if (this.currentIndex < this.questions.length - 1) {
      this.currentIndex++;
      this.currentQuestion = this.questions[this.currentIndex];
      this.selectedOptions = [];
      this.showAnswer = false;
    } else {
      // æµ‹è¯•å®Œæˆ
      this.finishTest();
    }
  }

  private async finishTest(): Promise<void> {
    // è®¡ç®—ç»“æœ
    const correctCount = this.getCorrectCount();
    const accuracy = Math.round(correctCount / this.questions.length * 100);
    const correctRate = correctCount / this.questions.length;
    const userLevel = getUserLevel(correctRate);

    // è®¡ç®—è–„å¼±ç§‘ç›®
    this.weakSubjects = this.calculateWeakSubjects();

    // ä¿å­˜æµ‹è¯•ç»“æœå’Œç”¨æˆ·ç§°å·
    await userService.saveEntryTestResult(correctCount, accuracy, userLevel.title);
    await userService.updateNickname(userLevel.title);
    await userService.markEntryTestCompleted();

    this.showResult = true;
  }

  private getCorrectCount(): number {
    let count = 0;
    this.answerResultMap.forEach((isCorrect: boolean) => {
      if (isCorrect) count++;
    });
    return count;
  }

  private calculateWeakSubjects(): SubjectWrongStat[] {
    const subjectWrongMap: Map<string, number> = new Map();

    this.answerResultMap.forEach((isCorrect: boolean, questionId: string) => {
      if (!isCorrect) {
        const question = this.questions.find((q: Question) => q.id === questionId);
        if (question) {
          const count = subjectWrongMap.get(question.subjectId) || 0;
          subjectWrongMap.set(question.subjectId, count + 1);
        }
      }
    });

    const result: SubjectWrongStat[] = [];
    subjectWrongMap.forEach((wrongCount: number, subjectId: string) => {
      const subject = SUBJECT_LIST.find((s: SubjectInfo) => s.id === subjectId);
      if (subject) {
        result.push({
          subjectId: subjectId,
          shortName: subject.shortName,
          color: subject.color,
          wrongCount: wrongCount
        });
      }
    });

    result.sort((a: SubjectWrongStat, b: SubjectWrongStat) => b.wrongCount - a.wrongCount);
    return result.slice(0, 3);
  }

  private isOptionCorrect(optionKey: string): boolean {
    if (!this.currentQuestion) return false;
    return this.currentQuestion.answer.split(',').includes(optionKey);
  }

  private isAnswerCorrect(): boolean {
    if (!this.currentQuestion) return false;
    const userAnswer = [...this.selectedOptions].sort().join(',');
    return userAnswer === this.currentQuestion.answer;
  }

  private getQuestionTypeName(type: QuestionType): string {
    switch (type) {
      case QuestionType.SINGLE: return 'å•é€‰é¢˜';
      case QuestionType.MULTIPLE: return 'å¤šé€‰é¢˜';
      case QuestionType.JUDGE: return 'åˆ¤æ–­é¢˜';
      default: return 'æœªçŸ¥';
    }
  }

  /**
   * è·å–é¼“åŠ±è¯­
   */
  private getEncouragementText(): string {
    const correctCount = this.getCorrectCount();
    const answeredCount = this.currentIndex + 1;
    const rate = correctCount / answeredCount;

    if (rate >= 0.8) {
      const texts = ['å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼', 'ä½ çœŸå‰å®³ï¼', 'å®Œç¾è¡¨ç°ï¼', 'çŸ¥è¯†å‚¨å¤‡å¾ˆæ‰å®ï¼'];
      return texts[Math.floor(Math.random() * texts.length)];
    } else if (rate >= 0.6) {
      const texts = ['ä¸é”™å“¦ï¼Œç»§ç»­åŠ æ²¹ï¼', 'ç¨³æ‰ç¨³æ‰“ï¼', 'å¾ˆæœ‰æ½œåŠ›ï¼', 'å†æ¥å†å‰ï¼'];
      return texts[Math.floor(Math.random() * texts.length)];
    } else {
      const texts = ['åˆ«ç°å¿ƒï¼Œè¿™åªæ˜¯å¼€å§‹ï¼', 'é”™é¢˜æ˜¯æœ€å¥½çš„è€å¸ˆï¼', 'æ¯ä¸€æ­¥éƒ½æ˜¯è¿›æ­¥ï¼', 'åšæŒå°±æ˜¯èƒœåˆ©ï¼'];
      return texts[Math.floor(Math.random() * texts.length)];
    }
  }

  build() {
    Stack() {
      Column() {
        if (this.showWelcome) {
          this.WelcomeView()
        } else if (this.isLoading) {
          this.LoadingView()
        } else if (this.showResult) {
          this.ResultView()
        } else if (this.currentQuestion) {
          this.TestView()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor(ThemeColors.BACKGROUND)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  WelcomeView() {
    Stack() {
      // èƒŒæ™¯å›¾
      Image($r('app.media.CardBackground'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)

      // æ¸å˜é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['rgba(22, 119, 255, 0.85)', 0], ['rgba(22, 119, 255, 0.95)', 1]]
        })

      // å†…å®¹
      Column() {
        Column() {
          Text('ğŸ‘‹')
            .fontSize(64)
        }
        .width(120)
        .height(120)
        .borderRadius(60)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 80 })

        Text('æ¬¢è¿æ¥åˆ°æ°´åˆ©åˆ·é¢˜å®ï¼')
          .fontSize(26)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.WHITE)
          .margin({ top: 24 })

        Text('å¾ˆé«˜å…´è®¤è¯†ä½ ï¼Œè®©æˆ‘ä»¬å¼€å§‹ä¸€æ®µç²¾å½©çš„å­¦ä¹ ä¹‹æ—…')
          .fontSize(15)
          .fontColor('rgba(255, 255, 255, 0.9)')
          .margin({ top: 8 })

        // æµ‹è¯•è¯´æ˜å¡ç‰‡
        Column() {
          Row() {
            Text('ğŸ“')
              .fontSize(24)
            Text('æ°´å¹³æµ‹è¯•')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .margin({ left: 8 })
          }
          .width('100%')
          .margin({ bottom: 16 })

          Text('åœ¨å¼€å§‹å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ä½ çš„æ°´åˆ©çŸ¥è¯†æ°´å¹³ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬ï¼š')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .lineHeight(22)

          Column() {
            this.WelcomeFeatureItem('ğŸ¯', 'ç²¾å‡†å®šä½ä½ çš„çŸ¥è¯†è–„å¼±ç‚¹')
            this.WelcomeFeatureItem('ğŸ“š', 'ä¸ºä½ æ™ºèƒ½æ¨èå­¦ä¹ å†…å®¹')
            this.WelcomeFeatureItem('ğŸ“Š', 'å»ºç«‹åˆå§‹é”™é¢˜æ•°æ®åº“')
            this.WelcomeFeatureItem('ğŸ…', 'è·å¾—ä¸“å±å­¦ä¹ ç§°å·')
          }
          .width('100%')
          .margin({ top: 12 })
          .alignItems(HorizontalAlign.Start)

          Row() {
            Text('â±ï¸')
              .fontSize(14)
            Text('å…±10é“é¢˜ï¼Œçº¦éœ€3åˆ†é’Ÿ')
              .fontSize(13)
              .fontColor(ThemeColors.TEXT_HINT)
              .margin({ left: 4 })
          }
          .margin({ top: 16 })
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(ThemeColors.GRAY_100)
          .borderRadius(12)
        }
        .width('100%')
        .padding(20)
        .margin({ top: 32 })
        .backgroundColor(ThemeColors.WHITE)
        .borderRadius(16)

        Blank()

        // å¼€å§‹æŒ‰é’®
        Button('å¼€å§‹æ°´å¹³æµ‹è¯•')
          .width('100%')
          .height(52)
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.PRIMARY)
          .backgroundColor(ThemeColors.WHITE)
          .borderRadius(26)
          .margin({ bottom: 40 })
          .onClick(() => this.startTest())
      }
      .width('100%')
      .height('100%')
      .padding({ left: 24, right: 24 })
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  WelcomeFeatureItem(emoji: string, text: string) {
    Row() {
      Text(emoji)
        .fontSize(16)
      Text(text)
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ left: 8 })
    }
    .width('100%')
    .margin({ top: 8 })
  }

  @Builder
  LoadingView() {
    Column() {
      LoadingProgress().width(48).height(48).color(ThemeColors.PRIMARY)
      Text('æ­£åœ¨ä¸ºä½ å‡†å¤‡æµ‹è¯•é¢˜ç›®...')
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: 16 })
      Text('è¯·ç¨å€™ â˜•')
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  TestView() {
    Column() {
      // é¡¶éƒ¨è¿›åº¦
      Row() {
        Text('æ°´å¹³æµ‹è¯•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Text(`${this.currentIndex + 1}/${this.questions.length}`)
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: AppConstants.STATUS_BAR_HEIGHT + 8, bottom: 8 })

      // è¿›åº¦æ¡
      Row() {
        Progress({ value: this.currentIndex + 1, total: this.questions.length })
          .width('100%')
          .height(4)
          .color(ThemeColors.PRIMARY)
          .backgroundColor(ThemeColors.GRAY_200)
      }
      .width('100%')
      .padding({ left: 16, right: 16 })

      // é¢˜ç›®å†…å®¹
      Scroll() {
        Column() {
          // é¢˜å‹ã€ç§‘ç›®å’ŒçŸ¥è¯†ç±»å‹æ ‡ç­¾
          Row() {
            Text(this.getQuestionTypeName(this.currentQuestion!.type))
              .fontSize(11)
              .fontColor(ThemeColors.WHITE)
              .padding({ left: 8, right: 8, top: 3, bottom: 3 })
              .backgroundColor(ThemeColors.PRIMARY)
              .borderRadius(8)

            Text(getSubjectShortName(this.currentQuestion!.subjectId))
              .fontSize(11)
              .fontColor(ThemeColors.WHITE)
              .padding({ left: 8, right: 8, top: 3, bottom: 3 })
              .backgroundColor(getSubjectColor(this.currentQuestion!.subjectId))
              .borderRadius(8)
              .margin({ left: 8 })

            // çŸ¥è¯†ç±»å‹æ ‡ç­¾
            Text(this.getQuestionKnowledgeType(this.currentQuestion!.id).name)
              .fontSize(11)
              .fontColor(ThemeColors.WHITE)
              .padding({ left: 8, right: 8, top: 3, bottom: 3 })
              .backgroundColor(this.getQuestionKnowledgeType(this.currentQuestion!.id).color)
              .borderRadius(8)
              .margin({ left: 8 })
          }
          .width('100%')

          // é¢˜ç›®
          Text(this.currentQuestion!.content)
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .lineHeight(24)
            .margin({ top: 16 })

          // é€‰é¡¹
          ForEach(this.currentQuestion!.options, (option: QuestionOption) => {
            this.OptionItem(option)
          })

          // ç­”æ¡ˆè§£æ
          if (this.showAnswer) {
            this.AnswerAnalysis()
          }
        }
        .width('100%')
        .padding(16)
        .alignItems(HorizontalAlign.Start)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // åº•éƒ¨æŒ‰é’®
      if (this.showAnswer) {
        Row() {
          Button(this.currentIndex < this.questions.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'æŸ¥çœ‹ç»“æœ')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(ThemeColors.WHITE)
            .backgroundColor(ThemeColors.PRIMARY)
            .borderRadius(24)
            .onClick(() => this.nextQuestion())
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 24 })
      } else if (this.currentQuestion?.type === QuestionType.MULTIPLE && this.selectedOptions.length > 0) {
        Row() {
          Button('ç¡®è®¤ç­”æ¡ˆ')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(ThemeColors.WHITE)
            .backgroundColor(ThemeColors.PRIMARY)
            .borderRadius(24)
            .onClick(() => this.submitAnswer())
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 24 })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  OptionItem(option: QuestionOption) {
    Row() {
      Column() {
        Text(option.key)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getOptionKeyColor(option.key))
      }
      .width(28)
      .height(28)
      .borderRadius(14)
      .backgroundColor(this.getOptionKeyBgColor(option.key))
      .justifyContent(FlexAlign.Center)

      Text(option.content)
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .margin({ left: 12 })

      if (this.showAnswer) {
        if (this.isOptionCorrect(option.key)) {
          Text('âœ“').fontSize(16).fontColor(ThemeColors.SUCCESS)
        } else if (this.selectedOptions.includes(option.key)) {
          Text('âœ—').fontSize(16).fontColor(ThemeColors.ERROR)
        }
      }
    }
    .width('100%')
    .padding(12)
    .margin({ top: 10 })
    .backgroundColor(this.getOptionBgColor(option.key))
    .borderRadius(10)
    .border({ width: 1, color: this.getOptionBorderColor(option.key) })
    .onClick(() => this.selectOption(option.key))
  }

  private getOptionKeyColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) return ThemeColors.WHITE;
      if (this.selectedOptions.includes(key)) return ThemeColors.WHITE;
    } else if (this.selectedOptions.includes(key)) {
      return ThemeColors.WHITE;
    }
    return ThemeColors.TEXT_SECONDARY;
  }

  private getOptionKeyBgColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) return ThemeColors.SUCCESS;
      if (this.selectedOptions.includes(key)) return ThemeColors.ERROR;
    } else if (this.selectedOptions.includes(key)) {
      return ThemeColors.PRIMARY;
    }
    return ThemeColors.GRAY_100;
  }

  private getOptionBgColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) return 'rgba(82, 196, 26, 0.1)';
      if (this.selectedOptions.includes(key)) return 'rgba(255, 77, 79, 0.1)';
    }
    return ThemeColors.SURFACE;
  }

  private getOptionBorderColor(key: string): string {
    if (this.showAnswer) {
      if (this.isOptionCorrect(key)) return ThemeColors.SUCCESS;
      if (this.selectedOptions.includes(key)) return ThemeColors.ERROR;
    } else if (this.selectedOptions.includes(key)) {
      return ThemeColors.PRIMARY;
    }
    return ThemeColors.BORDER;
  }

  @Builder
  AnswerAnalysis() {
    Column() {
      Row() {
        Column() {
          Text(this.isAnswerCorrect() ? 'âœ“' : 'âœ—')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.WHITE)
        }
        .width(40)
        .height(40)
        .borderRadius(20)
        .backgroundColor(this.isAnswerCorrect() ? ThemeColors.SUCCESS : ThemeColors.ERROR)
        .justifyContent(FlexAlign.Center)

        Column() {
          Text(this.isAnswerCorrect() ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.isAnswerCorrect() ? ThemeColors.SUCCESS : ThemeColors.ERROR)

          Text(this.getEncouragementText())
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_HINT)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })
      }
      .width('100%')
      .padding(12)
      .backgroundColor(this.isAnswerCorrect() ? 'rgba(82, 196, 26, 0.1)' : 'rgba(255, 77, 79, 0.1)')
      .borderRadius(10)

      if (this.currentQuestion?.analysis) {
        Column() {
          Text('ğŸ’¡ è§£æ')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Text(this.currentQuestion.analysis)
            .fontSize(13)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .lineHeight(20)
            .margin({ top: 8 })
        }
        .width('100%')
        .padding(12)
        .margin({ top: 10 })
        .backgroundColor(ThemeColors.SURFACE)
        .borderRadius(10)
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .margin({ top: 16 })
  }

  @Builder
  ResultView() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨ç§°å·å¡ç‰‡
        Column() {
          // ç§°å·å›¾æ ‡
          Column() {
            Text(getUserLevel(this.getCorrectCount() / this.questions.length).emoji)
              .fontSize(56)
          }
          .width(100)
          .height(100)
          .borderRadius(50)
          .backgroundColor(ThemeColors.WHITE)
          .justifyContent(FlexAlign.Center)
          .shadow({ radius: 16, color: 'rgba(0, 0, 0, 0.1)', offsetY: 4 })

          Text('æ­å–œä½ å®Œæˆæ°´å¹³æµ‹è¯•ï¼')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .margin({ top: 20 })

          // ç§°å·å±•ç¤º
          Row() {
            Text('ä½ çš„ç§°å·')
              .fontSize(13)
              .fontColor(ThemeColors.TEXT_HINT)
          }
          .margin({ top: 8 })

          Text(getUserLevel(this.getCorrectCount() / this.questions.length).title)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor(getUserLevel(this.getCorrectCount() / this.questions.length).color)
            .margin({ top: 4 })

          Text(getUserLevel(this.getCorrectCount() / this.questions.length).description)
            .fontSize(13)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: 8 })
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .padding({ top: AppConstants.STATUS_BAR_HEIGHT + 32, bottom: 24, left: 16, right: 16 })
        .alignItems(HorizontalAlign.Center)
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#E8F4FF', 0], [ThemeColors.BACKGROUND, 1]]
        })

        // æˆç»©å¡ç‰‡
        Column() {
          Text('ğŸ“Š æµ‹è¯•æˆç»©')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .width('100%')

          Row() {
            Column() {
              Text(`${this.getCorrectCount()}`)
                .fontSize(36)
                .fontWeight(FontWeight.Bold)
                .fontColor(ThemeColors.SUCCESS)
              Text('æ­£ç¡®')
                .fontSize(12)
                .fontColor(ThemeColors.TEXT_HINT)
                .margin({ top: 4 })
            }
            .layoutWeight(1)

            Column() {
              Text(`${this.questions.length - this.getCorrectCount()}`)
                .fontSize(36)
                .fontWeight(FontWeight.Bold)
                .fontColor(ThemeColors.ERROR)
              Text('é”™è¯¯')
                .fontSize(12)
                .fontColor(ThemeColors.TEXT_HINT)
                .margin({ top: 4 })
            }
            .layoutWeight(1)

            Column() {
              Text(`${Math.round(this.getCorrectCount() / this.questions.length * 100)}%`)
                .fontSize(36)
                .fontWeight(FontWeight.Bold)
                .fontColor(ThemeColors.PRIMARY)
              Text('æ­£ç¡®ç‡')
                .fontSize(12)
                .fontColor(ThemeColors.TEXT_HINT)
                .margin({ top: 4 })
            }
            .layoutWeight(1)
          }
          .width('100%')
          .margin({ top: 20 })
        }
        .width('100%')
        .padding(20)
        .margin({ left: 16, right: 16 })
        .backgroundColor(ThemeColors.SURFACE)
        .borderRadius(16)

        // è–„å¼±ç§‘ç›®
        if (this.weakSubjects.length > 0) {
          Column() {
            Text('ğŸ“š éœ€è¦åŠ å¼ºçš„ç§‘ç›®')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .width('100%')
              .margin({ bottom: 12 })

            ForEach(this.weakSubjects, (item: SubjectWrongStat) => {
              Row() {
                Row() {
                  Text('')
                    .width(4)
                    .height(16)
                    .backgroundColor(item.color)
                    .borderRadius(2)
                  Text(item.shortName)
                    .fontSize(14)
                    .fontColor(ThemeColors.TEXT_PRIMARY)
                    .margin({ left: 8 })
                }

                Blank()

                Text(`${item.wrongCount} é“é”™é¢˜`)
                  .fontSize(13)
                  .fontColor(ThemeColors.ERROR)
              }
              .width('100%')
              .padding(12)
              .margin({ bottom: 8 })
              .backgroundColor(ThemeColors.GRAY_50)
              .borderRadius(8)
            }, (item: SubjectWrongStat) => item.subjectId)
          }
          .width('100%')
          .padding(20)
          .margin({ top: 12, left: 16, right: 16 })
          .backgroundColor(ThemeColors.SURFACE)
          .borderRadius(16)
        }

        // å¼€å§‹å­¦ä¹ æŒ‰é’®
        Button('å¼€å¯å­¦ä¹ ä¹‹æ—… ğŸš€')
          .width('100%')
          .height(52)
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(ThemeColors.PRIMARY)
          .borderRadius(26)
          .margin({ top: 24, left: 16, right: 16, bottom: 40 })
          .onClick(async () => {
            // è®¾ç½®å¯¼å¼•æ ‡è®°ï¼Œè¿›å…¥ä¸»é¡µåæ˜¾ç¤ºæ–°æ‰‹å¯¼å¼•
            await onboardingService.setShowGuideAfterTest(true);
            Router.replace('pages/MainTabPage');
          })
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
    .backgroundColor(ThemeColors.BACKGROUND)
  }
}
