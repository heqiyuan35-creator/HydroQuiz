/**
 * æ¨¡æ‹Ÿè€ƒè¯•é¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Question, QuestionOption, QuestionType } from '../common/types/QuestionTypes';
import { questionService, QuestionQuery } from '../services/QuestionService';
import { answerRecordService, ExamRecordInput } from '../services/AnswerRecordService';
import { getSubjectShortName, getSubjectColor } from '../data/SubjectData';
import { Logger } from '../common/utils/Logger';
import { AppConstants } from '../common/constants/AppConstants';

/**
 * è€ƒè¯•é…ç½®
 */
interface ExamConfig {
  totalQuestions: number;
  timeLimit: number; // åˆ†é’Ÿ
  passScore: number; // åŠæ ¼åˆ†æ•°
}

@Entry
@Component
struct ExamPage {
  @State examType: string = 'mock';
  @State subjectId: string = '';
  @State isDarkMode: boolean = false;
  @State isStarted: boolean = false;
  @State isSubmitted: boolean = false;
  @State isLoading: boolean = false;
  @State showAnswerCard: boolean = false;

  // è€ƒè¯•æ•°æ®
  @State questions: Question[] = [];
  @State currentIndex: number = 0;
  @State userAnswers: Map<string, string> = new Map();
  @State selectedOptions: string[] = [];
  @State answeredIndexMap: Map<number, number> = new Map(); // index -> status (0=æœªç­”, 3=å·²ç­”)

  // è®¡æ—¶å™¨
  @State remainingTime: number = 0; // å‰©ä½™ç§’æ•°
  private timerId: number = -1;

  // è€ƒè¯•é…ç½®
  private examConfig: ExamConfig = {
    totalQuestions: 20,
    timeLimit: 30,
    passScore: 60
  };

  aboutToAppear(): void {
    const params: RouteParams = Router.getParams();
    if (params['examType']) {
      this.examType = params['examType'] as string;
    }
    if (params['subjectId']) {
      this.subjectId = params['subjectId'] as string;
    }
  }

  aboutToDisappear(): void {
    this.stopTimer();
  }


  /**
   * å¼€å§‹è€ƒè¯•
   */
  private async startExam(): Promise<void> {
    this.isLoading = true;
    try {
      const query: QuestionQuery = {
        limit: this.examConfig.totalQuestions,
        random: true
      };

      if (this.subjectId) {
        query.subjectId = this.subjectId;
      }

      this.questions = await questionService.getQuestions(query);

      if (this.questions.length > 0) {
        this.isStarted = true;
        this.remainingTime = this.examConfig.timeLimit * 60;
        this.startTimer();
      }

      Logger.info(`[ExamPage] Started exam with ${this.questions.length} questions`);
    } catch (error) {
      Logger.error('[ExamPage] Failed to start exam', error as Error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å¼€å§‹è®¡æ—¶
   */
  private startTimer(): void {
    this.timerId = setInterval(() => {
      if (this.remainingTime > 0) {
        this.remainingTime--;
      } else {
        this.submitExam();
      }
    }, 1000);
  }

  /**
   * åœæ­¢è®¡æ—¶
   */
  private stopTimer(): void {
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  /**
   * é€‰æ‹©é€‰é¡¹
   */
  private selectOption(optionKey: string): void {
    const question = this.questions[this.currentIndex];
    if (!question) return;

    if (question.type === QuestionType.SINGLE || question.type === QuestionType.JUDGE) {
      this.selectedOptions = [optionKey];
    } else if (question.type === QuestionType.MULTIPLE) {
      const index = this.selectedOptions.indexOf(optionKey);
      if (index > -1) {
        this.selectedOptions = this.selectedOptions.filter((item: string) => item !== optionKey);
      } else {
        this.selectedOptions = [...this.selectedOptions, optionKey];
      }
    }
  }

  /**
   * ä¿å­˜å½“å‰ç­”æ¡ˆ
   */
  private saveCurrentAnswer(): void {
    if (this.selectedOptions.length > 0) {
      const question = this.questions[this.currentIndex];
      const answer = this.selectedOptions.sort().join(',');
      this.userAnswers.set(question.id, answer);
      // æ›´æ–°ç­”é¢˜çŠ¶æ€
      this.answeredIndexMap.set(this.currentIndex, 3); // 3 = å·²ç­”
    }
  }

  /**
   * è·å–ç­”é¢˜å¡çŠ¶æ€Map
   */
  private getAnswerCardMap(): Map<number, number> {
    return this.answeredIndexMap;
  }

  /**
   * ä¸‹ä¸€é¢˜
   */
  private nextQuestion(): void {
    this.saveCurrentAnswer();
    if (this.currentIndex < this.questions.length - 1) {
      this.currentIndex++;
      this.loadSavedAnswer();
    }
  }

  /**
   * ä¸Šä¸€é¢˜
   */
  private prevQuestion(): void {
    this.saveCurrentAnswer();
    if (this.currentIndex > 0) {
      this.currentIndex--;
      this.loadSavedAnswer();
    }
  }

  /**
   * è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
   */
  private goToQuestion(index: number): void {
    this.saveCurrentAnswer();
    this.currentIndex = index;
    this.loadSavedAnswer();
  }

  /**
   * åŠ è½½å·²ä¿å­˜çš„ç­”æ¡ˆ
   */
  private loadSavedAnswer(): void {
    const question = this.questions[this.currentIndex];
    const savedAnswer = this.userAnswers.get(question.id);
    if (savedAnswer) {
      this.selectedOptions = savedAnswer.split(',');
    } else {
      this.selectedOptions = [];
    }
  }

  /**
   * æäº¤è€ƒè¯•
   */
  private submitExam(): void {
    this.saveCurrentAnswer();
    this.stopTimer();

    // è®¡ç®—æˆç»©å¹¶æ”¶é›†é”™é¢˜
    let correctCount = 0;
    const wrongQuestionIds: string[] = [];

    this.questions.forEach((question: Question) => {
      const userAnswer = this.userAnswers.get(question.id);
      if (userAnswer === question.answer) {
        correctCount++;
      } else {
        // æ”¶é›†é”™é¢˜ID
        wrongQuestionIds.push(question.id);
      }
    });

    const score = Math.round((correctCount / this.questions.length) * 100);
    const duration = this.examConfig.timeLimit * 60 - this.remainingTime;

    // ä¿å­˜è€ƒè¯•è®°å½•åˆ°æ•°æ®åº“
    this.saveExamRecordToDb(correctCount, score, duration);

    // å°†é”™é¢˜æ·»åŠ åˆ°é”™é¢˜æœ¬
    this.saveWrongQuestionsToDb(wrongQuestionIds);

    // è·³è½¬åˆ°ç»“æœé¡µ
    const params: RouteParams = {};
    params['totalCount'] = this.questions.length as Object;
    params['correctCount'] = correctCount as Object;
    params['score'] = score as Object;
    params['duration'] = duration as Object;
    params['passScore'] = this.examConfig.passScore as Object;

    Router.push('pages/ExamResultPage', params);
  }

  /**
   * å°†é”™é¢˜ä¿å­˜åˆ°é”™é¢˜æœ¬
   */
  private async saveWrongQuestionsToDb(wrongQuestionIds: string[]): Promise<void> {
    try {
      for (const questionId of wrongQuestionIds) {
        await answerRecordService.addToWrongBook(questionId);
      }
      Logger.info(`[ExamPage] Added ${wrongQuestionIds.length} wrong questions to wrong book`);
    } catch (error) {
      Logger.error('[ExamPage] Failed to save wrong questions', error as Error);
    }
  }

  /**
   * ä¿å­˜è€ƒè¯•è®°å½•åˆ°æ•°æ®åº“
   */
  private async saveExamRecordToDb(correctCount: number, score: number, duration: number): Promise<void> {
    try {
      const questionIds = this.questions.map((q: Question) => q.id).join(',');
      const answersArr: string[] = [];
      this.userAnswers.forEach((value: string, key: string) => {
        answersArr.push(`${key}:${value}`);
      });

      const examRecordInput: ExamRecordInput = {
        examType: this.examType,
        subjectId: this.subjectId,
        totalCount: this.questions.length,
        correctCount: correctCount,
        score: score,
        duration: duration,
        questionIds: questionIds,
        answers: answersArr.join(';')
      };
      await answerRecordService.saveExamRecord(examRecordInput);

      Logger.info('[ExamPage] Exam record saved');
    } catch (error) {
      Logger.error('[ExamPage] Failed to save exam record', error as Error);
    }
  }

  /**
   * è·å–é¢˜å‹åç§°
   */
  private getQuestionTypeName(type: QuestionType): string {
    switch (type) {
      case QuestionType.SINGLE: return 'å•é€‰é¢˜';
      case QuestionType.MULTIPLE: return 'å¤šé€‰é¢˜';
      case QuestionType.JUDGE: return 'åˆ¤æ–­é¢˜';
      default: return 'æœªçŸ¥';
    }
  }

  /**
   * è·å–å·²ç­”é¢˜æ•°
   */
  private getAnsweredCount(): number {
    return this.userAnswers.size;
  }


  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        if (!this.isStarted) {
          this.ExamIntro()
        } else {
          this.ExamContent()
        }
      }
      .width('100%')
      .height('100%')

      // ç­”é¢˜å¡å¼¹çª—
      if (this.showAnswerCard) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.showAnswerCard = false;
            })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })

        // ç­”é¢˜å¡å†…å®¹
        this.AnswerCardPanel()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.isDarkMode ? ThemeColors.BACKGROUND_DARK : ThemeColors.BACKGROUND)
    .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
  }

  /**
   * è€ƒè¯•ä»‹ç»é¡µ
   */
  @Builder
  ExamIntro() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Row() {
          Image($r('app.media.back'))
            .width(24)
            .height(24)
        }
        .width(40)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          Router.back();
        })

        Text('æ¨¡æ‹Ÿè€ƒè¯•')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: ThemeConstants.SPACING_SM, right: ThemeConstants.SPACING_SM })
      .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)

      // è€ƒè¯•ä¿¡æ¯å¡ç‰‡
      Column() {
        Text('ğŸ“‹')
          .fontSize(64)
          .margin({ top: ThemeConstants.SPACING_2XL })

        Text('æ¨¡æ‹Ÿè€ƒè¯•')
          .fontSize(ThemeConstants.FONT_SIZE_2XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .margin({ top: ThemeConstants.SPACING_MD })

        // è€ƒè¯•è§„åˆ™
        Column() {
          this.RuleItem('ğŸ“', 'é¢˜ç›®æ•°é‡', `${this.examConfig.totalQuestions} é¢˜`)
          this.RuleItem('â±ï¸', 'è€ƒè¯•æ—¶é—´', `${this.examConfig.timeLimit} åˆ†é’Ÿ`)
          this.RuleItem('âœ…', 'åŠæ ¼åˆ†æ•°', `${this.examConfig.passScore} åˆ†`)
          this.RuleItem('ğŸ¯', 'é¢˜å‹', 'å•é€‰ã€å¤šé€‰ã€åˆ¤æ–­')
        }
        .width('100%')
        .padding(ThemeConstants.SPACING_MD)
        .margin({ top: ThemeConstants.SPACING_LG, left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
        .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
        .borderRadius(ThemeConstants.RADIUS_MD)

        // æ³¨æ„äº‹é¡¹
        Column() {
          Text('æ³¨æ„äº‹é¡¹')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .width('100%')

          Text('1. è€ƒè¯•å¼€å§‹åè®¡æ—¶å™¨è‡ªåŠ¨å¯åŠ¨')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: ThemeConstants.SPACING_SM })

          Text('2. æ—¶é—´ç»“æŸè‡ªåŠ¨äº¤å·')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: ThemeConstants.SPACING_XS })

          Text('3. å¯éšæ—¶ç‚¹å‡»ç­”é¢˜å¡æŸ¥çœ‹è¿›åº¦')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: ThemeConstants.SPACING_XS })
        }
        .width('100%')
        .padding(ThemeConstants.SPACING_MD)
        .margin({ top: ThemeConstants.SPACING_SM, left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
        .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .alignItems(HorizontalAlign.Start)

        Blank()

        // å¼€å§‹æŒ‰é’®
        Button(this.isLoading ? 'åŠ è½½ä¸­...' : 'å¼€å§‹è€ƒè¯•')
          .width('90%')
          .height(48)
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(ThemeColors.PRIMARY)
          .borderRadius(ThemeConstants.RADIUS_BASE)
          .margin({ bottom: ThemeConstants.SPACING_2XL })
          .enabled(!this.isLoading)
          .onClick(() => {
            this.startExam();
          })
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  RuleItem(icon: string, label: string, value: string) {
    Row() {
      Text(icon)
        .fontSize(20)
        .width(32)

      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .layoutWeight(1)

      Text(value)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)
    }
    .width('100%')
    .padding({ top: ThemeConstants.SPACING_SM, bottom: ThemeConstants.SPACING_SM })
  }


  /**
   * è€ƒè¯•å†…å®¹é¡µ
   */
  @Builder
  ExamContent() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      this.ExamHeader()

      if (this.questions.length > 0) {
        // é¢˜ç›®å†…å®¹
        Scroll() {
          Column() {
            this.QuestionInfo()
            this.QuestionContent()
            this.OptionList()
          }
          .padding(ThemeConstants.SPACING_MD)
        }
        .layoutWeight(1)

        // åº•éƒ¨æ“ä½œæ 
        this.ExamBottomBar()
      } else {
        Column() {
          Text('æš‚æ— é¢˜ç›®')
            .fontSize(ThemeConstants.FONT_SIZE_LG)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  ExamHeader() {
    Row() {
      // è¿”å›/é€€å‡º
      Row() {
        Text('é€€å‡º')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.ERROR)
      }
      .padding({ left: 12, right: 12 })
      .onClick(() => {
        // TODO: æ·»åŠ ç¡®è®¤å¼¹çª—
        this.stopTimer();
        Router.back();
      })

      // è®¡æ—¶å™¨
      Row() {
        Text('â±ï¸')
          .fontSize(ThemeConstants.FONT_SIZE_MD)

        Text(this.formatTime(this.remainingTime))
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.remainingTime < 300 ? ThemeColors.ERROR : ThemeColors.TEXT_PRIMARY)
          .margin({ left: ThemeConstants.SPACING_XS })
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)

      // è¿›åº¦
      Text(`${this.getAnsweredCount()}/${this.questions.length}`)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .padding({ left: 12, right: 12 })
    }
    .width('100%')
    .height(56)
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
  }

  @Builder
  QuestionInfo() {
    Row() {
      Text(`ç¬¬ ${this.currentIndex + 1} é¢˜`)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.PRIMARY)
        .padding({ left: 8, right: 8, top: 2, bottom: 2 })
        .backgroundColor(ThemeColors.PRIMARY + '20')
        .borderRadius(4)

      Text(this.getQuestionTypeName(this.questions[this.currentIndex].type))
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.WHITE)
        .padding({ left: 8, right: 8, top: 2, bottom: 2 })
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(4)
        .margin({ left: ThemeConstants.SPACING_SM })
    }
    .width('100%')
  }

  @Builder
  QuestionContent() {
    Column() {
      Text(this.questions[this.currentIndex].content)
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .lineHeight(24)
    }
    .width('100%')
    .padding({ top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_MD })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  OptionList() {
    Column() {
      ForEach(this.questions[this.currentIndex].options, (option: QuestionOption) => {
        this.OptionItem(option)
      })
    }
    .width('100%')
  }

  @Builder
  OptionItem(option: QuestionOption) {
    Row() {
      Column() {
        Text(option.key)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.selectedOptions.includes(option.key) ? ThemeColors.WHITE : ThemeColors.TEXT_SECONDARY)
      }
      .width(32)
      .height(32)
      .borderRadius(16)
      .backgroundColor(this.selectedOptions.includes(option.key) ? ThemeColors.PRIMARY : ThemeColors.GRAY_100)
      .justifyContent(FlexAlign.Center)

      Text(option.content)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .margin({ left: ThemeConstants.SPACING_BASE })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_BASE)
    .margin({ top: ThemeConstants.SPACING_SM })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({
      width: 1,
      color: this.selectedOptions.includes(option.key) ? ThemeColors.PRIMARY : ThemeColors.BORDER
    })
    .onClick(() => {
      this.selectOption(option.key);
    })
  }

  @Builder
  ExamBottomBar() {
    Row() {
      Button('ä¸Šä¸€é¢˜')
        .width(90)
        .height(44)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(this.currentIndex > 0 ? ThemeColors.PRIMARY : ThemeColors.TEXT_DISABLED)
        .backgroundColor(ThemeColors.TRANSPARENT)
        .borderWidth(1)
        .borderColor(this.currentIndex > 0 ? ThemeColors.PRIMARY : ThemeColors.BORDER)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .enabled(this.currentIndex > 0)
        .onClick(() => {
          this.prevQuestion();
        })

      // ç­”é¢˜å¡æŒ‰é’®
      Button('ç­”é¢˜å¡')
        .width(90)
        .height(44)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .backgroundColor(ThemeColors.GRAY_100)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .onClick(() => {
          this.saveCurrentAnswer();
          this.showAnswerCard = true;
        })

      if (this.currentIndex < this.questions.length - 1) {
        Button('ä¸‹ä¸€é¢˜')
          .width(90)
          .height(44)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(ThemeColors.PRIMARY)
          .borderRadius(ThemeConstants.RADIUS_BASE)
          .onClick(() => {
            this.nextQuestion();
          })
      } else {
        Button('äº¤å·')
          .width(90)
          .height(44)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.WHITE)
          .backgroundColor(ThemeColors.SUCCESS)
          .borderRadius(ThemeConstants.RADIUS_BASE)
          .onClick(() => {
            this.submitExam();
          })
      }
    }
    .width('100%')
    .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_MD, bottom: 32 })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
    .justifyContent(FlexAlign.SpaceBetween)
  }

  /**
   * ç­”é¢˜å¡é¢æ¿
   */
  @Builder
  AnswerCardPanel() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ç­”é¢˜å¡')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Text('âœ•')
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontColor(ThemeColors.TEXT_HINT)
          .onClick(() => {
            this.showAnswerCard = false;
          })
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)

      // ç»Ÿè®¡ä¿¡æ¯
      Row() {
        this.CardStatItem('å·²ç­”', this.userAnswers.size, ThemeColors.PRIMARY)
        this.CardStatItem('æœªç­”', this.questions.length - this.userAnswers.size, ThemeColors.GRAY_400)
      }
      .width('100%')
      .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
      .justifyContent(FlexAlign.SpaceAround)

      // é¢˜ç›®ç½‘æ ¼
      Scroll() {
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
          ForEach(this.generateIndexArray(), (index: number) => {
            this.CardQuestionItem(index)
          })
        }
        .width('100%')
        .padding(ThemeConstants.SPACING_SM)
      }
      .layoutWeight(1)

      // å›¾ä¾‹
      Row() {
        this.CardLegendItem(ThemeColors.GRAY_200, 'æœªç­”')
        this.CardLegendItem(ThemeColors.PRIMARY, 'å·²ç­”')
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(ThemeColors.GRAY_50)
    }
    .width('100%')
    .height('60%')
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius({ topLeft: ThemeConstants.RADIUS_LG, topRight: ThemeConstants.RADIUS_LG })
  }

  /**
   * ç”Ÿæˆç´¢å¼•æ•°ç»„
   */
  private generateIndexArray(): number[] {
    const arr: number[] = [];
    for (let i = 0; i < this.questions.length; i++) {
      arr.push(i);
    }
    return arr;
  }

  @Builder
  CardStatItem(label: string, count: number, color: string) {
    Row() {
      Circle()
        .width(12)
        .height(12)
        .fill(color)

      Text(`${label}: ${count}`)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ left: ThemeConstants.SPACING_XS })
    }
  }

  @Builder
  CardQuestionItem(index: number) {
    Column() {
      Text(`${index + 1}`)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(this.isQuestionAnswered(index) ? ThemeColors.WHITE : ThemeColors.TEXT_SECONDARY)
    }
    .width(44)
    .height(44)
    .margin(4)
    .borderRadius(ThemeConstants.RADIUS_BASE)
    .backgroundColor(this.isQuestionAnswered(index) ? ThemeColors.PRIMARY : ThemeColors.GRAY_200)
    .border({
      width: this.currentIndex === index ? 2 : 0,
      color: ThemeColors.WARNING
    })
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.goToQuestion(index);
      this.showAnswerCard = false;
    })
  }

  /**
   * åˆ¤æ–­é¢˜ç›®æ˜¯å¦å·²ç­”
   */
  private isQuestionAnswered(index: number): boolean {
    if (index >= this.questions.length) return false;
    const question = this.questions[index];
    return this.userAnswers.has(question.id);
  }

  @Builder
  CardLegendItem(color: string, label: string) {
    Row() {
      Column()
        .width(16)
        .height(16)
        .borderRadius(4)
        .backgroundColor(color)

      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ left: ThemeConstants.SPACING_XXS })
    }
    .margin({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD })
  }
}
