/**
 * æˆ‘çš„å¡å†Œé¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { router } from '@kit.ArkUI';
import { KnowledgeCard, UserCard, CardRarity, CardFilter, DropStatistics, CardContentType } from '../common/types/CardTypes';
import { cardService } from '../services/CardService';
import { cardStatisticsService } from '../services/CardStatisticsService';
import { CardItem } from '../components/CardItem';
import { CardDetailPopup } from '../components/CardDetailPopup';

/**
 * é€‰é¡¹æ¥å£
 */
interface SelectOption {
  value: string;
  label: string;
}

@Entry
@Component
struct CardAlbumPage {
  @State userCards: UserCard[] = [];
  @State cardDefsMap: Map<string, KnowledgeCard> = new Map();
  @State sortBy: string = 'time';
  @State filterRarity: string = 'all';
  @State isLoading: boolean = true;
  @State showDetail: boolean = false;
  @State selectedCard: KnowledgeCard | null = null;
  @State selectedUserCard: UserCard | null = null;
  @State statistics: DropStatistics | null = null;
  @State todayDropCount: number = 0;

  private sortOptions: SelectOption[] = [];
  private rarityOptions: SelectOption[] = [];

  aboutToAppear() {
    this.initOptions();
    this.loadData();
  }

  initOptions() {
    this.sortOptions = [
      { value: 'time', label: 'è·å–æ—¶é—´' } as SelectOption,
      { value: 'rarity', label: 'ç¨€æœ‰åº¦' } as SelectOption,
      { value: 'star', label: 'æ˜Ÿçº§' } as SelectOption
    ];

    this.rarityOptions = [
      { value: 'all', label: 'å…¨éƒ¨' } as SelectOption,
      { value: 'N', label: 'N' } as SelectOption,
      { value: 'R', label: 'R' } as SelectOption,
      { value: 'SR', label: 'SR' } as SelectOption,
      { value: 'SSR', label: 'SSR' } as SelectOption
    ];
  }

  async loadData() {
    this.isLoading = true;
    try {
      // åŠ è½½å¡ç‰‡å®šä¹‰
      const allDefs = cardService.getAllCardDefinitions();
      this.cardDefsMap = new Map<string, KnowledgeCard>();
      for (const c of allDefs) {
        this.cardDefsMap.set(c.id, c);
      }
      
      // åŠ è½½ç”¨æˆ·å¡ç‰‡
      await this.loadUserCards();
      
      // åŠ è½½ç»Ÿè®¡æ•°æ®
      this.statistics = await cardStatisticsService.getDropStatistics();
      this.todayDropCount = await cardStatisticsService.getTodayDropCount();
    } catch (error) {
      console.error('Failed to load data', error);
    }
    this.isLoading = false;
  }

  async loadUserCards() {
    const filter: CardFilter = {
      sortBy: this.sortBy as 'time' | 'rarity' | 'star',
      sortOrder: 'desc'
    };
    
    if (this.filterRarity !== 'all') {
      filter.rarity = this.filterRarity as CardRarity;
    }
    
    this.userCards = await cardService.filterUserCards(filter);
  }

  // è·å–ç¨€æœ‰åº¦é¢œè‰²
  getRarityColor(rarity: string): string {
    switch (rarity) {
      case 'N': return '#9E9E9E';
      case 'R': return '#2196F3';
      case 'SR': return '#9C27B0';
      case 'SSR': return '#FF9800';
      default: return '#666666';
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now.getTime() - timestamp;
    
    if (diff < 60000) return 'åˆšåˆš';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
    if (diff < 604800000) return `${Math.floor(diff / 86400000)}å¤©å‰`;
    
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Image("")
            .width(24)
            .height(24)
            .fillColor('#FFFFFF')
            .onClick(() => router.back())

          Text('')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .margin({ left: 16 })

          Blank()

          // å›¾é‰´å…¥å£
          Text('')
            .fontSize(14)
            .fontColor('#FFD700')
            .onClick(() => {
              router.pushUrl({ url: 'pages/CardCollectionPage' });
            })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#1a1a2e')

        // ç»Ÿè®¡ä¿¡æ¯
        Row() {
          // å¡ç‰‡æ•°é‡
          Column() {
            Text(`${this.userCards.length}`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFD700')
            Text('å·²æ”¶é›†')
              .fontSize(12)
              .fontColor('rgba(255,255,255,0.5)')
          }
          .layoutWeight(1)

          // ä»Šæ—¥è·å¾—
          Column() {
            Text(`${this.todayDropCount}`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#4CAF50')
            Text('ä»Šæ—¥è·å¾—')
              .fontSize(12)
              .fontColor('rgba(255,255,255,0.5)')
          }
          .layoutWeight(1)

          // æ¬§æ°”å€¼
          Column() {
            Text(`${this.statistics?.luckValue || 50}`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#E040FB')
            Text('æ¬§æ°”å€¼')
              .fontSize(12)
              .fontColor('rgba(255,255,255,0.5)')
          }
          .layoutWeight(1)

          // æ€»æ‰è½
          Column() {
            Text(`${this.statistics?.totalDrops || 0}`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2196F3')
            Text('æ€»æ‰è½')
              .fontSize(12)
              .fontColor('rgba(255,255,255,0.5)')
          }
          .layoutWeight(1)
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#252540')

        // ç­›é€‰å’Œæ’åºæ 
        Row() {
          // ç¨€æœ‰åº¦ç­›é€‰
          Row() {
            ForEach(this.rarityOptions, (item: SelectOption) => {
              Text(item.label)
                .fontSize(11)
                .fontColor(this.filterRarity === item.value ? '#FFFFFF' : 'rgba(255,255,255,0.5)')
                .backgroundColor(this.filterRarity === item.value ? this.getRarityColor(item.value) : 'transparent')
                .padding({ left: 8, right: 8, top: 3, bottom: 3 })
                .borderRadius(10)
                .margin({ right: 6 })
                .onClick(() => {
                  this.filterRarity = item.value;
                  this.loadUserCards();
                })
            })
          }

          Blank()

          // æ’åºé€‰æ‹©
          Row() {
            Text('æ’åº:')
              .fontSize(11)
              .fontColor('rgba(255,255,255,0.5)')
            ForEach(this.sortOptions, (item: SelectOption) => {
              Text(item.label)
                .fontSize(11)
                .fontColor(this.sortBy === item.value ? '#FFD700' : 'rgba(255,255,255,0.5)')
                .margin({ left: 8 })
                .onClick(() => {
                  this.sortBy = item.value;
                  this.loadUserCards();
                })
            })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })

        // å¡ç‰‡åˆ—è¡¨
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#FFD700')
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('rgba(255,255,255,0.5)')
              .margin({ top: 12 })
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
        } else if (this.userCards.length === 0) {
          Column() {
            Text('ğŸ´')
              .fontSize(60)
              .opacity(0.3)
            Text('è¿˜æ²¡æœ‰æ”¶é›†åˆ°å¡ç‰‡')
              .fontSize(14)
              .fontColor('rgba(255,255,255,0.5)')
              .margin({ top: 12 })
            Text('ç­”é¢˜æœ‰æœºä¼šè·å¾—å¡ç‰‡å“¦~')
              .fontSize(12)
              .fontColor('rgba(255,255,255,0.3)')
              .margin({ top: 4 })
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
        } else {
          List() {
            ForEach(this.userCards, (userCard: UserCard) => {
              ListItem() {
                this.CardListItem(userCard)
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, bottom: 20 })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#1a1a2e')

      // å¡ç‰‡è¯¦æƒ…å¼¹çª—
      if (this.showDetail && this.selectedCard) {
        CardDetailPopup({
          cardDef: this.selectedCard,
          userCard: this.selectedUserCard,
          onClose: () => {
            this.showDetail = false;
            this.selectedCard = null;
            this.selectedUserCard = null;
          }
        })
      }
    }
  }

  @Builder
  CardListItem(userCard: UserCard) {
    Row() {
      // çœŸå®å¡ç‰‡ç¼©ç•¥å›¾
      CardItem({
        cardDef: this.cardDefsMap.get(userCard.cardId) || this.getDefaultCard(userCard.cardId),
        userCard: userCard,
        isCollected: true,
        onCardClick: () => {
          const cardDef = this.cardDefsMap.get(userCard.cardId);
          if (cardDef) {
            this.selectedCard = cardDef;
            this.selectedUserCard = userCard;
            this.showDetail = true;
          }
        }
      })

      // å¡ç‰‡ä¿¡æ¯
      Column() {
        Row() {
          Text(this.cardDefsMap.get(userCard.cardId)?.name || 'æœªçŸ¥å¡ç‰‡')
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
          
          Text(this.cardDefsMap.get(userCard.cardId)?.rarity || 'N')
            .fontSize(10)
            .fontColor('#FFFFFF')
            .backgroundColor(this.getRarityColor(this.cardDefsMap.get(userCard.cardId)?.rarity || 'N'))
            .padding({ left: 4, right: 4, top: 1, bottom: 1 })
            .borderRadius(2)
            .margin({ left: 8 })
        }

        // æ˜Ÿçº§
        Row() {
          ForEach([1, 2, 3, 4, 5], (star: number) => {
            Text(star <= userCard.starLevel ? 'â˜…' : 'â˜†')
              .fontSize(12)
              .fontColor(star <= userCard.starLevel ? '#FFD700' : '#666666')
          })
          
          if (userCard.starLevel >= 5) {
            Text('MAX')
              .fontSize(8)
              .fontColor('#FFFFFF')
              .backgroundColor('#FF5722')
              .padding({ left: 3, right: 3, top: 1, bottom: 1 })
              .borderRadius(2)
              .margin({ left: 4 })
          }
        }
        .margin({ top: 4 })

        // ç¢ç‰‡è¿›åº¦
        Row() {
          Text(`ç¢ç‰‡: ${userCard.fragments}`)
            .fontSize(11)
            .fontColor('rgba(255,255,255,0.5)')
          
          Text(`è·å–: ${userCard.obtainCount}æ¬¡`)
            .fontSize(11)
            .fontColor('rgba(255,255,255,0.5)')
            .margin({ left: 12 })
        }
        .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)

      // è·å–æ—¶é—´
      Text(this.formatTime(userCard.lastObtainTime))
        .fontSize(11)
        .fontColor('rgba(255,255,255,0.3)')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#252540')
    .borderRadius(12)
    .margin({ bottom: 8 })
  }

  // è·å–é»˜è®¤å¡ç‰‡å®šä¹‰
  private getDefaultCard(cardId: string): KnowledgeCard {
    const defaultCard: KnowledgeCard = {
      id: cardId,
      name: 'æœªçŸ¥å¡ç‰‡',
      rarity: CardRarity.N,
      subjectId: 'unknown',
      contentType: CardContentType.KNOWLEDGE,
      frontImage: '',
      backContent: '',
      questionAnalysis: '',
      isLimited: false
    };
    return defaultCard;
  }
}
