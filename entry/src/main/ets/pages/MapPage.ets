/**
 * é«˜å¾·åœ°å›¾é¡µé¢
 * ä½¿ç”¨é«˜å¾·åœ°å›¾åŸç”Ÿ SDK æ˜¾ç¤ºåœ°å›¾å’Œå½“å‰ä½ç½®
 */
import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';
import { geoLocationManager } from '@kit.LocationKit';
import {
  AMap,
  MapsInitializer,
  MapView,
  MapViewComponent,
  MapViewManager,
  Marker,
  MarkerOptions,
  LatLng,
  CameraUpdateFactory
} from '@amap/amap_lbs_map3d';
import { ThemeColors, ThemeConstants } from '../common/constants/ThemeConstants';
import { amapLocationService, LocationInfo } from '../services/AMapLocationService';
import { Logger } from '../common/utils/Logger';

// é«˜å¾· API Key
const AMAP_KEY = '6f356712f041528b048e8e12d23043bd';

@Entry
@Component
struct MapPage {
  @State isLoading: boolean = true;
  @State locationInfo: LocationInfo | null = null;
  @State hasPermission: boolean = false;
  @State errorMessage: string = '';
  @State isMapReady: boolean = false;
  @State debugInfo: string = 'åˆå§‹åŒ–ä¸­...';

  private aMap: AMap | null = null;
  private mapView: MapView | null = null;
  private locationMarker: Marker | null = null;

  aboutToAppear(): void {
    Logger.info('[MapPage] aboutToAppear - å¼€å§‹åˆå§‹åŒ–');
    this.debugInfo = 'è®¾ç½®API Key...';
    
    try {
      // åˆå§‹åŒ–é«˜å¾·åœ°å›¾ Key
      MapsInitializer.setApiKey(AMAP_KEY);
      Logger.info('[MapPage] API Key è®¾ç½®æˆåŠŸ: ' + AMAP_KEY);
      this.debugInfo = 'API Keyå·²è®¾ç½®ï¼Œæ³¨å†Œåœ°å›¾å›è°ƒ...';
    } catch (error) {
      const err = error as Error;
      Logger.error('[MapPage] è®¾ç½®API Keyå¤±è´¥: ' + err.message);
      this.debugInfo = 'è®¾ç½®API Keyå¤±è´¥: ' + err.message;
      this.errorMessage = 'åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + err.message;
    }

    // æ³¨å†Œåœ°å›¾åˆ›å»ºå›è°ƒ
    try {
      MapViewManager.getInstance().registerMapViewCreatedCallback(
        (mapview?: MapView, mapViewName?: string) => {
          Logger.info('[MapPage] åœ°å›¾å›è°ƒè§¦å‘, mapview: ' + (mapview ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
          this.debugInfo = 'åœ°å›¾å›è°ƒè§¦å‘...';
          
          if (!mapview) {
            Logger.error('[MapPage] mapview ä¸ºç©º');
            this.debugInfo = 'é”™è¯¯: mapviewä¸ºç©º';
            this.errorMessage = 'åœ°å›¾åˆ›å»ºå¤±è´¥';
            this.isLoading = false;
            return;
          }
          
          this.mapView = mapview;
          Logger.info('[MapPage] è°ƒç”¨ mapView.onCreate()');
          this.debugInfo = 'è°ƒç”¨onCreate...';
          
          try {
            this.mapView.onCreate();
            Logger.info('[MapPage] onCreate æˆåŠŸï¼Œè°ƒç”¨ getMapAsync');
            this.debugInfo = 'è·å–AMapå¯¹è±¡...';
            
            this.mapView.getMapAsync((map: AMap) => {
              Logger.info('[MapPage] getMapAsync å›è°ƒ, map: ' + (map ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
              this.aMap = map;
              this.isMapReady = true;
              this.debugInfo = 'åœ°å›¾å‡†å¤‡å°±ç»ª!';
              Logger.info('[MapPage] åœ°å›¾å‡†å¤‡å°±ç»ª');
              // åœ°å›¾å‡†å¤‡å¥½åè·å–ä½ç½®
              this.initLocation();
            });
          } catch (error) {
            const err = error as Error;
            Logger.error('[MapPage] åœ°å›¾åˆå§‹åŒ–å¼‚å¸¸: ' + err.message);
            this.debugInfo = 'åœ°å›¾åˆå§‹åŒ–å¼‚å¸¸: ' + err.message;
            this.errorMessage = 'åœ°å›¾åˆå§‹åŒ–å¼‚å¸¸';
            this.isLoading = false;
          }
        }
      );
      Logger.info('[MapPage] åœ°å›¾å›è°ƒæ³¨å†ŒæˆåŠŸ');
    } catch (error) {
      const err = error as Error;
      Logger.error('[MapPage] æ³¨å†Œåœ°å›¾å›è°ƒå¤±è´¥: ' + err.message);
      this.debugInfo = 'æ³¨å†Œå›è°ƒå¤±è´¥: ' + err.message;
      this.errorMessage = 'åœ°å›¾æœåŠ¡ä¸å¯ç”¨';
      this.isLoading = false;
    }
  }

  aboutToDisappear(): void {
    Logger.info('[MapPage] aboutToDisappear - æ¸…ç†èµ„æº');
    if (this.mapView) {
      try {
        this.mapView.onDestroy();
        Logger.info('[MapPage] mapView.onDestroy æˆåŠŸ');
      } catch (error) {
        Logger.error('[MapPage] mapView.onDestroy å¤±è´¥', error as Error);
      }
    }
  }

  private async initLocation(): Promise<void> {
    Logger.info('[MapPage] initLocation å¼€å§‹');
    this.debugInfo = 'æ£€æŸ¥å®šä½æƒé™...';
    
    try {
      // æ£€æŸ¥æƒé™
      this.hasPermission = await amapLocationService.checkLocationPermission();
      Logger.info('[MapPage] å®šä½æƒé™æ£€æŸ¥ç»“æœ: ' + this.hasPermission);

      if (!this.hasPermission) {
        Logger.info('[MapPage] è¯·æ±‚å®šä½æƒé™');
        this.debugInfo = 'è¯·æ±‚å®šä½æƒé™...';
        const context = getContext(this) as common.UIAbilityContext;
        this.hasPermission = await amapLocationService.requestLocationPermission(context);
        Logger.info('[MapPage] æƒé™è¯·æ±‚ç»“æœ: ' + this.hasPermission);
      }

      if (!this.hasPermission) {
        Logger.warn('[MapPage] ç”¨æˆ·æ‹’ç»å®šä½æƒé™');
        this.errorMessage = 'éœ€è¦å®šä½æƒé™æ‰èƒ½æ˜¾ç¤ºå½“å‰ä½ç½®';
        this.debugInfo = 'å®šä½æƒé™è¢«æ‹’ç»';
        this.isLoading = false;
        return;
      }

      // è·å–ä½ç½®
      Logger.info('[MapPage] å¼€å§‹è·å–ä½ç½®');
      this.debugInfo = 'è·å–å½“å‰ä½ç½®...';
      const location = await amapLocationService.getCurrentLocation();
      
      if (location) {
        Logger.info('[MapPage] è·å–ä½ç½®æˆåŠŸ: ' + location.latitude + ', ' + location.longitude);
        this.locationInfo = location;
        this.debugInfo = 'ä½ç½®: ' + location.latitude.toFixed(4) + ', ' + location.longitude.toFixed(4);
        this.updateMapLocation(location);
      } else {
        Logger.error('[MapPage] è·å–ä½ç½®å¤±è´¥');
        this.errorMessage = 'è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æœåŠ¡æ˜¯å¦å¼€å¯';
        this.debugInfo = 'è·å–ä½ç½®å¤±è´¥';
      }
    } catch (error) {
      const err = error as Error;
      Logger.error('[MapPage] initLocation å¼‚å¸¸: ' + err.message);
      this.errorMessage = 'å®šä½æœåŠ¡å¼‚å¸¸: ' + err.message;
      this.debugInfo = 'å®šä½å¼‚å¸¸: ' + err.message;
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ›´æ–°åœ°å›¾ä½ç½®å’Œæ ‡è®°
   */
  private updateMapLocation(location: LocationInfo): void {
    Logger.info('[MapPage] updateMapLocation å¼€å§‹');
    
    if (!this.aMap) {
      Logger.error('[MapPage] aMap ä¸ºç©ºï¼Œæ— æ³•æ›´æ–°ä½ç½®');
      this.debugInfo = 'é”™è¯¯: åœ°å›¾å¯¹è±¡ä¸ºç©º';
      return;
    }

    try {
      const latLng = new LatLng(location.latitude, location.longitude);
      Logger.info('[MapPage] åˆ›å»º LatLng æˆåŠŸ');

      // ç§»åŠ¨åœ°å›¾åˆ°å½“å‰ä½ç½®
      this.aMap.moveCamera(CameraUpdateFactory.newLatLngZoom(latLng, 16));
      Logger.info('[MapPage] moveCamera æˆåŠŸ');

      // ç§»é™¤æ—§æ ‡è®°
      if (this.locationMarker) {
        this.locationMarker.remove();
        Logger.info('[MapPage] ç§»é™¤æ—§æ ‡è®°');
      }

      // æ·»åŠ æ–°æ ‡è®°
      const markerOptions = new MarkerOptions();
      markerOptions.position(latLng);
      markerOptions.title('å½“å‰ä½ç½®');
      if (location.formattedAddress) {
        markerOptions.snippet(location.formattedAddress);
      }

      this.locationMarker = this.aMap.addMarker(markerOptions);
      Logger.info('[MapPage] æ·»åŠ æ ‡è®°æˆåŠŸ');

      // æ˜¾ç¤ºä¿¡æ¯çª—å£
      if (this.locationMarker) {
        this.locationMarker.showInfoWindow();
        Logger.info('[MapPage] æ˜¾ç¤ºä¿¡æ¯çª—å£');
      }

      this.debugInfo = 'åœ°å›¾æ›´æ–°å®Œæˆ';
    } catch (error) {
      const err = error as Error;
      Logger.error('[MapPage] updateMapLocation å¼‚å¸¸: ' + err.message);
      this.debugInfo = 'æ›´æ–°åœ°å›¾å¼‚å¸¸: ' + err.message;
    }
  }

  /**
   * åˆ·æ–°ä½ç½®
   */
  private async refreshLocation(): Promise<void> {
    Logger.info('[MapPage] refreshLocation å¼€å§‹');
    this.isLoading = true;
    this.errorMessage = '';
    this.debugInfo = 'åˆ·æ–°ä½ç½®...';

    try {
      const location = await amapLocationService.getCurrentLocation();
      if (location) {
        this.locationInfo = location;
        this.updateMapLocation(location);
        promptAction.showToast({ message: 'ä½ç½®å·²æ›´æ–°' });
        Logger.info('[MapPage] ä½ç½®åˆ·æ–°æˆåŠŸ');
      } else {
        promptAction.showToast({ message: 'è·å–ä½ç½®å¤±è´¥' });
        Logger.error('[MapPage] ä½ç½®åˆ·æ–°å¤±è´¥');
      }
    } catch (error) {
      Logger.error('[MapPage] refreshLocation å¼‚å¸¸', error as Error);
    }

    this.isLoading = false;
  }

  /**
   * å›åˆ°å½“å‰ä½ç½®
   */
  private backToCurrentLocation(): void {
    if (this.locationInfo && this.aMap) {
      const latLng = new LatLng(this.locationInfo.latitude, this.locationInfo.longitude);
      this.aMap.animateCamera(CameraUpdateFactory.newLatLngZoom(latLng, 16));
      Logger.info('[MapPage] å›åˆ°å½“å‰ä½ç½®');
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.Back'))
          .width(24)
          .height(24)
          .onClick(() => router.back())

        Text('æˆ‘çš„ä½ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Image($r('app.media.Refresh'))
          .width(24)
          .height(24)
          .onClick(() => this.refreshLocation())
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(ThemeColors.SURFACE)

      // è°ƒè¯•ä¿¡æ¯
      Row() {
        Text('è°ƒè¯•: ' + this.debugInfo)
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_HINT)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .padding(8)
      .backgroundColor('#FFF3E0')

      // ä½ç½®ä¿¡æ¯å¡ç‰‡
      if (this.locationInfo && !this.isLoading) {
        Row() {
          Column() {
            Text('ğŸ“ ' + (this.locationInfo.formattedAddress || 'æœªçŸ¥ä½ç½®'))
              .fontSize(14)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            Row() {
              Text(`ç»åº¦: ${this.locationInfo.longitude.toFixed(6)}`)
                .fontSize(12)
                .fontColor(ThemeColors.TEXT_HINT)
              Text(`  çº¬åº¦: ${this.locationInfo.latitude.toFixed(6)}`)
                .fontSize(12)
                .fontColor(ThemeColors.TEXT_HINT)
            }
            .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding(12)
        .backgroundColor(ThemeColors.SURFACE)
        .border({ width: { bottom: 1 }, color: ThemeColors.GRAY_200 })
      }

      // åœ°å›¾åŒºåŸŸ
      Stack() {
        // é«˜å¾·åœ°å›¾ç»„ä»¶
        MapViewComponent()
          .width('100%')
          .height('100%')

        // åŠ è½½ä¸­é®ç½©
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(48)
              .height(48)
              .color(ThemeColors.PRIMARY)
            Text('æ­£åœ¨åŠ è½½...')
              .fontSize(14)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .margin({ top: 12 })
            Text(this.debugInfo)
              .fontSize(12)
              .fontColor(ThemeColors.TEXT_HINT)
              .margin({ top: 8 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255, 255, 255, 0.9)')
        }

        // é”™è¯¯æç¤º
        if (this.errorMessage && !this.isLoading) {
          Column() {
            Text('ğŸ˜•')
              .fontSize(48)
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .margin({ top: 12 })
              .textAlign(TextAlign.Center)
            Text(this.debugInfo)
              .fontSize(12)
              .fontColor(ThemeColors.TEXT_HINT)
              .margin({ top: 8 })

            Button('é‡è¯•')
              .fontSize(14)
              .fontColor(ThemeColors.WHITE)
              .backgroundColor(ThemeColors.PRIMARY)
              .margin({ top: 20 })
              .onClick(() => this.initLocation())
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255, 255, 255, 0.95)')
        }

        // å›åˆ°å½“å‰ä½ç½®æŒ‰é’®
        if (this.locationInfo && !this.isLoading && !this.errorMessage) {
          Column() {
            Text('ğŸ“')
              .fontSize(20)
          }
          .width(44)
          .height(44)
          .borderRadius(22)
          .backgroundColor(ThemeColors.SURFACE)
          .justifyContent(FlexAlign.Center)
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.15)', offsetX: 0, offsetY: 2 })
          .position({ x: '85%', y: '80%' })
          .onClick(() => this.backToCurrentLocation())
        }
      }
      .layoutWeight(1)
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BACKGROUND)
  }
}
