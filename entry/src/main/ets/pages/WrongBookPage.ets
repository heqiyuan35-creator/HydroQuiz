/**
 * é”™é¢˜æœ¬é¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { answerRecordService, TodayStatistics } from '../services/AnswerRecordService';
import { questionService } from '../services/QuestionService';
import { WrongQuestion, Question, AnswerRecord } from '../common/types/QuestionTypes';
import { getSubjectShortName, getSubjectColor, SUBJECT_LIST } from '../data/SubjectData';
import { SubjectInfo } from '../common/types/QuestionTypes';
import { Logger } from '../common/utils/Logger';
import { curves, AnimatorOptions, AnimatorResult } from '@kit.ArkUI';
import { AppConstants } from '../common/constants/AppConstants';

/**
 * é”™é¢˜æ˜¾ç¤ºé¡¹ - ä½¿ç”¨ @Observed å®ç°å•é¡¹çŠ¶æ€è¿½è¸ª
 */
@Observed
class WrongQuestionItem {
  wrong: WrongQuestion;
  question: Question;
  // åŠ¨ç”»çŠ¶æ€
  translateX: number = 0;
  translateY: number = 0;
  scaleVal: number = 1;
  rotateAngle: number = 0;
  opacityVal: number = 1;
  // é€‰ä¸­çŠ¶æ€
  isSelected: boolean = false;

  constructor(wrong: WrongQuestion, question: Question) {
    this.wrong = wrong;
    this.question = question;
  }
}

// å…¥åœºåŠ¨ç”»å¸¸é‡
const ENTRY_INTERVAL: number = 30; // æ¯ä¸ªå…ƒç´ çš„å»¶è¿Ÿé—´éš”
const ENTRY_DURATION: number = 300; // å…¥åœºåŠ¨ç”»æ—¶é•¿

// æ’åºé€‰é¡¹
interface SortOption {
  id: string;
  name: string;
}

const SORT_OPTIONS: SortOption[] = [
  { id: 'time_desc', name: 'æœ€è¿‘é”™è¯¯' },
  { id: 'time_asc', name: 'æœ€æ—©é”™è¯¯' },
  { id: 'count_desc', name: 'é”™è¯¯æœ€å¤š' },
  { id: 'count_asc', name: 'é”™è¯¯æœ€å°‘' }
];

// åˆ é™¤åŒºåŸŸé…ç½®
const DELETE_ZONE_HEIGHT: number = 100; // åˆ é™¤åŒºåŸŸé«˜åº¦
const DELETE_ZONE_THRESHOLD: number = 0.7; // å±å¹•é«˜åº¦æ¯”ä¾‹ï¼Œè¶…è¿‡æ­¤ä½ç½®è¿›å…¥åˆ é™¤åŒºåŸŸ

/**
 * é”™é¢˜é¡¹åŒ…è£…ç»„ä»¶ - ç”¨äºè¿½è¸ªåŠ¨ç”»çŠ¶æ€
 */
@Component
struct WrongItemAnimWrapper {
  @ObjectLink item: WrongQuestionItem;
  @Prop index: number = 0;
  @Prop isDragging: boolean = false;
  @BuilderParam content: () => void;

  build() {
    Column() {
      if (this.content) {
        this.content()
      }
    }
    // é£èµ°/æ‹–æ‹½åŠ¨ç”»ï¼šä½¿ç”¨æ˜¾å¼åŠ¨ç”»å±æ€§
    .translate({ x: this.item.translateX, y: this.item.translateY })
    .scale({ x: this.item.scaleVal, y: this.item.scaleVal })
    .rotate({ angle: this.item.rotateAngle })
    .opacity(this.item.opacityVal)
    // æ‹–æ‹½æ—¶æå‡å±‚çº§
    .zIndex(this.isDragging ? 999 : 0)
    // å…¥åœºåŠ¨ç”»ï¼šä½¿ç”¨ transition
    .transition(
      TransitionEffect.OPACITY
        .combine(TransitionEffect.scale({ x: 0.5, y: 0.5 }))
        .animation({ duration: ENTRY_DURATION, curve: Curve.Friction, delay: ENTRY_INTERVAL * this.index })
    )
  }
}

@Entry
@Component
struct WrongBookPage {
  @State isDarkMode: boolean = false;
  @State isLoading: boolean = true;
  @State wrongItems: WrongQuestionItem[] = [];
  @State allWrongItems: WrongQuestionItem[] = []; // åŸå§‹æ•°æ®ï¼ˆç”¨äºç­›é€‰ï¼‰
  @State filterMode: string = 'all'; // 'all' | 'today'
  @State pageTitle: string = 'é”™é¢˜æœ¬';
  @State showList: boolean = false; // æ§åˆ¶åˆ—è¡¨å…¥åœºåŠ¨ç”»
  @State selectedSubject: string = 'all'; // ç§‘ç›®ç­›é€‰
  @State selectedSort: string = 'time_desc'; // æ’åºæ–¹å¼
  @State showFilterPanel: boolean = false; // æ˜¾ç¤ºç­›é€‰é¢æ¿
  @State isSelectMode: boolean = false; // å¤šé€‰æ¨¡å¼
  @State selectedCount: number = 0; // é€‰ä¸­æ•°é‡

  // æ‹–æ‹½åˆ é™¤ç›¸å…³çŠ¶æ€
  @State isDragging: boolean = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½
  @State draggingItemId: string = ''; // æ­£åœ¨æ‹–æ‹½çš„é¡¹ç›®ID
  @State isInDeleteZone: boolean = false; // æ˜¯å¦åœ¨åˆ é™¤åŒºåŸŸ
  @State showDeleteZone: boolean = false; // æ˜¯å¦æ˜¾ç¤ºåˆ é™¤åŒºåŸŸ
  @State deleteZoneScale: number = 1; // åˆ é™¤åŒºåŸŸç¼©æ”¾

  // è®°å½•å½“å‰æ­£åœ¨ç»ƒä¹ çš„é¢˜ç›®ID
  private currentPracticeQuestionId: string = '';
  // æ˜¯å¦ä»ç­”é¢˜é¡µè¿”å›ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å…¥åœºåŠ¨ç”»ï¼‰
  private isReturningFromPractice: boolean = false;

  aboutToAppear(): void {
    // è·å–è·¯ç”±å‚æ•°
    const params: RouteParams = Router.getParams();
    if (params['filter'] === 'today') {
      this.filterMode = 'today';
      this.pageTitle = 'ä»Šæ—¥é”™é¢˜';
    }
    this.loadWrongQuestions();
  }

  onPageShow(): void {
    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦æœ‰é¢˜ç›®éœ€è¦å¤„ç†
    if (this.currentPracticeQuestionId) {
      this.isReturningFromPractice = true;
      this.checkAnswerResult(this.currentPracticeQuestionId);
      this.currentPracticeQuestionId = '';
    } else {
      // æ™®é€šåˆ·æ–°
      this.loadWrongQuestions();
    }
  }

  /**
   * æ£€æŸ¥ç­”é¢˜ç»“æœ
   */
  private async checkAnswerResult(questionId: string): Promise<void> {
    try {
      // è·å–è¯¥é¢˜ç›®æœ€æ–°çš„ç­”é¢˜è®°å½•
      const records = await answerRecordService.getRecordsByQuestionId(questionId);
      if (records.length > 0) {
        const latestRecord = records[0]; // æœ€æ–°çš„è®°å½•
        if (latestRecord.isCorrect) {
          // ç­”å¯¹äº†ï¼Œè§¦å‘é£èµ°åŠ¨ç”»å¹¶åˆ é™¤
          this.flyAwayAndRemove(questionId);
        } else {
          // ç­”é”™äº†ï¼Œåˆ·æ–°åˆ—è¡¨ï¼ˆé”™è¯¯æ¬¡æ•°å·²åœ¨ç­”é¢˜æ—¶æ›´æ–°ï¼‰
          this.loadWrongQuestions();
        }
      }
    } catch (error) {
      Logger.error('[WrongBookPage] Failed to check answer result', error as Error);
      this.loadWrongQuestions();
    }
  }

  /**
   * è§¦å‘é£èµ°åŠ¨ç”»å¹¶åˆ é™¤é¢˜ç›®
   * åŠ¨ç”»æ•ˆæœï¼šå…ˆå‘å³ç§»åŠ¨80pxï¼Œå†å‘å·¦æ»‘å‡ºå±å¹•
   */
  private async flyAwayAndRemove(questionId: string): Promise<void> {
    // æ ‡è®°ä¸ºå·²æŒæ¡
    await answerRecordService.markAsMastered(questionId);

    // æ‰¾åˆ°è¦é£èµ°çš„å…ƒç´ 
    const targetItem = this.wrongItems.find((i: WrongQuestionItem) => i.question.id === questionId);
    if (!targetItem) return;

    // é˜¶æ®µ1ï¼šå‘å³ç§»åŠ¨80pxï¼ˆå¼¹æ€§æ•ˆæœï¼‰
    const phase1Duration = 300;
    const phase2Duration = 400;
    const rightOffset = 80;
    const leftOffset = -500; // å‘å·¦æ»‘å‡ºå±å¹•

    // åˆ›å»ºåŠ¨ç”»å™¨å®ç°ä¸¤é˜¶æ®µåŠ¨ç”»
    const animatorOption: AnimatorOptions = {
      duration: phase1Duration + phase2Duration,
      delay: 0,
      easing: 'linear',
      iterations: 1,
      fill: 'forwards',
      direction: 'normal',
      begin: 0,
      end: 100 // ç”¨ç™¾åˆ†æ¯”æ§åˆ¶è¿›åº¦
    };

    const animator: AnimatorResult | undefined = this.getUIContext()?.createAnimator(animatorOption);
    if (!animator) return;

    animator.onFrame = (progress: number) => {
      // progress: 0 -> 100
      const phase1End = (phase1Duration / (phase1Duration + phase2Duration)) * 100; // çº¦42.8

      if (progress <= phase1End) {
        // é˜¶æ®µ1ï¼šå‘å³ç§»åŠ¨ï¼Œä½¿ç”¨ç¼“å‡ºæ•ˆæœ
        const phase1Progress = progress / phase1End; // 0 -> 1
        const easeOut = 1 - Math.pow(1 - phase1Progress, 3); // cubic ease out
        targetItem.translateX = rightOffset * easeOut;
        targetItem.opacityVal = 1;
      } else {
        // é˜¶æ®µ2ï¼šå‘å·¦æ»‘å‡º
        const phase2Progress = (progress - phase1End) / (100 - phase1End); // 0 -> 1
        const easeIn = Math.pow(phase2Progress, 2); // quadratic ease in
        targetItem.translateX = rightOffset + (leftOffset - rightOffset) * easeIn;
        targetItem.opacityVal = 1 - phase2Progress * 0.5; // é€æ¸å˜æ·¡
      }
    };

    animator.onFinish = () => {
      // åŠ¨ç”»å®Œæˆåä»åˆ—è¡¨ä¸­ç§»é™¤
      this.wrongItems = this.wrongItems.filter((i: WrongQuestionItem) => i.question.id !== questionId);
    };

    // æ’­æ”¾åŠ¨ç”»
    animator.play();
  }

  /**
   * åŠ è½½é”™é¢˜åˆ—è¡¨
   */
  private async loadWrongQuestions(): Promise<void> {
    try {
      let wrongList: WrongQuestion[];

      if (this.filterMode === 'today') {
        wrongList = await answerRecordService.getTodayWrongQuestions();
      } else {
        wrongList = await answerRecordService.getWrongQuestions();
      }

      const items: WrongQuestionItem[] = [];

      for (const wrong of wrongList) {
        const question = await questionService.getQuestionById(wrong.questionId);
        if (question) {
          items.push(new WrongQuestionItem(wrong, question));
        }
      }

      // ä¿å­˜åŸå§‹æ•°æ®
      this.allWrongItems = items;
      Logger.info(`[WrongBookPage] Loaded ${items.length} wrong questions (filter: ${this.filterMode})`);

      // åº”ç”¨ç­›é€‰å’Œæ’åº
      this.applyFilterAndSort();
    } catch (error) {
      Logger.error('[WrongBookPage] Failed to load wrong questions', error as Error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è§¦å‘å…¥åœºåŠ¨ç”»
   */
  private triggerEntryAnimation(): void {
    const itemCount = this.wrongItems.length;
    if (itemCount === 0) return;

    this.getUIContext()?.animateTo({
      duration: ENTRY_DURATION + ENTRY_INTERVAL * (itemCount - 1),
      curve: Curve.Friction
    }, () => {
      this.showList = true;
    });
  }

  /**
   * åº”ç”¨ç­›é€‰å’Œæ’åº
   */
  private applyFilterAndSort(): void {
    let filtered = [...this.allWrongItems];

    // ç§‘ç›®ç­›é€‰
    if (this.selectedSubject !== 'all') {
      filtered = filtered.filter((item: WrongQuestionItem) => item.question.subjectId === this.selectedSubject);
    }

    // æ’åº
    filtered.sort((a: WrongQuestionItem, b: WrongQuestionItem) => {
      switch (this.selectedSort) {
        case 'time_desc':
          return b.wrong.lastWrongTime - a.wrong.lastWrongTime;
        case 'time_asc':
          return a.wrong.lastWrongTime - b.wrong.lastWrongTime;
        case 'count_desc':
          return b.wrong.wrongCount - a.wrong.wrongCount;
        case 'count_asc':
          return a.wrong.wrongCount - b.wrong.wrongCount;
        default:
          return 0;
      }
    });

    this.showList = false;
    this.wrongItems = filtered;

    setTimeout(() => {
      this.triggerEntryAnimation();
    }, 50);
  }

  /**
   * åˆ‡æ¢ç§‘ç›®ç­›é€‰
   */
  private selectSubject(subjectId: string): void {
    if (this.selectedSubject === subjectId) return;
    this.selectedSubject = subjectId;
    this.applyFilterAndSort();
  }

  /**
   * åˆ‡æ¢æ’åºæ–¹å¼
   */
  private selectSort(sortId: string): void {
    if (this.selectedSort === sortId) return;
    this.selectedSort = sortId;
    this.applyFilterAndSort();
  }

  /**
   * è·å–ç§‘ç›®é”™é¢˜æ•°é‡
   */
  private getSubjectCount(subjectId: string): number {
    if (subjectId === 'all') {
      return this.allWrongItems.length;
    }
    return this.allWrongItems.filter((item: WrongQuestionItem) => item.question.subjectId === subjectId).length;
  }

  /**
   * è·å–å½“å‰æ’åºåç§°
   */
  private getSortName(): string {
    const option = SORT_OPTIONS.find((o: SortOption) => o.id === this.selectedSort);
    return option ? option.name : 'æ’åº';
  }

  /**
   * å¾ªç¯åˆ‡æ¢æ’åºé€‰é¡¹
   */
  private cycleSortOption(): void {
    const currentIndex = SORT_OPTIONS.findIndex((o: SortOption) => o.id === this.selectedSort);
    const nextIndex = (currentIndex + 1) % SORT_OPTIONS.length;
    this.selectSort(SORT_OPTIONS[nextIndex].id);
  }

  /**
   * è¿›å…¥å¤šé€‰æ¨¡å¼
   */
  private enterSelectMode(): void {
    this.isSelectMode = true;
    this.selectedCount = 0;
    this.wrongItems.forEach((item: WrongQuestionItem) => {
      item.isSelected = false;
    });
  }

  /**
   * é€€å‡ºå¤šé€‰æ¨¡å¼
   */
  private exitSelectMode(): void {
    this.isSelectMode = false;
    this.selectedCount = 0;
    this.wrongItems.forEach((item: WrongQuestionItem) => {
      item.isSelected = false;
    });
  }

  /**
   * åˆ‡æ¢é€‰ä¸­çŠ¶æ€
   */
  private toggleSelect(item: WrongQuestionItem): void {
    item.isSelected = !item.isSelected;
    this.updateSelectedCount();
  }

  /**
   * æ›´æ–°é€‰ä¸­æ•°é‡
   */
  private updateSelectedCount(): void {
    this.selectedCount = this.wrongItems.filter((item: WrongQuestionItem) => item.isSelected).length;
  }

  /**
   * å…¨é€‰/å–æ¶ˆå…¨é€‰
   */
  private toggleSelectAll(): void {
    const allSelected = this.selectedCount === this.wrongItems.length;
    this.wrongItems.forEach((item: WrongQuestionItem) => {
      item.isSelected = !allSelected;
    });
    this.updateSelectedCount();
  }

  /**
   * æ‰¹é‡åˆ é™¤ï¼ˆæ ‡è®°ä¸ºå·²æŒæ¡ï¼‰
   */
  private async batchDelete(): Promise<void> {
    const selectedItems = this.wrongItems.filter((item: WrongQuestionItem) => item.isSelected);
    if (selectedItems.length === 0) return;

    // æ‰¹é‡æ ‡è®°ä¸ºå·²æŒæ¡
    for (const item of selectedItems) {
      await answerRecordService.markAsMastered(item.question.id);
    }

    // ä»åˆ—è¡¨ä¸­ç§»é™¤
    this.wrongItems = this.wrongItems.filter((item: WrongQuestionItem) => !item.isSelected);
    this.allWrongItems = this.allWrongItems.filter((item: WrongQuestionItem) =>
      !selectedItems.some((s: WrongQuestionItem) => s.question.id === item.question.id)
    );

    // é€€å‡ºå¤šé€‰æ¨¡å¼
    this.exitSelectMode();

    Logger.info(`[WrongBookPage] Batch deleted ${selectedItems.length} questions`);
  }

  /**
   * å¼€å§‹é”™é¢˜ç»ƒä¹ 
   */
  private startPractice(): void {
    const params: RouteParams = {};
    params['mode'] = 'wrong' as Object;
    Router.goToAnswer(params);
  }

  /**
   * æŸ¥çœ‹å•ä¸ªé”™é¢˜ï¼ˆè¿›å…¥ç­”é¢˜é¡µé¢ï¼‰
   */
  private viewQuestion(item: WrongQuestionItem): void {
    const params: RouteParams = {};
    params['questionId'] = item.question.id as Object;
    params['mode'] = 'single' as Object;
    params['fromWrongBook'] = true as Object; // æ ‡è®°æ¥è‡ªé”™é¢˜æœ¬
    Router.goToAnswer(params);
  }

  /**
   * å¼€å§‹ç»ƒä¹ é”™é¢˜ï¼ˆè®°å½•é¢˜ç›®IDï¼Œè¿”å›æ—¶æ£€æŸ¥ç»“æœï¼‰
   */
  private startPracticeQuestion(item: WrongQuestionItem): void {
    // è®°å½•å½“å‰ç»ƒä¹ çš„é¢˜ç›®ID
    this.currentPracticeQuestionId = item.question.id;

    // è·³è½¬åˆ°ä¸“é—¨çš„é”™é¢˜ç»ƒä¹ é¡µé¢
    const params: RouteParams = {};
    params['questionId'] = item.question.id as Object;
    Router.push('pages/WrongPracticePage', params);
  }

  /**
   * å¼€å§‹æ‹–æ‹½
   */
  private startDragging(item: WrongQuestionItem): void {
    this.isDragging = true;
    this.draggingItemId = item.question.id;
    this.showDeleteZone = true;
    this.deleteZoneScale = 1;
    Logger.info(`[WrongBookPage] Start dragging: ${item.question.id}`);
  }



  /**
   * åˆ é™¤é¡¹ç›®å¹¶æ’­æ”¾åŠ¨ç”»
   */
  private async deleteItemWithAnimation(item: WrongQuestionItem): Promise<void> {
    // æ’­æ”¾åˆ é™¤åŠ¨ç”»
    this.getUIContext()?.animateTo({
      duration: 300,
      curve: Curve.EaseIn
    }, () => {
      item.scaleVal = 0;
      item.opacityVal = 0;
    });

    // ç­‰å¾…åŠ¨ç”»å®Œæˆååˆ é™¤
    setTimeout(async () => {
      // æ ‡è®°ä¸ºå·²æŒæ¡
      await answerRecordService.markAsMastered(item.question.id);

      // ä»åˆ—è¡¨ä¸­ç§»é™¤
      this.wrongItems = this.wrongItems.filter((i: WrongQuestionItem) => i.question.id !== item.question.id);
      this.allWrongItems = this.allWrongItems.filter((i: WrongQuestionItem) => i.question.id !== item.question.id);

      Logger.info(`[WrongBookPage] Deleted item: ${item.question.id}`);
    }, 300);
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        this.NavigationBar()

        if (this.isLoading) {
          // åŠ è½½ä¸­
          Column() {
            LoadingProgress()
              .width(48)
              .height(48)
              .color(ThemeColors.PRIMARY)
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else if (this.allWrongItems.length === 0) {
          // ç©ºçŠ¶æ€ï¼ˆåŸå§‹æ•°æ®ä¸ºç©ºï¼‰
          this.EmptyState()
        } else {
          // ç­›é€‰æ ï¼ˆéå¤šé€‰æ¨¡å¼æ—¶æ˜¾ç¤ºï¼‰
          if (!this.isSelectMode) {
            this.FilterBar()
          }

          if (this.wrongItems.length === 0) {
            // ç­›é€‰åæ— ç»“æœ
            this.FilterEmptyState()
          } else {
            // é”™é¢˜åˆ—è¡¨
            this.WrongList()
          }

          // åº•éƒ¨æ“ä½œæ ï¼ˆæ‹–æ‹½æ—¶éšè—ï¼‰
          if (this.isSelectMode) {
            // å¤šé€‰æ¨¡å¼ï¼šæ‰¹é‡æ“ä½œæ 
            this.BatchActionBar()
          } else if (this.wrongItems.length > 0 && !this.isDragging) {
            // æ™®é€šæ¨¡å¼ï¼šå¼€å§‹ç»ƒä¹ æŒ‰é’®ï¼ˆæ‹–æ‹½æ—¶éšè—ï¼‰
            this.PracticeBar()
          }
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.isDarkMode ? ThemeColors.BACKGROUND_DARK : ThemeColors.BACKGROUND)
      .padding({ top: AppConstants.STATUS_BAR_HEIGHT })

      // æ‹–æ‹½åˆ é™¤åŒºåŸŸï¼ˆåº•éƒ¨ï¼‰
      if (this.showDeleteZone) {
        this.DeleteZone()
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * åˆ é™¤åŒºåŸŸ
   */
  @Builder
  DeleteZone() {
    Column() {
      Image(this.isInDeleteZone ? $r('app.media.Selectanddelete') : $r('app.media.delete'))
        .width(this.isInDeleteZone ? 48 : 36)
        .height(this.isInDeleteZone ? 48 : 36)
        .fillColor(this.isInDeleteZone ? ThemeColors.ERROR : ThemeColors.TEXT_HINT)
        .animation({ duration: 200, curve: Curve.EaseOut })

      Text(this.isInDeleteZone ? 'æ¾æ‰‹åˆ é™¤' : 'æ‹–åˆ°è¿™é‡Œåˆ é™¤')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(this.isInDeleteZone ? ThemeColors.ERROR : ThemeColors.TEXT_HINT)
        .margin({ top: 8 })
    }
    .width('100%')
    .height(DELETE_ZONE_HEIGHT)
    .justifyContent(FlexAlign.Center)
    .backgroundColor(this.isInDeleteZone ? 'rgba(255, 77, 79, 0.15)' : 'rgba(0, 0, 0, 0.05)')
    .border({ width: { top: 1 }, color: this.isInDeleteZone ? ThemeColors.ERROR : ThemeColors.BORDER })
    .position({ x: 0, y: '100%' })
    .translate({ y: -DELETE_ZONE_HEIGHT })
    .scale({ x: this.deleteZoneScale, y: this.deleteZoneScale })
    .animation({ duration: 200, curve: Curve.EaseOut })
  }

  @Builder
  NavigationBar() {
    Row() {
      // å·¦ä¾§æŒ‰é’®
      Row() {
        if (this.isSelectMode) {
          Text('å–æ¶ˆ')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        } else {
          Image($r('app.media.back'))
            .width(24)
            .height(24)
        }
      }
      .width(50)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        if (this.isSelectMode) {
          this.exitSelectMode();
        } else {
          Router.back();
        }
      })

      // æ ‡é¢˜
      Text(this.isSelectMode ? `å·²é€‰ ${this.selectedCount} é¡¹` : `${this.pageTitle} (${this.wrongItems.length})`)
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å³ä¾§æŒ‰é’®
      if (this.wrongItems.length > 0) {
        if (this.isSelectMode) {
          Text(this.selectedCount === this.wrongItems.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.PRIMARY)
            .padding({ left: 8, right: 8 })
            .onClick(() => {
              this.toggleSelectAll();
            })
        } else {
          Text('ç®¡ç†')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.PRIMARY)
            .padding({ left: 12, right: 12 })
            .onClick(() => {
              this.enterSelectMode();
            })
        }
      } else {
        Row().width(50).height(40)
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: ThemeConstants.SPACING_SM, right: ThemeConstants.SPACING_SM })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
  }

  @Builder
  EmptyState() {
    Column() {
      Image($r('app.media.WrongQuestion'))
        .width(64)
        .height(64)
        .objectFit(ImageFit.Contain)

      Text('æš‚æ— é”™é¢˜')
        .fontSize(ThemeConstants.FONT_SIZE_XL)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ top: ThemeConstants.SPACING_MD })

      Text('åšé”™çš„é¢˜ç›®ä¼šè‡ªåŠ¨æ”¶å½•åˆ°è¿™é‡Œ')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: ThemeConstants.SPACING_SM })

      Button('å»åšé¢˜')
        .width(120)
        .height(44)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.PRIMARY)
        .margin({ top: ThemeConstants.SPACING_LG })
        .onClick(() => {
          Router.goToPractice();
        })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  FilterEmptyState() {
    Column() {
      Text('ğŸ”')
        .fontSize(48)

      Text('è¯¥ç§‘ç›®æš‚æ— é”™é¢˜')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: ThemeConstants.SPACING_MD })

      Text('æŸ¥çœ‹å…¨éƒ¨')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.PRIMARY)
        .margin({ top: ThemeConstants.SPACING_SM })
        .onClick(() => {
          this.selectSubject('all');
        })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  FilterBar() {
    Row() {
      // ç§‘ç›®ç­›é€‰ï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰
      Scroll() {
        Row({ space: 8 }) {
          // å…¨éƒ¨
          this.SubjectChip('all', 'å…¨éƒ¨')

          // å„ç§‘ç›®ï¼ˆåªæ˜¾ç¤ºæœ‰é”™é¢˜çš„ï¼‰
          ForEach(SUBJECT_LIST, (subject: SubjectInfo) => {
            if (this.getSubjectCount(subject.id) > 0) {
              this.SubjectChip(subject.id, subject.shortName)
            }
          })
        }
        .padding({ left: 12, right: 8 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .layoutWeight(1)

      // æ’åºæŒ‰é’®
      Row() {
        Text(this.getSortName())
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_SECONDARY)
        Text('â–¼')
          .fontSize(8)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ left: 2 })
      }
      .padding({ left: 10, right: 12, top: 6, bottom: 6 })
      .onClick(() => {
        this.cycleSortOption();
      })
    }
    .width('100%')
    .height(48)
    .backgroundColor(ThemeColors.SURFACE)
  }

  @Builder
  SubjectChip(subjectId: string, name: string) {
    Row() {
      Text(name)
        .fontSize(13)
        .fontColor(this.selectedSubject === subjectId ? ThemeColors.WHITE : ThemeColors.TEXT_SECONDARY)

      if (this.getSubjectCount(subjectId) > 0) {
        Text(`${this.getSubjectCount(subjectId)}`)
          .fontSize(11)
          .fontColor(this.selectedSubject === subjectId ? ThemeColors.WHITE : ThemeColors.TEXT_HINT)
          .margin({ left: 4 })
      }
    }
    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
    .backgroundColor(this.selectedSubject === subjectId ? ThemeColors.PRIMARY : ThemeColors.GRAY_100)
    .borderRadius(16)
    .onClick(() => {
      this.selectSubject(subjectId);
    })
  }

  /**
   * è·å–å…ƒç´ ç´¢å¼•
   */
  private getItemIndex(questionId: string): number {
    return this.wrongItems.findIndex((i: WrongQuestionItem) => i.question.id === questionId);
  }

  @Builder
  WrongList() {
    Scroll() {
      Column() {
        if (this.showList) {
          ForEach(this.wrongItems, (item: WrongQuestionItem, index: number) => {
            WrongItemAnimWrapper({
              item: item,
              index: index,
              isDragging: this.isDragging && this.draggingItemId === item.question.id,
              content: () => {
                this.WrongItem(item)
              }
            })
          }, (item: WrongQuestionItem) => item.question.id)
        }
      }
      .width('100%')
      // çˆ¶å®¹å™¨ä¿æŒé€æ˜åº¦0.99ï¼Œç¡®ä¿å­å…ƒç´ è½¬åœºç”Ÿæ•ˆ
      .transition(TransitionEffect.opacity(0.99))
    }
    .scrollBar(BarState.Off)
    .width('100%')
    .layoutWeight(1)
    .padding(ThemeConstants.SPACING_MD)
    .align(Alignment.Top)
    // Scrollä¹Ÿéœ€è¦ä¿æŒé€æ˜åº¦
    .transition(TransitionEffect.opacity(0.99))
  }

  @Builder
  WrongItem(item: WrongQuestionItem) {
    Row() {
      // å¤šé€‰æ¨¡å¼ä¸‹æ˜¾ç¤ºé€‰æ‹©æ¡†
      if (this.isSelectMode) {
        Checkbox()
          .select(item.isSelected)
          .selectedColor(ThemeColors.PRIMARY)
          .shape(CheckBoxShape.ROUNDED_SQUARE)
          .width(22)
          .height(22)
          .margin({ right: 12 })
          .onChange((value: boolean) => {
            item.isSelected = value;
            this.updateSelectedCount();
          })
      }

      Column() {
        // é¡¶éƒ¨ï¼šç§‘ç›®æ ‡ç­¾ + é”™è¯¯æ¬¡æ•°
        Row() {
          // ç§‘ç›®æ ‡ç­¾
          Text(getSubjectShortName(item.question.subjectId))
            .fontSize(12)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.WHITE)
            .padding({ left: 10, right: 10, top: 4, bottom: 4 })
            .backgroundColor(getSubjectColor(item.question.subjectId))
            .borderRadius(10)

          // é”™è¯¯æ¬¡æ•°
          Row() {
            Text('é”™è¯¯')
              .fontSize(11)
              .fontColor(ThemeColors.ERROR)
            Text(` ${item.wrong.wrongCount} `)
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.ERROR)
            Text('æ¬¡')
              .fontSize(11)
              .fontColor(ThemeColors.ERROR)
          }
          .margin({ left: 10 })

          Blank()

          // ç®­å¤´æŒ‡ç¤ºï¼ˆéå¤šé€‰æ¨¡å¼ï¼‰
          if (!this.isSelectMode) {
            Text('â€º')
              .fontSize(20)
              .fontColor(ThemeColors.TEXT_HINT)
          }
        }
        .width('100%')

        // é¢˜ç›®å†…å®¹
        Text(item.question.content)
          .fontSize(15)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .lineHeight(22)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 10 })

        // åº•éƒ¨ï¼šå¼€å§‹ç»ƒä¹ æŒ‰é’®ï¼ˆéå¤šé€‰æ¨¡å¼ï¼‰
        if (!this.isSelectMode) {
          Row() {
            Text('ğŸ’¡ é•¿æŒ‰æ‹–æ‹½å¯åˆ é™¤')
              .fontSize(11)
              .fontColor(ThemeColors.TEXT_HINT)

            Blank()

            Text('å¼€å§‹ç»ƒä¹ ')
              .fontSize(13)
              .fontColor(ThemeColors.PRIMARY)
              .padding({ left: 16, right: 16, top: 6, bottom: 6 })
              .borderRadius(14)
              .border({ width: 1, color: ThemeColors.PRIMARY })
              .onClick(() => {
                this.startPracticeQuestion(item);
              })
          }
          .width('100%')
          .margin({ top: 12 })
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .padding(14)
    .margin({ bottom: 10 })
    .backgroundColor(item.isSelected
      ? 'rgba(24, 144, 255, 0.08)'
      : (this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE))
    .borderRadius(12)
    .border({
      width: item.isSelected ? 2 : 1,
      color: item.isSelected ? ThemeColors.PRIMARY : ThemeColors.BORDER
    })
    .onClick(() => {
      if (this.isSelectMode) {
        // å¤šé€‰æ¨¡å¼ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
        this.toggleSelect(item);
      } else if (!this.isDragging) {
        // æ™®é€šæ¨¡å¼ï¼šè¿›å…¥ç»ƒä¹ 
        this.startPracticeQuestion(item);
      }
    })
    .gesture(
      GestureGroup(GestureMode.Sequence,
        // å…ˆé•¿æŒ‰è§¦å‘
        LongPressGesture({ repeat: false, duration: 500 })
          .onAction(() => {
            if (!this.isSelectMode) {
              this.startDragging(item);
            }
          }),
        // ç„¶åæ‹–æ‹½
        PanGesture({ fingers: 1, direction: PanDirection.All, distance: 1 })
          .onActionUpdate((event: GestureEvent) => {
            if (this.isDragging && this.draggingItemId === item.question.id) {
              // ç›´æ¥æ›´æ–°ä½ç½®ï¼ˆä¸ç”¨åŠ¨ç”»ï¼Œæ›´è·Ÿæ‰‹ï¼‰
              item.translateX = event.offsetX;
              item.translateY = event.offsetY;

              // æ£€æŸ¥æ˜¯å¦è¿›å…¥åˆ é™¤åŒºåŸŸï¼ˆåŸºäºåç§»é‡åˆ¤æ–­ï¼‰
              const wasInDeleteZone = this.isInDeleteZone;
              // å½“å‘ä¸‹æ‹–æ‹½è¶…è¿‡ä¸€å®šè·ç¦»æ—¶è¿›å…¥åˆ é™¤åŒºåŸŸ
              this.isInDeleteZone = event.offsetY > 150;

              // è¿›å…¥/ç¦»å¼€åˆ é™¤åŒºåŸŸæ—¶çš„åŠ¨ç”»åé¦ˆ
              if (this.isInDeleteZone !== wasInDeleteZone) {
                this.getUIContext()?.animateTo({ curve: curves.springMotion() }, () => {
                  this.deleteZoneScale = this.isInDeleteZone ? 1.1 : 1;
                });
              }
            }
          })
          .onActionEnd(() => {
            if (this.isDragging) {
              if (this.isInDeleteZone) {
                // åœ¨åˆ é™¤åŒºåŸŸæ¾æ‰‹ï¼Œæ‰§è¡Œåˆ é™¤
                this.deleteItemWithAnimation(item);
              } else {
                // ä¸åœ¨åˆ é™¤åŒºåŸŸï¼Œæ¢å¤ä½ç½®
                this.getUIContext()?.animateTo({ curve: curves.springMotion() }, () => {
                  item.translateX = 0;
                  item.translateY = 0;
                });
              }

              // é‡ç½®çŠ¶æ€
              this.isDragging = false;
              this.draggingItemId = '';
              this.isInDeleteZone = false;
              this.showDeleteZone = false;
            }
          })
          .onActionCancel(() => {
            // å–æ¶ˆæ‹–æ‹½
            this.getUIContext()?.animateTo({ curve: curves.springMotion() }, () => {
              item.translateX = 0;
              item.translateY = 0;
            });
            this.isDragging = false;
            this.draggingItemId = '';
            this.isInDeleteZone = false;
            this.showDeleteZone = false;
          })
      )
    )
  }

  @Builder
  BatchActionBar() {
    Row() {
      // åˆ é™¤æŒ‰é’®ï¼ˆæ ‡è®°ä¸ºå·²æŒæ¡ï¼‰
      Column() {
        Image(this.selectedCount > 0 ? $r('app.media.Selectanddelete') : $r('app.media.delete'))
          .width(28)
          .height(28)
          .fillColor(this.selectedCount > 0 ? ThemeColors.ERROR : ThemeColors.TEXT_HINT)
        Text('ç§»é™¤')
          .fontSize(12)
          .fontColor(this.selectedCount > 0 ? ThemeColors.ERROR : ThemeColors.TEXT_HINT)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .opacity(this.selectedCount > 0 ? 1 : 0.5)
      .onClick(() => {
        if (this.selectedCount > 0) {
          this.batchDelete();
        }
      })
    }
    .width('100%')
    .height(70)
    .padding({ bottom: 10 })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
    .border({ width: { top: 1 }, color: ThemeColors.BORDER })
  }

  @Builder
  PracticeBar() {
    Row({ space: 10 }) {
      // ç»Ÿè®¡åˆ†ææŒ‰é’®
      Button('ğŸ“Š ç»Ÿè®¡')
        .height(40)
        .fontSize(13)
        .fontColor(ThemeColors.PRIMARY)
        .backgroundColor(ThemeColors.WHITE)
        .borderRadius(20)
        .border({ width: 1, color: ThemeColors.PRIMARY })
        .padding({ left: 14, right: 14 })
        .onClick(() => {
          Router.push('pages/WrongStatisticsPage');
        })

      // ç¬”è®°æŒ‰é’®
      Button('ğŸ“ ç¬”è®°')
        .height(40)
        .fontSize(13)
        .fontColor(ThemeColors.SECONDARY)
        .backgroundColor(ThemeColors.WHITE)
        .borderRadius(20)
        .border({ width: 1, color: ThemeColors.SECONDARY })
        .padding({ left: 14, right: 14 })
        .onClick(() => {
          Router.push('pages/WrongNotePage');
        })

      // å¼€å§‹ç»ƒä¹ æŒ‰é’®
      Button('å¼€å§‹ç»ƒä¹ ')
        .height(40)
        .fontSize(13)
        .fontColor(ThemeColors.WHITE)
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(20)
        .padding({ left: 20, right: 20 })
        .onClick(() => {
          Router.push('pages/WrongPracticeModePage');
        })
    }
    .width('100%')
    .height(70)
    .padding({ left: 16, right: 16, bottom: AppConstants.BOTTOM_NAV_HEIGHT })
    .justifyContent(FlexAlign.Center)
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
    .border({ width: { top: 1 }, color: ThemeColors.BORDER })
  }
}
