/**
 * é”™é¢˜é‡åšæ¨¡å¼é€‰æ‹©é¡µ
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { answerRecordService } from '../services/AnswerRecordService';
import { AppConstants } from '../common/constants/AppConstants';
import { Logger } from '../common/utils/Logger';

// ç»ƒä¹ æ¨¡å¼å®šä¹‰
interface PracticeMode {
  id: string;
  name: string;
  icon: string;
  description: string;
  color: string;
}

const PRACTICE_MODES: PracticeMode[] = [
  {
    id: 'sequence',
    name: 'é¡ºåºé‡åš',
    icon: 'ğŸ“‹',
    description: 'æŒ‰é”™é¢˜æ·»åŠ æ—¶é—´é¡ºåºç»ƒä¹ ',
    color: '#1890FF'
  },
  {
    id: 'random',
    name: 'éšæœºé‡åš',
    icon: 'ğŸ²',
    description: 'éšæœºæŠ½å–é”™é¢˜è¿›è¡Œç»ƒä¹ ',
    color: '#52C41A'
  },
  {
    id: 'highFreq',
    name: 'é«˜é¢‘é”™é¢˜',
    icon: 'ğŸ”¥',
    description: 'ä¼˜å…ˆç»ƒä¹ é”™è¯¯æ¬¡æ•°æœ€å¤šçš„é¢˜ç›®',
    color: '#FA541C'
  },
  {
    id: 'timed',
    name: 'é™æ—¶æŒ‘æˆ˜',
    icon: 'â±ï¸',
    description: 'é™æ—¶å®Œæˆé”™é¢˜ï¼Œæå‡ç­”é¢˜é€Ÿåº¦',
    color: '#722ED1'
  }
];

@Entry
@Component
struct WrongPracticeModePage {
  @State wrongCount: number = 0;
  @State isLoading: boolean = true;
  @State selectedMode: string = '';
  @State timedMinutes: number = 5; // é™æ—¶æŒ‘æˆ˜çš„åˆ†é’Ÿæ•°
  @State questionCount: number = 10; // ç»ƒä¹ é¢˜ç›®æ•°é‡

  aboutToAppear(): void {
    this.loadWrongCount();
  }

  private async loadWrongCount(): Promise<void> {
    try {
      const wrongIds = await answerRecordService.getWrongQuestionIds();
      this.wrongCount = wrongIds.length;
    } catch (error) {
      Logger.error('[WrongPracticeModePage] Failed to load wrong count', error as Error);
    } finally {
      this.isLoading = false;
    }
  }

  private startPractice(mode: PracticeMode): void {
    if (this.wrongCount === 0) return;

    const params: RouteParams = {};
    params['mode'] = 'wrong' as Object;
    params['wrongMode'] = mode.id as Object;

    // é™æ—¶æ¨¡å¼ä¼ é€’æ—¶é—´å‚æ•°
    if (mode.id === 'timed') {
      params['timeLimit'] = (this.timedMinutes * 60) as Object; // è½¬æ¢ä¸ºç§’
    }

    // ä¼ é€’é¢˜ç›®æ•°é‡
    params['questionCount'] = Math.min(this.questionCount, this.wrongCount) as Object;

    Router.push('pages/AnswerPage', params);
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      this.NavigationBar()

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(48).height(48).color(ThemeColors.PRIMARY)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.wrongCount === 0) {
        // æ— é”™é¢˜
        this.EmptyState()
      } else {
        Scroll() {
          Column() {
            // é”™é¢˜ç»Ÿè®¡å¡ç‰‡
            this.StatsCard()

            // ç»ƒä¹ è®¾ç½®
            this.PracticeSettings()

            // æ¨¡å¼é€‰æ‹©
            this.ModeList()
          }
          .width('100%')
          .padding(ThemeConstants.SPACING_MD)
        }
        .scrollBar(BarState.Off)
        .layoutWeight(1)
        .align(Alignment.Top)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BACKGROUND)
    .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
  }

  @Builder
  NavigationBar() {
    Row() {
      Row() {
        Image($r('app.media.back')).width(24).height(24)
      }
      .width(40).height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { Router.back(); })

      Text('é”™é¢˜é‡åš')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Row().width(40).height(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: ThemeConstants.SPACING_SM, right: ThemeConstants.SPACING_SM })
    .backgroundColor(ThemeColors.SURFACE)
  }

  @Builder
  EmptyState() {
    Column() {
      Text('ğŸ‰')
        .fontSize(64)

      Text('å¤ªæ£’äº†ï¼')
        .fontSize(ThemeConstants.FONT_SIZE_XL)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ top: ThemeConstants.SPACING_MD })

      Text('æš‚æ— é”™é¢˜ï¼Œç»§ç»­ä¿æŒï¼')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: ThemeConstants.SPACING_SM })

      Button('å»åšé¢˜')
        .width(120)
        .height(44)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.PRIMARY)
        .margin({ top: ThemeConstants.SPACING_LG })
        .onClick(() => {
          Router.goToPractice();
        })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  StatsCard() {
    Column() {
      Row() {
        Column() {
          Text(`${this.wrongCount}`)
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.ERROR)
          Text('å¾…æ”»å…‹é”™é¢˜')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ top: 4 })
        }
        .layoutWeight(1)

        Column() {
          Text('ğŸ“š')
            .fontSize(48)
        }
      }
      .width('100%')
      .padding(ThemeConstants.SPACING_MD)
    }
    .width('100%')
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .margin({ bottom: ThemeConstants.SPACING_MD })
  }

  @Builder
  PracticeSettings() {
    Column() {
      Text('ç»ƒä¹ è®¾ç½®')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')

      // é¢˜ç›®æ•°é‡é€‰æ‹©
      Row() {
        Text('ç»ƒä¹ é¢˜æ•°')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        Blank()

        Row() {
          ForEach([5, 10, 20, 0], (count: number) => {
            Text(count === 0 ? 'å…¨éƒ¨' : `${count}é¢˜`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor((count === 0 ? this.wrongCount : count) === this.questionCount
                ? ThemeColors.WHITE : ThemeColors.TEXT_SECONDARY)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor((count === 0 ? this.wrongCount : count) === this.questionCount
                ? ThemeColors.PRIMARY : ThemeColors.GRAY_100)
              .borderRadius(14)
              .margin({ left: 8 })
              .onClick(() => {
                this.questionCount = count === 0 ? this.wrongCount : count;
              })
          })
        }
      }
      .width('100%')
      .margin({ top: ThemeConstants.SPACING_MD })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .margin({ bottom: ThemeConstants.SPACING_MD })
  }

  @Builder
  ModeList() {
    Column() {
      Text('é€‰æ‹©æ¨¡å¼')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')
        .margin({ bottom: ThemeConstants.SPACING_MD })

      ForEach(PRACTICE_MODES, (mode: PracticeMode) => {
        this.ModeCard(mode)
      })
    }
    .width('100%')
  }

  @Builder
  ModeCard(mode: PracticeMode) {
    Row() {
      // å›¾æ ‡
      Column() {
        Text(mode.icon)
          .fontSize(32)
      }
      .width(60)
      .height(60)
      .borderRadius(12)
      .backgroundColor(mode.color + '15')
      .justifyContent(FlexAlign.Center)

      // æ–‡å­—ä¿¡æ¯
      Column() {
        Text(mode.name)
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text(mode.description)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ top: 4 })

        // é™æ—¶æ¨¡å¼æ˜¾ç¤ºæ—¶é—´é€‰æ‹©
        if (mode.id === 'timed') {
          Row() {
            ForEach([3, 5, 10], (minutes: number) => {
              Text(`${minutes}åˆ†é’Ÿ`)
                .fontSize(11)
                .fontColor(this.timedMinutes === minutes ? ThemeColors.WHITE : mode.color)
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .backgroundColor(this.timedMinutes === minutes ? mode.color : mode.color + '20')
                .borderRadius(10)
                .margin({ right: 8 })
                .onClick(() => {
                  this.timedMinutes = minutes;
                })
            })
          }
          .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: ThemeConstants.SPACING_MD })

      // ç®­å¤´
      Text('â€º')
        .fontSize(24)
        .fontColor(ThemeColors.TEXT_HINT)
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .margin({ bottom: ThemeConstants.SPACING_SM })
    .onClick(() => {
      this.startPractice(mode);
    })
  }
}
