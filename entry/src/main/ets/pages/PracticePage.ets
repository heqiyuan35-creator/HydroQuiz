/**
 * ç»ƒä¹ é¡µé¢ - é€‰æ‹©ç»ƒä¹ æ¨¡å¼å’Œç§‘ç›®
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { AppConstants } from '../common/constants/AppConstants';
import { SUBJECT_LIST, getSubjectById } from '../data/SubjectData';
import { SubjectInfo } from '../common/types/QuestionTypes';

@Entry
@Component
struct PracticePage {
  @State selectedSubjectId: string = '';
  @State selectedMode: string = AppConstants.PRACTICE_MODE_SEQUENCE;
  @State isDarkMode: boolean = false;

  aboutToAppear(): void {
    const params: RouteParams = Router.getParams();
    if (params['subjectId']) {
      this.selectedSubjectId = params['subjectId'] as string;
    }
    if (params['mode']) {
      this.selectedMode = params['mode'] as string;
    }
  }

  /**
   * å¼€å§‹ç»ƒä¹ 
   */
  private startPractice(): void {
    const params: RouteParams = {};
    params['subjectId'] = this.selectedSubjectId as Object;
    params['mode'] = this.selectedMode as Object;
    Router.goToAnswer(params);
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.NavigationBar()

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // ç»ƒä¹ æ¨¡å¼é€‰æ‹©
          this.ModeSection()

          // ç§‘ç›®é€‰æ‹©
          this.SubjectSection()
        }
        .padding({ bottom: ThemeConstants.SPACING_2XL })
      }
      .layoutWeight(1)

      // åº•éƒ¨å¼€å§‹æŒ‰é’®
      this.BottomButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.isDarkMode ? ThemeColors.BACKGROUND_DARK : ThemeColors.BACKGROUND)
    .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
  }

  /**
   * å¯¼èˆªæ 
   */
  @Builder
  NavigationBar() {
    Row() {
      // è¿”å›žæŒ‰é’®
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        Router.back();
      })

      // æ ‡é¢˜
      Text('é€‰æ‹©ç»ƒä¹ ')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å ä½
      Row()
        .width(40)
        .height(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: ThemeConstants.SPACING_SM, right: ThemeConstants.SPACING_SM })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
  }

  /**
   * ç»ƒä¹ æ¨¡å¼é€‰æ‹©åŒºåŸŸ
   */
  @Builder
  ModeSection() {
    Column() {
      Text('ç»ƒä¹ æ¨¡å¼')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')

      Column() {
        this.ModeItem(AppConstants.PRACTICE_MODE_SEQUENCE, 'é¡ºåºç»ƒä¹ ', 'æŒ‰é¢˜ç›®é¡ºåºä¾æ¬¡ç»ƒä¹ ', 'ðŸ“')
        this.ModeItem(AppConstants.PRACTICE_MODE_RANDOM, 'éšæœºç»ƒä¹ ', 'éšæœºæŠ½å–é¢˜ç›®ç»ƒä¹ ', 'ðŸŽ²')
        this.ModeItem(AppConstants.PRACTICE_MODE_WRONG, 'é”™é¢˜ç»ƒä¹ ', 'é’ˆå¯¹é”™é¢˜é‡å¤ç»ƒä¹ ', 'âŒ')
        this.ModeItem(AppConstants.PRACTICE_MODE_FAVORITE, 'æ”¶è—ç»ƒä¹ ', 'ç»ƒä¹ æ”¶è—çš„é¢˜ç›®', 'â­')
      }
      .margin({ top: ThemeConstants.SPACING_SM })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
  }

  /**
   * ç»ƒä¹ æ¨¡å¼é¡¹
   */
  @Builder
  ModeItem(mode: string, title: string, desc: string, icon: string) {
    Row() {
      // å›¾æ ‡
      Text(icon)
        .fontSize(24)
        .width(40)

      // ä¿¡æ¯
      Column() {
        Text(title)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text(desc)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ top: ThemeConstants.SPACING_XXS })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: ThemeConstants.SPACING_SM })

      // é€‰ä¸­çŠ¶æ€
      Radio({ value: mode, group: 'practiceMode' })
        .checked(this.selectedMode === mode)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.selectedMode = mode;
          }
        })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_BASE)
    .margin({ top: ThemeConstants.SPACING_SM })
    .backgroundColor(this.selectedMode === mode ?
      (this.isDarkMode ? 'rgba(24, 144, 255, 0.1)' : 'rgba(24, 144, 255, 0.05)') :
      (this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE))
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({
      width: this.selectedMode === mode ? 1 : 0,
      color: ThemeColors.PRIMARY
    })
    .onClick(() => {
      this.selectedMode = mode;
    })
  }

  /**
   * ç§‘ç›®é€‰æ‹©åŒºåŸŸ
   */
  @Builder
  SubjectSection() {
    Column() {
      Row() {
        Text('é€‰æ‹©ç§‘ç›®')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text('ï¼ˆå¯é€‰ï¼Œä¸é€‰åˆ™ç»ƒä¹ å…¨éƒ¨ï¼‰')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ left: ThemeConstants.SPACING_XS })
      }
      .width('100%')

      Column() {
        // å…¨éƒ¨ç§‘ç›®é€‰é¡¹
        this.SubjectItem('', 'å…¨éƒ¨ç§‘ç›®', 'ç»ƒä¹ æ‰€æœ‰ç§‘ç›®çš„é¢˜ç›®', ThemeColors.PRIMARY)

        // å„ç§‘ç›®é€‰é¡¹
        ForEach(SUBJECT_LIST, (subject: SubjectInfo) => {
          this.SubjectItem(subject.id, subject.name, subject.description, subject.color)
        })
      }
      .margin({ top: ThemeConstants.SPACING_SM })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
  }

  /**
   * ç§‘ç›®é¡¹
   */
  @Builder
  SubjectItem(id: string, name: string, desc: string, color: string) {
    Row() {
      // é¢œè‰²æ ‡è¯†
      Column()
        .width(4)
        .height(40)
        .borderRadius(2)
        .backgroundColor(color)

      // ä¿¡æ¯
      Column() {
        Text(name)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text(desc)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ top: ThemeConstants.SPACING_XXS })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: ThemeConstants.SPACING_BASE })

      // é€‰ä¸­çŠ¶æ€
      Radio({ value: id, group: 'subject' })
        .checked(this.selectedSubjectId === id)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.selectedSubjectId = id;
          }
        })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_BASE)
    .margin({ top: ThemeConstants.SPACING_SM })
    .backgroundColor(this.selectedSubjectId === id ?
      (this.isDarkMode ? 'rgba(24, 144, 255, 0.1)' : 'rgba(24, 144, 255, 0.05)') :
      (this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE))
    .borderRadius(ThemeConstants.RADIUS_MD)
    .border({
      width: this.selectedSubjectId === id ? 1 : 0,
      color: ThemeColors.PRIMARY
    })
    .onClick(() => {
      this.selectedSubjectId = id;
    })
  }

  /**
   * åº•éƒ¨æŒ‰é’®
   */
  @Builder
  BottomButton() {
    Column() {
      Button('å¼€å§‹ç»ƒä¹ ')
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontWeight(FontWeight.Medium)
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .onClick(() => {
          this.startPractice();
        })
    }
    .width('100%')
    .padding({ left: ThemeConstants.SPACING_MD, right: ThemeConstants.SPACING_MD, top: ThemeConstants.SPACING_MD, bottom: 32 })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
  }
}
