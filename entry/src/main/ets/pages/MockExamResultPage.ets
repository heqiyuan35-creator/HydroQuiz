/**
 * æ¨¡æ‹Ÿè€ƒè¯•ç»“æžœé¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { AppConstants } from '../common/constants/AppConstants';
import {
  ExamResult,
  ExamConfig,
  TypeScore,
  SubjectScore,
  ExamType,
  mockExamService
} from '../services/MockExamService';
import { answerRecordService } from '../services/AnswerRecordService';
import { getSubjectShortName, getSubjectColor } from '../data/SubjectData';
import { Logger } from '../common/utils/Logger';

@Entry
@Component
struct MockExamResultPage {
  @State examResult: ExamResult | null = null;
  @State examConfig: ExamConfig | null = null;
  @State examRecordId: string = '';

  aboutToAppear(): void {
    const params: RouteParams = Router.getParams();
    this.examResult = params['examResult'] as ExamResult;
    this.examConfig = params['examConfig'] as ExamConfig;
    this.examRecordId = params['examRecordId'] as string || '';

    // ç¡®ä¿æ¸…é™¤è€ƒè¯•è¿›åº¦
    this.clearExamProgress();

    // å°†é”™é¢˜åŠ å…¥é”™é¢˜æœ¬
    if (this.examResult && this.examResult.wrongQuestionIds.length > 0) {
      this.addWrongQuestions();
    }
  }

  private async clearExamProgress(): Promise<void> {
    try {
      await mockExamService.clearProgress();
      Logger.info('[MockExamResultPage] Exam progress cleared');
    } catch (error) {
      Logger.error('[MockExamResultPage] Failed to clear progress', error as Error);
    }
  }

  private async addWrongQuestions(): Promise<void> {
    if (!this.examResult) return;
    for (const questionId of this.examResult.wrongQuestionIds) {
      await answerRecordService.addToWrongBook(questionId);
    }
    Logger.info(`[MockExamResultPage] Added ${this.examResult.wrongQuestionIds.length} wrong questions`);
  }

  private formatDuration(seconds: number): string {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) {
      return `${h}å°æ—¶${m}åˆ†${s}ç§’`;
    }
    if (m > 0) {
      return `${m}åˆ†${s}ç§’`;
    }
    return `${s}ç§’`;
  }

  private getExamTypeName(): string {
    if (!this.examConfig) return 'æ¨¡æ‹Ÿè€ƒè¯•';
    switch (this.examConfig.type) {
      case 'full': return 'å…¨çœŸæ¨¡æ‹Ÿ';
      case 'subject': return 'ä¸“é¡¹æ¨¡æ‹Ÿ';
      case 'quick': return 'å¿«é€Ÿæµ‹éªŒ';
      case 'wrong': return 'é”™é¢˜é‡è€ƒ';
      default: return 'æ¨¡æ‹Ÿè€ƒè¯•';
    }
  }

  private retakeExam(): void {
    if (!this.examConfig) {
      Router.back();
      return;
    }
    const params: RouteParams = {};
    params['examType'] = this.examConfig.type as Object;
    if (this.examConfig.subjectId) {
      params['subjectId'] = this.examConfig.subjectId as Object;
    }
    Router.replace('pages/MockExamPage', params);
  }

  private goHome(): void {
    Router.clearAndPush(AppConstants.ROUTE_MAIN);
  }

  private goToWrongBook(): void {
    Router.push(AppConstants.ROUTE_WRONG_BOOK);
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      this.NavigationBar()

      if (!this.examResult) {
        this.EmptyState()
      } else {
        Scroll() {
          Column() {
            // æˆç»©å¡ç‰‡
            this.ScoreCard()
            // æŸ¥çœ‹ç­”æ¡ˆè§£æžæŒ‰é’®
            Button('æŸ¥çœ‹ç­”æ¡ˆè§£æž')
              .fontSize(16)
              .fontColor(ThemeColors.WHITE)
              .backgroundColor(ThemeColors.SUCCESS)
              .borderRadius(24)
              .height(48)
              .width('100%')
              .margin({ top: 16 })
              .onClick(() => { this.viewAnswers(); })
            // å¾—åˆ†æ˜Žç»†
            this.TypeScoreSection()
            // ç§‘ç›®åˆ†æž
            if (this.examResult.subjectScores.length > 1) {
              this.SubjectScoreSection()
            }
            // é”™é¢˜æç¤º
            if (this.examResult.wrongQuestionIds.length > 0) {
              this.WrongQuestionTip()
            }
            // æ“ä½œæŒ‰é’®
            this.ActionButtons()
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 32 })
        }
        .scrollBar(BarState.Off)
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BACKGROUND)
    .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
  }

  @Builder
  NavigationBar() {
    Row() {
      Row().width(48).height(48)

      Text('è€ƒè¯•ç»“æžœ')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Row() {
        Text('âœ•')
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_HINT)
      }
      .width(48)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.goHome(); })
    }
    .width('100%')
    .height(56)
    .backgroundColor(ThemeColors.SURFACE)
  }

  @Builder
  EmptyState() {
    Column() {
      Text('ðŸ˜•')
        .fontSize(64)
      Text('æœªæ‰¾åˆ°è€ƒè¯•ç»“æžœ')
        .fontSize(16)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  ScoreCard() {
    Column() {
      // è€ƒè¯•ç±»åž‹
      Text(this.getExamTypeName())
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_SECONDARY)

      // åˆ†æ•°
      Row({ space: 4 }) {
        Text(`${this.examResult!.score}`)
          .fontSize(64)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.examResult!.isPassed ? ThemeColors.SUCCESS : ThemeColors.ERROR)
        Text(`/ ${this.examResult!.totalScore}`)
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ bottom: 12 })
      }
      .margin({ top: 8 })

      // åŠæ ¼çŠ¶æ€
      Row({ space: 6 }) {
        Text(this.examResult!.isPassed ? 'âœ…' : 'âŒ')
          .fontSize(18)
        Text(this.examResult!.isPassed ? 'æ­å–œé€šè¿‡ï¼' : 'æœªé€šè¿‡ï¼Œç»§ç»­åŠ æ²¹ï¼')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.examResult!.isPassed ? ThemeColors.SUCCESS : ThemeColors.ERROR)
      }

      // ç»Ÿè®¡ä¿¡æ¯
      Row({ space: 24 }) {
        this.StatItem('ç”¨æ—¶', this.formatDuration(this.examResult!.duration))
        this.StatItem('æ­£ç¡®çŽ‡', `${Math.round(this.examResult!.correctCount / this.examResult!.totalCount * 100)}%`)
        this.StatItem('ç­”å¯¹', `${this.examResult!.correctCount}/${this.examResult!.totalCount}`)
      }
      .margin({ top: 20 })
    }
    .width('100%')
    .padding(24)
    .margin({ top: 16 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(16)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  StatItem(label: string, value: string) {
    Column() {
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
      Text(label)
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ top: 4 })
    }
  }

  @Builder
  TypeScoreSection() {
    Column() {
      Text('ðŸ“Š å¾—åˆ†æ˜Žç»†')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')

      Column({ space: 10 }) {
        ForEach(this.examResult!.typeScores, (item: TypeScore) => {
          Row() {
            Text(item.typeName)
              .fontSize(14)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .width(60)

            // è¿›åº¦æ¡
            Stack() {
              Row()
                .width('100%')
                .height(8)
                .backgroundColor(ThemeColors.GRAY_200)
                .borderRadius(4)

              Row()
                .width(`${item.totalCount > 0 ? (item.correctCount / item.totalCount * 100) : 0}%`)
                .height(8)
                .backgroundColor(ThemeColors.PRIMARY)
                .borderRadius(4)
            }
            .layoutWeight(1)
            .margin({ left: 12, right: 12 })

            Text(`${item.earnedScore}/${item.totalScore}`)
              .fontSize(13)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .width(60)
              .textAlign(TextAlign.End)
          }
          .width('100%')
        }, (item: TypeScore) => item.type)
      }
      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .margin({ top: 16 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(12)
  }

  @Builder
  SubjectScoreSection() {
    Column() {
      Text('ðŸ“ˆ ç§‘ç›®åˆ†æž')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')

      Column({ space: 10 }) {
        ForEach(this.examResult!.subjectScores, (item: SubjectScore) => {
          Row() {
            Text(getSubjectShortName(item.subjectId))
              .fontSize(12)
              .fontColor(ThemeColors.WHITE)
              .padding({ left: 8, right: 8, top: 3, bottom: 3 })
              .backgroundColor(getSubjectColor(item.subjectId))
              .borderRadius(8)
              .width(50)

            // è¿›åº¦æ¡
            Stack() {
              Row()
                .width('100%')
                .height(8)
                .backgroundColor(ThemeColors.GRAY_200)
                .borderRadius(4)

              Row()
                .width(`${item.accuracy}%`)
                .height(8)
                .backgroundColor(this.getAccuracyColor(item.accuracy))
                .borderRadius(4)
            }
            .layoutWeight(1)
            .margin({ left: 12, right: 12 })

            Text(`${item.accuracy}%`)
              .fontSize(13)
              .fontColor(this.getAccuracyColor(item.accuracy))
              .width(45)
              .textAlign(TextAlign.End)
          }
          .width('100%')
        }, (item: SubjectScore) => item.subjectId)
      }
      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .margin({ top: 12 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(12)
  }

  @Builder
  WrongQuestionTip() {
    Row() {
      Text('âŒ')
        .fontSize(20)

      Column() {
        Text(`æœ¬æ¬¡è€ƒè¯•é”™äº† ${this.examResult!.wrongQuestionIds.length} é¢˜`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Text('å·²è‡ªåŠ¨åŠ å…¥é”™é¢˜æœ¬ï¼Œè®°å¾—å¤ä¹ å“¦')
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)

      Text('åŽ»å¤ä¹  >')
        .fontSize(13)
        .fontColor(ThemeColors.PRIMARY)
        .onClick(() => { this.goToWrongBook(); })
    }
    .width('100%')
    .padding(14)
    .margin({ top: 12 })
    .backgroundColor('#FFF1F0')
    .borderRadius(12)
    .border({ width: 1, color: '#FFCCC7' })
  }

  @Builder
  ActionButtons() {
    Row({ space: 16 }) {
      Button('å†è€ƒä¸€æ¬¡')
        .fontSize(16)
        .fontColor(ThemeColors.PRIMARY)
        .backgroundColor(ThemeColors.GRAY_100)
        .borderRadius(24)
        .height(48)
        .layoutWeight(1)
        .onClick(() => { this.retakeExam(); })

      Button('è¿”å›žé¦–é¡µ')
        .fontSize(16)
        .fontColor(ThemeColors.WHITE)
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(24)
        .height(48)
        .layoutWeight(1)
        .onClick(() => { this.goHome(); })
    }
    .width('100%')
    .margin({ top: 24 })
  }

  private viewAnswers(): void {
    const params: RouteParams = {};
    params['examRecordId'] = this.examRecordId as Object;
    params['examResult'] = this.examResult as Object;
    Router.push('pages/ExamAnswerPage', params);
  }

  private getAccuracyColor(accuracy: number): ResourceColor {
    if (accuracy >= 80) return ThemeColors.SUCCESS;
    if (accuracy >= 60) return ThemeColors.WARNING;
    return ThemeColors.ERROR;
  }
}
