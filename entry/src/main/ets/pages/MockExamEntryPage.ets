/**
 * æ¨¡æ‹Ÿè€ƒè¯•å…¥å£é¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { AppConstants } from '../common/constants/AppConstants';
import { mockExamService, ExamType, MockExamRecord } from '../services/MockExamService';
import { SUBJECT_LIST, getSubjectShortName } from '../data/SubjectData';
import { SubjectInfo } from '../common/types/QuestionTypes';
import { Logger } from '../common/utils/Logger';
import { promptAction } from '@kit.ArkUI';
import { webview } from '@kit.ArkWeb';

/**
 * è€ƒè¯•ç±»å‹ç»Ÿè®¡æ¥å£
 */
interface ExamTypeStat {
  type: string;
  name: string;
  count: number;
  percentage: number;
  color: ResourceColor;
}

/**
 * è€ƒè¯•ç±»å‹é…ç½®æ¥å£
 */
interface ExamTypeConfig {
  name: string;
  color: ResourceColor;
}

/**
 * è€ƒè¯•ç±»å‹è®¡æ•°æ¥å£
 */
interface ExamTypeCount {
  count: number;
  passCount: number;
}

/**
 * é¥¼å›¾æ•°æ®æ¥å£ - ç”¨äºä¼ é€’ç»™Web
 */
interface PieChartWebData {
  type: string;
  count: number;
  passCount: number;
}

/**
 * å›¾è¡¨æ•°æ®æ¥å£ - ä¼ é€’ç»™HTML
 */
interface ChartData {
  typeStats: PieChartWebData[];
}

@Entry
@Component
struct MockExamEntryPage {
  @State isLoading: boolean = true;
  @State hasProgress: boolean = false;
  @State showSubjectPicker: boolean = false;
  @State selectedExamType: ExamType = 'full';
  @State examRecords: MockExamRecord[] = [];
  private webController: webview.WebviewController = new webview.WebviewController();
  private isWebReady: boolean = false;

  aboutToAppear(): void {
    // å¼€å¯Webè°ƒè¯•
    try {
      webview.WebviewController.setWebDebuggingAccess(true);
    } catch (error) {
      Logger.error('[MockExamEntryPage] Failed to set web debugging', error as Error);
    }
    this.loadData();
  }

  onPageShow(): void {
    this.loadData();
  }

  private async loadData(): Promise<void> {
    try {
      // åˆå§‹åŒ–è¡¨
      await mockExamService.initTables();
      // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„è€ƒè¯•
      const progress = await mockExamService.loadProgress();
      Logger.info(`[MockExamEntryPage] loadData: progress=${progress !== null}, remainingTime=${progress?.remainingTime}`);
      
      // å¦‚æœè¿›åº¦å­˜åœ¨ä½†å‰©ä½™æ—¶é—´ä¸º0æˆ–æ— æ•ˆï¼Œæ¸…é™¤è¿›åº¦
      if (progress !== null) {
        if (progress.remainingTime <= 0 || progress.questionIds.length === 0) {
          Logger.info('[MockExamEntryPage] Clearing invalid/expired progress');
          await mockExamService.clearProgress();
          this.hasProgress = false;
        } else {
          this.hasProgress = true;
        }
      } else {
        this.hasProgress = false;
      }
      
      Logger.info(`[MockExamEntryPage] hasProgress=${this.hasProgress}`);
      
      // åŠ è½½è€ƒè¯•è®°å½•ç”¨äºåˆ†æ
      this.examRecords = await mockExamService.getExamHistory(50);
    } catch (error) {
      Logger.error('[MockExamEntryPage] Failed to load data', error as Error);
    } finally {
      this.isLoading = false;
    }
  }

  private startExam(type: ExamType, subjectId?: string): void {
    const params: RouteParams = {};
    params['examType'] = type as Object;
    if (subjectId) {
      params['subjectId'] = subjectId as Object;
    }
    Router.push('pages/MockExamPage', params);
  }

  private continueExam(): void {
    const params: RouteParams = {};
    params['continueExam'] = true as Object;
    Router.push('pages/MockExamPage', params);
  }

  private onExamTypeClick(type: ExamType): void {
    if (type === 'subject') {
      this.selectedExamType = type;
      this.showSubjectPicker = true;
    } else {
      this.startExam(type);
    }
  }

  build() {
    Stack() {
      // é¡¶éƒ¨èƒŒæ™¯è‰²å»¶ä¼¸åˆ°çŠ¶æ€æ 
      Column()
        .width('100%')
        .height(AppConstants.STATUS_BAR_HEIGHT + 56)
        .backgroundColor(ThemeColors.SURFACE)

      Column() {
        // å¯¼èˆªæ 
        this.NavigationBar()

        if (this.isLoading) {
          this.LoadingState()
        } else {
          Scroll() {
            Column() {
              // ç»­è€ƒæç¤º
              if (this.hasProgress) {
                this.ContinueExamCard()
              }
              // è€ƒè¯•ç±»å‹é€‰æ‹©
              this.ExamTypeSection()
              // è€ƒè¯•åˆ†æ
              this.ExamAnalysisSection()
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 16, bottom: 24 })
          }
          .scrollBar(BarState.Off)
          .layoutWeight(1)
          .align(Alignment.Top)
        }

        // ç§‘ç›®é€‰æ‹©å¼¹çª—
        if (this.showSubjectPicker) {
          this.SubjectPickerDialog()
        }
      }
      .width('100%')
      .height('100%')
      .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BACKGROUND)
  }

  @Builder
  NavigationBar() {
    Row() {
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
      }
      .width(48)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { Router.back(); })

      Text('æ¨¡æ‹Ÿè€ƒè¯•')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Row() {
        Image($r('app.media.Examresults'))
          .width(20)
          .height(20)
          .objectFit(ImageFit.Contain)
      }
      .width(48)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        Router.push('pages/MockExamHistoryPage');
      })
    }
    .width('100%')
    .height(56)
    .backgroundColor(ThemeColors.SURFACE)
  }

  @Builder
  LoadingState() {
    Column() {
      LoadingProgress().width(48).height(48).color(ThemeColors.PRIMARY)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  ContinueExamCard() {
    Row() {
      Column() {
        Row() {
          Image($r('app.media.Edit'))
            .width(15)
            .height(15)
            .objectFit(ImageFit.Contain)
          Text(' æœ‰æœªå®Œæˆçš„è€ƒè¯•')
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
        Text('ç‚¹å‡»ç»§ç»­ä¸Šæ¬¡çš„è€ƒè¯•')
          .fontSize(13)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Button('ç»§ç»­è€ƒè¯•')
        .fontSize(14)
        .fontColor(ThemeColors.WHITE)
        .backgroundColor(ThemeColors.WARNING)
        .borderRadius(20)
        .height(36)
        .onClick(() => { this.continueExam(); })
    }
    .width('100%')
    .padding(16)
    .margin({ top: 16 })
    .backgroundColor('#FFF7E6')
    .borderRadius(12)
    .border({ width: 1, color: '#FFE4B5' })
  }

  @Builder
  ExamTypeSection() {
    Column() {
      Text('é€‰æ‹©è€ƒè¯•ç±»å‹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')
        .margin({ top: 20, bottom: 12 })

      // 2x2 ç½‘æ ¼
      Grid() {
        // å…¨çœŸæ¨¡æ‹Ÿ
        GridItem() {
          this.ExamTypeCard('full', $r('app.media.Exam'), 'å…¨çœŸæ¨¡æ‹Ÿ', '100é¢˜', '120åˆ†é’Ÿ', ThemeColors.PRIMARY)
        }
        // ä¸“é¡¹æ¨¡æ‹Ÿ
        GridItem() {
          this.ExamTypeCard('subject', $r('app.media.Questionbank'), 'ä¸“é¡¹æ¨¡æ‹Ÿ', '50é¢˜', '60åˆ†é’Ÿ', ThemeColors.SUCCESS)
        }
        // å¿«é€Ÿæµ‹éªŒ
        GridItem() {
          this.ExamTypeCard('quick', $r('app.media.Persevere'), 'å¿«é€Ÿæµ‹éªŒ', '20é¢˜', '20åˆ†é’Ÿ', ThemeColors.WARNING)
        }
        // é”™é¢˜é‡è€ƒ
        GridItem() {
          this.ExamTypeCard('wrong', $r('app.media.WrongQuestion'), 'é”™é¢˜é‡è€ƒ', '30é¢˜', '30åˆ†é’Ÿ', ThemeColors.ERROR)
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
      .width('100%')
      .height(240)
    }
    .width('100%')
  }

  @Builder
  ExamTypeCard(type: ExamType, icon: Resource, title: string, count: string, time: string, color: ResourceColor) {
    Column() {
      Image(icon)
        .width(32)
        .height(32)
        .objectFit(ImageFit.Contain)
        .margin({ bottom: 8 })

      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        Text(count)
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_SECONDARY)
        Text('|')
          .fontSize(12)
          .fontColor(ThemeColors.BORDER)
        Text(time)
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .margin({ top: 6 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(12)
    .border({ width: 2, color: color })
    .onClick(() => { this.onExamTypeClick(type); })
  }

  /**
   * è€ƒè¯•åˆ†ææ¨¡å—
   */
  @Builder
  ExamAnalysisSection() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('ğŸ“Š')
          .fontSize(18)
        Text(' è€ƒè¯•åˆ†æ')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        if (this.examRecords.length > 0) {
          Text('æŸ¥çœ‹è¯¦æƒ… >')
            .fontSize(13)
            .fontColor(ThemeColors.PRIMARY)
            .onClick(() => {
              Router.push('pages/MockExamHistoryPage');
            })
        }
      }
      .width('100%')
      .margin({ top: 24, bottom: 12 })

      if (this.examRecords.length === 0) {
        // æ— æ•°æ®æç¤º
        this.EmptyAnalysisCard()
      } else {
        // æœ‰æ•°æ®æ˜¾ç¤ºåˆ†æ
        this.AnalysisContent()
      }
    }
    .width('100%')
  }

  /**
   * æ— æ•°æ®æç¤ºå¡ç‰‡
   */
  @Builder
  EmptyAnalysisCard() {
    Column() {
      Image($r('app.media.Exam'))
        .width(64)
        .height(64)
        .objectFit(ImageFit.Contain)
        .opacity(0.6)

      Text('æš‚æ— è€ƒè¯•è®°å½•')
        .fontSize(16)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: 16 })

      Text('å®Œæˆä¸€æ¬¡æ¨¡æ‹Ÿè€ƒè¯•åï¼Œè¿™é‡Œå°†å±•ç¤ºä½ çš„è€ƒè¯•åˆ†ææ•°æ®')
        .fontSize(13)
        .fontColor(ThemeColors.TEXT_HINT)
        .textAlign(TextAlign.Center)
        .margin({ top: 8 })

      Button('å¼€å§‹ç¬¬ä¸€æ¬¡è€ƒè¯•')
        .fontSize(14)
        .fontColor(ThemeColors.WHITE)
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(20)
        .height(40)
        .margin({ top: 20 })
        .onClick(() => {
          this.startExam('full');
        })
    }
    .width('100%')
    .padding({ top: 32, bottom: 32, left: 24, right: 24 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(12)
  }

  /**
   * åˆ†æå†…å®¹
   */
  @Builder
  AnalysisContent() {
    Column() {
      // ç»Ÿè®¡æ¦‚è§ˆ
      this.StatsOverview()

      // è€ƒè¯•ç±»å‹ç»Ÿè®¡å›¾è¡¨
      this.ExamTypeChart()
    }
    .width('100%')
  }

  /**
   * ç»Ÿè®¡æ¦‚è§ˆ
   */
  @Builder
  StatsOverview() {
    Row() {
      this.StatItem('è€ƒè¯•æ¬¡æ•°', `${this.examRecords.length}`, ThemeColors.PRIMARY)
      this.StatItem('é€šè¿‡ç‡', `${this.getPassRate()}%`, this.getPassRate() >= 60 ? ThemeColors.SUCCESS : ThemeColors.ERROR)
      this.StatItem('å¹³å‡åˆ†', `${this.getAvgScore()}`, ThemeColors.WARNING)
      this.StatItem('æœ€é«˜åˆ†', `${this.getHighestScore()}`, ThemeColors.SUCCESS)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(12)
    .justifyContent(FlexAlign.SpaceAround)
  }

  @Builder
  StatItem(label: string, value: string, color: ResourceColor) {
    Column() {
      Text(value)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      Text(label)
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ top: 4 })
    }
  }

  /**
   * è€ƒè¯•ç±»å‹ç»Ÿè®¡é¥¼å›¾ - ä½¿ç”¨ArkWeb + ECharts
   */
  @Builder
  ExamTypeChart() {
    Column() {
      Row() {
        Text('ğŸ“Š')
          .fontSize(14)
        Text(' è€ƒè¯•ç±»å‹åˆ†å¸ƒ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        
        Text('ï¼ˆç‚¹å‡»æ‰‡å½¢æŸ¥çœ‹åˆæ ¼ç‡ï¼‰')
          .fontSize(11)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ left: 4 })
      }
      .width('100%')
      .margin({ bottom: 8 })

      // ArkWeb é¥¼å›¾å®¹å™¨
      Web({ src: $rawfile('exam_analysis.html'), controller: this.webController })
        .width('100%')
        .height(280)
        .backgroundColor(Color.Transparent)
        .onPageEnd(() => {
          Logger.info('[MockExamEntryPage] Web page loaded');
          this.isWebReady = true;
          this.initWebChart();
        })
        .onErrorReceive((event) => {
          if (event) {
            Logger.error(`[MockExamEntryPage] Web error: ${event.error.getErrorInfo()}`);
          }
        })
        .javaScriptAccess(true)
        .domStorageAccess(true)
        .fileAccess(true)
    }
    .width('100%')
    .padding(16)
    .margin({ top: 12 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(12)
  }

  /**
   * åˆå§‹åŒ–Webå›¾è¡¨
   */
  private initWebChart(): void {
    if (!this.isWebReady || this.examRecords.length === 0) return;

    try {
      const chartData = this.getWebChartData();
      const dataJson = JSON.stringify(chartData);
      const escapedJson = dataJson
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r');
      this.webController.runJavaScript(`initCharts('${escapedJson}')`);
      Logger.info('[MockExamEntryPage] Chart initialized');
    } catch (error) {
      Logger.error('[MockExamEntryPage] Failed to init chart', error as Error);
    }
  }

  /**
   * è·å–Webå›¾è¡¨æ•°æ®
   */
  private getWebChartData(): ChartData {
    const typeMap: Map<string, ExamTypeCount> = new Map();
    
    this.examRecords.forEach(r => {
      const existing = typeMap.get(r.examType);
      if (existing) {
        existing.count += 1;
        if (r.isPassed) existing.passCount += 1;
      } else {
        const newCount: ExamTypeCount = { count: 1, passCount: r.isPassed ? 1 : 0 };
        typeMap.set(r.examType, newCount);
      }
    });

    const typeStats: PieChartWebData[] = [];
    const types: string[] = ['full', 'subject', 'quick', 'wrong'];

    types.forEach(type => {
      const data = typeMap.get(type);
      const item: PieChartWebData = {
        type: type,
        count: data ? data.count : 0,
        passCount: data ? data.passCount : 0
      };
      typeStats.push(item);
    });

    const result: ChartData = { typeStats: typeStats };
    return result;
  }

  // ç»Ÿè®¡æ–¹æ³•
  private getPassRate(): number {
    if (this.examRecords.length === 0) return 0;
    const passed = this.examRecords.filter(r => r.isPassed).length;
    return Math.round(passed / this.examRecords.length * 100);
  }

  private getAvgScore(): number {
    if (this.examRecords.length === 0) return 0;
    const total = this.examRecords.reduce((sum, r) => sum + r.score, 0);
    return Math.round(total / this.examRecords.length);
  }

  private getHighestScore(): number {
    if (this.examRecords.length === 0) return 0;
    return Math.round(Math.max(...this.examRecords.map(r => r.score)));
  }

  private getExamTypeStats(): ExamTypeStat[] {
    const typeMap: Map<string, number> = new Map();
    this.examRecords.forEach(r => {
      const count = typeMap.get(r.examType) || 0;
      typeMap.set(r.examType, count + 1);
    });

    const total = this.examRecords.length;
    const stats: ExamTypeStat[] = [];

    const fullConfig: ExamTypeConfig = { name: 'å…¨çœŸæ¨¡æ‹Ÿ', color: ThemeColors.PRIMARY };
    const subjectConfig: ExamTypeConfig = { name: 'ä¸“é¡¹æ¨¡æ‹Ÿ', color: ThemeColors.SUCCESS };
    const quickConfig: ExamTypeConfig = { name: 'å¿«é€Ÿæµ‹éªŒ', color: ThemeColors.WARNING };
    const wrongConfig: ExamTypeConfig = { name: 'é”™é¢˜é‡è€ƒ', color: ThemeColors.ERROR };
    const defaultConfig: ExamTypeConfig = { name: 'å…¶ä»–', color: ThemeColors.GRAY_400 };

    typeMap.forEach((count, type) => {
      let config: ExamTypeConfig;
      if (type === 'full') {
        config = fullConfig;
      } else if (type === 'subject') {
        config = subjectConfig;
      } else if (type === 'quick') {
        config = quickConfig;
      } else if (type === 'wrong') {
        config = wrongConfig;
      } else {
        config = defaultConfig;
      }

      const stat: ExamTypeStat = {
        type: type,
        name: config.name,
        count: count,
        percentage: Math.round(count / total * 100),
        color: config.color
      };
      stats.push(stat);
    });

    return stats;
  }

  @Builder
  SubjectPickerDialog() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showSubjectPicker = false; })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    Column() {
      // æ‹–åŠ¨æ¡
      Row() {
        Column().width(40).height(4).backgroundColor(ThemeColors.GRAY_300).borderRadius(2)
      }
      .width('100%')
      .padding({ top: 12, bottom: 8 })
      .justifyContent(FlexAlign.Center)

      Text('é€‰æ‹©ç§‘ç›®')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ bottom: 16 })

      // ç§‘ç›®åˆ—è¡¨
      Scroll() {
        Column() {
          ForEach(SUBJECT_LIST, (subject: SubjectInfo) => {
            Row() {
              Text(subject.shortName)
                .fontSize(12)
                .fontColor(ThemeColors.WHITE)
                .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                .backgroundColor(subject.color)
                .borderRadius(10)

              Text(subject.name)
                .fontSize(15)
                .fontColor(ThemeColors.TEXT_PRIMARY)
                .margin({ left: 12 })
                .layoutWeight(1)

              Text('>')
                .fontSize(16)
                .fontColor(ThemeColors.TEXT_HINT)
            }
            .width('100%')
            .padding(14)
            .margin({ bottom: 8 })
            .backgroundColor(ThemeColors.GRAY_50)
            .borderRadius(10)
            .onClick(() => {
              this.showSubjectPicker = false;
              this.startExam('subject', subject.id);
            })
          }, (subject: SubjectInfo) => subject.id)
        }
        .width('100%')
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)

      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .width('100%')
        .height(48)
        .fontSize(16)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .backgroundColor(ThemeColors.GRAY_100)
        .borderRadius(24)
        .margin({ top: 16 })
        .onClick(() => { this.showSubjectPicker = false; })
    }
    .width('100%')
    .height('60%')
    .padding({ left: 20, right: 20, bottom: 32 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius({ topLeft: 20, topRight: 20 })
    .position({ x: 0, y: '40%' })
  }
}
