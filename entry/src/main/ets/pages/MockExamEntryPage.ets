/**
 * æ¨¡æ‹Ÿè€ƒè¯•å…¥å£é¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { AppConstants } from '../common/constants/AppConstants';
import { mockExamService, ExamType, MockExamRecord } from '../services/MockExamService';
import { SUBJECT_LIST, getSubjectShortName } from '../data/SubjectData';
import { SubjectInfo } from '../common/types/QuestionTypes';
import { Logger } from '../common/utils/Logger';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct MockExamEntryPage {
  @State isLoading: boolean = true;
  @State hasProgress: boolean = false;
  @State historyRecords: MockExamRecord[] = [];
  @State showSubjectPicker: boolean = false;
  @State selectedExamType: ExamType = 'full';

  aboutToAppear(): void {
    this.loadData();
  }

  onPageShow(): void {
    this.loadData();
  }

  private async loadData(): Promise<void> {
    try {
      // åˆå§‹åŒ–è¡¨
      await mockExamService.initTables();
      // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„è€ƒè¯•
      const progress = await mockExamService.loadProgress();
      Logger.info(`[MockExamEntryPage] loadData: progress=${progress !== null}, remainingTime=${progress?.remainingTime}`);
      
      // å¦‚æœè¿›åº¦å­˜åœ¨ä½†å‰©ä½™æ—¶é—´ä¸º0æˆ–æ— æ•ˆï¼Œæ¸…é™¤è¿›åº¦
      if (progress !== null) {
        if (progress.remainingTime <= 0 || progress.questionIds.length === 0) {
          Logger.info('[MockExamEntryPage] Clearing invalid/expired progress');
          await mockExamService.clearProgress();
          this.hasProgress = false;
        } else {
          this.hasProgress = true;
        }
      } else {
        this.hasProgress = false;
      }
      
      Logger.info(`[MockExamEntryPage] hasProgress=${this.hasProgress}`);
      // åŠ è½½å†å²è®°å½•
      this.historyRecords = await mockExamService.getExamHistory(5);
    } catch (error) {
      Logger.error('[MockExamEntryPage] Failed to load data', error as Error);
    } finally {
      this.isLoading = false;
    }
  }

  private startExam(type: ExamType, subjectId?: string): void {
    const params: RouteParams = {};
    params['examType'] = type as Object;
    if (subjectId) {
      params['subjectId'] = subjectId as Object;
    }
    Router.push('pages/MockExamPage', params);
  }

  private continueExam(): void {
    const params: RouteParams = {};
    params['continueExam'] = true as Object;
    Router.push('pages/MockExamPage', params);
  }

  private onExamTypeClick(type: ExamType): void {
    if (type === 'subject') {
      this.selectedExamType = type;
      this.showSubjectPicker = true;
    } else {
      this.startExam(type);
    }
  }

  private formatDuration(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    return `${mins}åˆ†é’Ÿ`;
  }

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}/${day}`;
  }

  build() {
    Stack() {
      // é¡¶éƒ¨èƒŒæ™¯è‰²å»¶ä¼¸åˆ°çŠ¶æ€æ 
      Column()
        .width('100%')
        .height(AppConstants.STATUS_BAR_HEIGHT + 56)
        .backgroundColor(ThemeColors.SURFACE)

      Column() {
        // å¯¼èˆªæ 
        this.NavigationBar()

        if (this.isLoading) {
          this.LoadingState()
        } else {
          Scroll() {
            Column() {
              // ç»­è€ƒæç¤º
              if (this.hasProgress) {
                this.ContinueExamCard()
              }
              // è€ƒè¯•ç±»å‹é€‰æ‹©
              this.ExamTypeSection()
              // å†å²è®°å½•
              if (this.historyRecords.length > 0) {
                this.HistorySection()
              }
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 24 })
          }
          .scrollBar(BarState.Off)
          .layoutWeight(1)
        }

        // ç§‘ç›®é€‰æ‹©å¼¹çª—
        if (this.showSubjectPicker) {
          this.SubjectPickerDialog()
        }
      }
      .width('100%')
      .height('100%')
      .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BACKGROUND)
  }

  @Builder
  NavigationBar() {
    Row() {
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
      }
      .width(48)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { Router.back(); })

      Text('æ¨¡æ‹Ÿè€ƒè¯•')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Row() {
        Text('ğŸ“‹')
          .fontSize(20)
      }
      .width(48)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        Router.push('pages/MockExamHistoryPage');
      })
    }
    .width('100%')
    .height(56)
    .backgroundColor(ThemeColors.SURFACE)
  }

  @Builder
  LoadingState() {
    Column() {
      LoadingProgress().width(48).height(48).color(ThemeColors.PRIMARY)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  ContinueExamCard() {
    Row() {
      Column() {
        Text('ğŸ“ æœ‰æœªå®Œæˆçš„è€ƒè¯•')
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Text('ç‚¹å‡»ç»§ç»­ä¸Šæ¬¡çš„è€ƒè¯•')
          .fontSize(13)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Button('ç»§ç»­è€ƒè¯•')
        .fontSize(14)
        .fontColor(ThemeColors.WHITE)
        .backgroundColor(ThemeColors.WARNING)
        .borderRadius(20)
        .height(36)
        .onClick(() => { this.continueExam(); })
    }
    .width('100%')
    .padding(16)
    .margin({ top: 16 })
    .backgroundColor('#FFF7E6')
    .borderRadius(12)
    .border({ width: 1, color: '#FFE4B5' })
  }

  @Builder
  ExamTypeSection() {
    Column() {
      Text('é€‰æ‹©è€ƒè¯•ç±»å‹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')
        .margin({ top: 20, bottom: 12 })

      // 2x2 ç½‘æ ¼
      Grid() {
        // å…¨çœŸæ¨¡æ‹Ÿ
        GridItem() {
          this.ExamTypeCard('full', 'ğŸ“‹', 'å…¨çœŸæ¨¡æ‹Ÿ', '100é¢˜', '120åˆ†é’Ÿ', ThemeColors.PRIMARY)
        }
        // ä¸“é¡¹æ¨¡æ‹Ÿ
        GridItem() {
          this.ExamTypeCard('subject', 'ğŸ“š', 'ä¸“é¡¹æ¨¡æ‹Ÿ', '50é¢˜', '60åˆ†é’Ÿ', ThemeColors.SUCCESS)
        }
        // å¿«é€Ÿæµ‹éªŒ
        GridItem() {
          this.ExamTypeCard('quick', 'âš¡', 'å¿«é€Ÿæµ‹éªŒ', '20é¢˜', '20åˆ†é’Ÿ', ThemeColors.WARNING)
        }
        // é”™é¢˜é‡è€ƒ
        GridItem() {
          this.ExamTypeCard('wrong', 'ğŸ”„', 'é”™é¢˜é‡è€ƒ', '30é¢˜', '30åˆ†é’Ÿ', ThemeColors.ERROR)
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
      .width('100%')
      .height(240)
    }
    .width('100%')
  }

  @Builder
  ExamTypeCard(type: ExamType, icon: string, title: string, count: string, time: string, color: ResourceColor) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 8 })

      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        Text(count)
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_SECONDARY)
        Text('|')
          .fontSize(12)
          .fontColor(ThemeColors.BORDER)
        Text(time)
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .margin({ top: 6 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(12)
    .border({ width: 2, color: color })
    .onClick(() => { this.onExamTypeClick(type); })
  }

  @Builder
  HistorySection() {
    Column() {
      Row() {
        Text('æœ€è¿‘è€ƒè¯•')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Text('æŸ¥çœ‹å…¨éƒ¨ >')
          .fontSize(13)
          .fontColor(ThemeColors.PRIMARY)
          .onClick(() => {
            Router.push('pages/MockExamHistoryPage');
          })
      }
      .width('100%')
      .margin({ top: 24, bottom: 12 })

      ForEach(this.historyRecords, (record: MockExamRecord) => {
        this.HistoryItem(record)
      }, (record: MockExamRecord) => record.id)
    }
    .width('100%')
  }

  @Builder
  HistoryItem(record: MockExamRecord) {
    Row() {
      Column() {
        Row({ space: 6 }) {
          Text(record.examTypeName)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          if (record.subjectId) {
            Text(getSubjectShortName(record.subjectId))
              .fontSize(11)
              .fontColor(ThemeColors.WHITE)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .backgroundColor(ThemeColors.PRIMARY)
              .borderRadius(8)
          }
        }

        Text(`${this.formatDate(record.createTime)} Â· ç”¨æ—¶${this.formatDuration(record.duration)}`)
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_HINT)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Column() {
        Text(`${record.score}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(record.isPassed ? ThemeColors.SUCCESS : ThemeColors.ERROR)
        Text('åˆ†')
          .fontSize(11)
          .fontColor(ThemeColors.TEXT_HINT)
      }
    }
    .width('100%')
    .padding(14)
    .margin({ bottom: 10 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius(10)
  }

  @Builder
  SubjectPickerDialog() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showSubjectPicker = false; })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    Column() {
      // æ‹–åŠ¨æ¡
      Row() {
        Column().width(40).height(4).backgroundColor(ThemeColors.GRAY_300).borderRadius(2)
      }
      .width('100%')
      .padding({ top: 12, bottom: 8 })
      .justifyContent(FlexAlign.Center)

      Text('é€‰æ‹©ç§‘ç›®')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ bottom: 16 })

      // ç§‘ç›®åˆ—è¡¨
      Scroll() {
        Column() {
          ForEach(SUBJECT_LIST, (subject: SubjectInfo) => {
            Row() {
              Text(subject.shortName)
                .fontSize(12)
                .fontColor(ThemeColors.WHITE)
                .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                .backgroundColor(subject.color)
                .borderRadius(10)

              Text(subject.name)
                .fontSize(15)
                .fontColor(ThemeColors.TEXT_PRIMARY)
                .margin({ left: 12 })
                .layoutWeight(1)

              Text('>')
                .fontSize(16)
                .fontColor(ThemeColors.TEXT_HINT)
            }
            .width('100%')
            .padding(14)
            .margin({ bottom: 8 })
            .backgroundColor(ThemeColors.GRAY_50)
            .borderRadius(10)
            .onClick(() => {
              this.showSubjectPicker = false;
              this.startExam('subject', subject.id);
            })
          }, (subject: SubjectInfo) => subject.id)
        }
        .width('100%')
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)

      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .width('100%')
        .height(48)
        .fontSize(16)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .backgroundColor(ThemeColors.GRAY_100)
        .borderRadius(24)
        .margin({ top: 16 })
        .onClick(() => { this.showSubjectPicker = false; })
    }
    .width('100%')
    .height('60%')
    .padding({ left: 20, right: 20, bottom: 32 })
    .backgroundColor(ThemeColors.SURFACE)
    .borderRadius({ topLeft: 20, topRight: 20 })
    .position({ x: 0, y: '40%' })
  }
}
