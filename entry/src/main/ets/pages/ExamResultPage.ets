/**
 * è€ƒè¯•ç»“æžœé¡µé¢
 * HydroQuiz - æ°´åˆ©å·¥ç¨‹æ£€æµ‹å‘˜åˆ·é¢˜å®
 */
import { Router, RouteParams } from '../router/Router';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { AppConstants } from '../common/constants/AppConstants';

@Entry
@Component
struct ExamResultPage {
  @State isDarkMode: boolean = false;
  @State totalCount: number = 0;
  @State correctCount: number = 0;
  @State score: number = 0;
  @State duration: number = 0;
  @State passScore: number = 60;

  aboutToAppear(): void {
    const params: RouteParams = Router.getParams();
    if (params['totalCount']) {
      this.totalCount = params['totalCount'] as number;
    }
    if (params['correctCount']) {
      this.correctCount = params['correctCount'] as number;
    }
    if (params['score']) {
      this.score = params['score'] as number;
    }
    if (params['duration']) {
      this.duration = params['duration'] as number;
    }
    if (params['passScore']) {
      this.passScore = params['passScore'] as number;
    }
  }

  /**
   * æ ¼å¼åŒ–ç”¨æ—¶
   */
  private formatDuration(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins > 0) {
      return `${mins}åˆ†${secs}ç§’`;
    }
    return `${secs}ç§’`;
  }

  /**
   * æ˜¯å¦åŠæ ¼
   */
  private isPassed(): boolean {
    return this.score >= this.passScore;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Row().width(40).height(40)

        Text('è€ƒè¯•ç»“æžœ')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: ThemeConstants.SPACING_SM, right: ThemeConstants.SPACING_SM })
      .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)

      // ç»“æžœå†…å®¹
      Scroll() {
        Column() {
          // æˆç»©å±•ç¤º
          this.ScoreCard()

          // è¯¦ç»†æ•°æ®
          this.DetailCard()

          // è¯„ä»·
          this.EvaluationCard()

          // æ“ä½œæŒ‰é’®
          this.ActionButtons()
        }
        .padding(ThemeConstants.SPACING_MD)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.isDarkMode ? ThemeColors.BACKGROUND_DARK : ThemeColors.BACKGROUND)
    .padding({ top: AppConstants.STATUS_BAR_HEIGHT })
  }


  @Builder
  ScoreCard() {
    Column() {
      // ç»“æžœå›¾æ ‡
      Text(this.isPassed() ? 'ðŸŽ‰' : 'ðŸ˜”')
        .fontSize(64)

      // åˆ†æ•°
      Row() {
        Text(`${this.score}`)
          .fontSize(72)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isPassed() ? ThemeColors.SUCCESS : ThemeColors.ERROR)

        Text('åˆ†')
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ left: ThemeConstants.SPACING_XS, bottom: 16 })
      }
      .alignItems(VerticalAlign.Bottom)
      .margin({ top: ThemeConstants.SPACING_MD })

      // åŠæ ¼çŠ¶æ€
      Text(this.isPassed() ? 'æ­å–œé€šè¿‡ï¼' : 'æœªé€šè¿‡ï¼Œç»§ç»­åŠ æ²¹ï¼')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.isPassed() ? ThemeColors.SUCCESS : ThemeColors.ERROR)
        .margin({ top: ThemeConstants.SPACING_SM })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_LG)
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  @Builder
  DetailCard() {
    Column() {
      Text('è€ƒè¯•è¯¦æƒ…')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')

      Row() {
        this.DetailItem('ðŸ“', 'æ€»é¢˜æ•°', `${this.totalCount}é¢˜`)
        this.DetailItem('âœ…', 'æ­£ç¡®æ•°', `${this.correctCount}é¢˜`)
        this.DetailItem('âŒ', 'é”™è¯¯æ•°', `${this.totalCount - this.correctCount}é¢˜`)
      }
      .width('100%')
      .margin({ top: ThemeConstants.SPACING_MD })
      .justifyContent(FlexAlign.SpaceAround)

      Divider()
        .margin({ top: ThemeConstants.SPACING_MD, bottom: ThemeConstants.SPACING_MD })
        .color(ThemeColors.BORDER)

      Row() {
        this.DetailItem('â±ï¸', 'ç”¨æ—¶', this.formatDuration(this.duration))
        this.DetailItem('ðŸ“Š', 'æ­£ç¡®çŽ‡', `${this.totalCount > 0 ? Math.round((this.correctCount / this.totalCount) * 100) : 0}%`)
        this.DetailItem('ðŸŽ¯', 'åŠæ ¼çº¿', `${this.passScore}åˆ†`)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .margin({ top: ThemeConstants.SPACING_SM })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  @Builder
  DetailItem(icon: string, label: string, value: string) {
    Column() {
      Text(icon)
        .fontSize(24)

      Text(value)
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ top: ThemeConstants.SPACING_XS })

      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_HINT)
        .margin({ top: ThemeConstants.SPACING_XXS })
    }
  }

  @Builder
  EvaluationCard() {
    Column() {
      Text('å­¦ä¹ å»ºè®®')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .width('100%')

      Text(this.getEvaluation())
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .lineHeight(22)
        .margin({ top: ThemeConstants.SPACING_SM })
    }
    .width('100%')
    .padding(ThemeConstants.SPACING_MD)
    .margin({ top: ThemeConstants.SPACING_SM })
    .backgroundColor(this.isDarkMode ? ThemeColors.SURFACE_DARK : ThemeColors.SURFACE)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .alignItems(HorizontalAlign.Start)
  }

  /**
   * èŽ·å–è¯„ä»·å»ºè®®
   */
  private getEvaluation(): string {
    if (this.score >= 90) {
      return 'å¤ªæ£’äº†ï¼ä½ çš„æŽŒæ¡ç¨‹åº¦éžå¸¸å¥½ï¼Œç»§ç»­ä¿æŒè¿™ç§å­¦ä¹ çŠ¶æ€ï¼Œè€ƒè¯•ä¸€å®šèƒ½å–å¾—å¥½æˆç»©ï¼';
    } else if (this.score >= 80) {
      return 'å¾ˆä¸é”™ï¼åŸºç¡€çŸ¥è¯†æŽŒæ¡å¾—æ¯”è¾ƒæ‰Žå®žï¼Œå»ºè®®é’ˆå¯¹é”™é¢˜è¿›è¡Œå¤ä¹ ï¼ŒæŸ¥æ¼è¡¥ç¼ºã€‚';
    } else if (this.score >= 60) {
      return 'åŠæ ¼äº†ï¼ä½†è¿˜æœ‰æå‡ç©ºé—´ï¼Œå»ºè®®å¤šåšç»ƒä¹ ï¼Œé‡ç‚¹å…³æ³¨é”™é¢˜å’Œè–„å¼±çŸ¥è¯†ç‚¹ã€‚';
    } else if (this.score >= 40) {
      return 'è¿˜éœ€åŠªåŠ›ï¼å»ºè®®ç³»ç»Ÿå¤ä¹ å„ç§‘ç›®çŸ¥è¯†ç‚¹ï¼Œå¤šåšé¢˜å·©å›ºåŸºç¡€ã€‚';
    } else {
      return 'åŸºç¡€è¾ƒè–„å¼±ï¼Œå»ºè®®ä»ŽåŸºç¡€çŸ¥è¯†å¼€å§‹ç³»ç»Ÿå­¦ä¹ ï¼Œå¾ªåºæ¸è¿›ï¼Œä¸è¦æ€¥äºŽæ±‚æˆã€‚';
    }
  }

  @Builder
  ActionButtons() {
    Column() {
      // å†è€ƒä¸€æ¬¡
      Button('å†è€ƒä¸€æ¬¡')
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.WHITE)
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .onClick(() => {
          Router.replace('pages/ExamPage');
        })

      // è¿”å›žé¦–é¡µ
      Button('è¿”å›žé¦–é¡µ')
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.PRIMARY)
        .backgroundColor(ThemeColors.TRANSPARENT)
        .borderWidth(1)
        .borderColor(ThemeColors.PRIMARY)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .margin({ top: ThemeConstants.SPACING_SM })
        .onClick(() => {
          Router.replace('pages/MainTabPage');
        })
    }
    .width('100%')
    .margin({ top: ThemeConstants.SPACING_LG })
  }
}
