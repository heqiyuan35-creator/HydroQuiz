<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>考试分析</title>
  <script src="echarts.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body {
      width: 100%;
      height: 100%;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    .chart-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .chart-box {
      width: 100%;
      height: 220px;
    }
    
    .selected-info {
      width: 100%;
      padding: 12px 16px;
      background: #F5F7FA;
      border-radius: 8px;
      margin-top: 8px;
      display: none;
    }
    
    .selected-info.show { display: block; }
    
    .selected-info .type-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .selected-info .type-detail {
      font-size: 13px;
      color: #666;
    }
    
    .selected-info .pass-rate {
      font-size: 18px;
      font-weight: 700;
      color: #1890FF;
    }
    
    .selected-info .pass-rate.good { color: #52C41A; }
    .selected-info .pass-rate.bad { color: #FF4D4F; }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #f0f0f0;
      border-top-color: #1890FF;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="chart-container" id="chartContainer">
    <div class="loading" id="loadingState">
      <div class="loading-spinner"></div>
    </div>
  </div>

  <script>
    var pieChart = null;
    var currentData = null;
    
    // 考试类型配置
    var TYPE_CONFIG = {
      'full': { name: '全真模拟', color: '#1890FF' },
      'subject': { name: '专项模拟', color: '#52C41A' },
      'quick': { name: '快速测验', color: '#FAAD14' },
      'wrong': { name: '错题重考', color: '#FF4D4F' }
    };
    
    /** 初始化图表 - 由 ArkTS 调用 */
    function initCharts(dataJson) {
      try {
        var data = JSON.parse(dataJson);
        currentData = data;
        document.getElementById('loadingState').style.display = 'none';
        renderChart(data);
      } catch (e) {
        console.error('initCharts error:', e);
      }
    }
    
    /** 渲染饼图 */
    function renderChart(data) {
      var container = document.getElementById('chartContainer');
      
      container.innerHTML = 
        '<div class="chart-box" id="pieChart"></div>' +
        '<div class="selected-info" id="selectedInfo">' +
          '<div class="type-name" id="typeName"></div>' +
          '<div class="type-detail">' +
            '合格率: <span class="pass-rate" id="passRate"></span>' +
            '<span style="margin-left: 16px;">合格 <span id="passCount"></span>/<span id="totalCount"></span> 次</span>' +
          '</div>' +
        '</div>';
      
      setTimeout(function() {
        initPieChart(data);
      }, 50);
    }
    
    /** 初始化饼图 */
    function initPieChart(data) {
      var dom = document.getElementById('pieChart');
      if (!dom) return;
      
      pieChart = echarts.init(dom);
      
      var pieData = data.typeStats.map(function(item) {
        var config = TYPE_CONFIG[item.type] || { name: item.type, color: '#999' };
        return {
          value: item.count,
          name: config.name,
          type: item.type,
          passCount: item.passCount,
          itemStyle: { color: config.color }
        };
      }).filter(function(item) { return item.value > 0; });
      
      // 如果没有数据，显示空状态
      if (pieData.length === 0) {
        pieData = [{ value: 1, name: '暂无数据', itemStyle: { color: '#E8E8E8' } }];
      }
      
      pieChart.setOption({
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.data.type) {
              var passRate = params.data.value > 0 ? Math.round(params.data.passCount / params.data.value * 100) : 0;
              return params.name + '<br/>考试: ' + params.data.value + '次<br/>合格率: ' + passRate + '%';
            }
            return params.name;
          },
          backgroundColor: 'rgba(255,255,255,0.95)',
          borderColor: '#eee',
          borderWidth: 1,
          textStyle: { color: '#333', fontSize: 13 },
          padding: [8, 12]
        },
        series: [{
          type: 'pie',
          radius: ['50%', '75%'],
          center: ['50%', '50%'],
          avoidLabelOverlap: true,
          itemStyle: {
            borderRadius: 6,
            borderColor: '#fff',
            borderWidth: 2
          },
          label: {
            show: true,
            position: 'outside',
            formatter: '{b}\n{c}次',
            fontSize: 11,
            color: '#666',
            lineHeight: 16
          },
          labelLine: {
            show: true,
            length: 8,
            length2: 12,
            smooth: true
          },
          emphasis: {
            label: { show: true, fontSize: 12, fontWeight: 'bold' },
            itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0, 0, 0, 0.2)' }
          },
          data: pieData
        }]
      });
      
      // 点击事件
      pieChart.on('click', function(params) {
        if (params.data.type) {
          showSelectedInfo(params.data);
        }
      });
    }
    
    /** 显示选中信息 */
    function showSelectedInfo(item) {
      var infoBox = document.getElementById('selectedInfo');
      var typeName = document.getElementById('typeName');
      var passRate = document.getElementById('passRate');
      var passCount = document.getElementById('passCount');
      var totalCount = document.getElementById('totalCount');
      
      var config = TYPE_CONFIG[item.type] || { name: item.type };
      var rate = item.value > 0 ? Math.round(item.passCount / item.value * 100) : 0;
      
      typeName.textContent = config.name;
      passRate.textContent = rate + '%';
      passRate.className = 'pass-rate ' + (rate >= 60 ? 'good' : 'bad');
      passCount.textContent = item.passCount;
      totalCount.textContent = item.value;
      
      infoBox.className = 'selected-info show';
    }
    
    /** 更新图表 - 由 ArkTS 调用 */
    function updateCharts(dataJson) {
      try {
        var data = JSON.parse(dataJson);
        currentData = data;
        renderChart(data);
      } catch (e) {
        console.error('updateCharts error:', e);
      }
    }
    
    window.addEventListener('resize', function() {
      if (pieChart) pieChart.resize();
    });
  </script>
</body>
</html>
